name: Build Xbox UWP (Store Upload)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Ensure UWP build tooling is installed (WindowsXaml/Appx targets)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          function Find-FirstFile([string[]]$roots, [string]$fileName) {
            foreach ($r in $roots) {
              if (-not $r) { continue }
              if (Test-Path $r) {
                $hit = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter $fileName | Select-Object -First 1
                if ($hit) { return $hit }
              }
            }
            return $null
          }

          function Test-UwpTooling([string]$vsInstallPath = $null) {
            $roots = @("${env:ProgramFiles(x86)}\MSBuild")
            if ($vsInstallPath) {
              $roots += (Join-Path $vsInstallPath 'MSBuild')
            }

            $xaml = Find-FirstFile -roots $roots -fileName 'Microsoft.Windows.UI.Xaml.CSharp.targets'
            $appx = Find-FirstFile -roots $roots -fileName 'Microsoft.AppXPackage.Targets'

            return [pscustomobject]@{
              Roots = ($roots -join '; ')
              Xaml  = $xaml
              Appx  = $appx
            }
          }

          $found = Test-UwpTooling
          if ($found.Xaml -and $found.Appx) {
            Write-Host "OK: UWP tooling already present."
            Write-Host "  WindowsXaml: $($found.Xaml.FullName)"
            Write-Host "  AppxPackage: $($found.Appx.FullName)"
            exit 0
          }

          Write-Host "UWP tooling missing. Installing Visual Studio UWP workload..."

          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere.exe not found: $vswhere" }

          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $installPath) { throw "No Visual Studio installation found on runner" }
          Write-Host "VS installPath: $installPath"

          $found = Test-UwpTooling -vsInstallPath $installPath
          Write-Host "Search roots: $($found.Roots)"
          if ($found.Xaml -and $found.Appx) {
            Write-Host "OK: UWP tooling already present."
            Write-Host "  WindowsXaml: $($found.Xaml.FullName)"
            Write-Host "  AppxPackage: $($found.Appx.FullName)"
            exit 0
          }

          $installer = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vs_installer.exe'
          if (!(Test-Path $installer)) { throw "vs_installer.exe not found: $installer" }

          # Add UWP workload + a compatible Windows SDK. includeOptional helps pull XAML/Appx targets.
          & $installer modify --installPath "$installPath" --add Microsoft.VisualStudio.Workload.Universal --includeRecommended --includeOptional --passive --norestart --wait

          $found2 = Test-UwpTooling -vsInstallPath $installPath
          if (-not ($found2.Xaml -and $found2.Appx)) {
            Write-Error "Still missing UWP tooling after install. WindowsXaml/Appx targets not found."
          }
          Write-Host "OK: Installed UWP tooling."
          Write-Host "  WindowsXaml: $($found2.Xaml.FullName)"
          Write-Host "  AppxPackage: $($found2.Appx.FullName)"

      - name: Verify UWP build tooling exists (WindowsXaml/Appx targets)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere.exe not found: $vswhere" }
          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          Write-Host "VS installPath: $installPath"

          $roots = @("${env:ProgramFiles(x86)}\MSBuild")
          if ($installPath) {
            $roots += (Join-Path $installPath 'MSBuild')
          }
          Write-Host "Search roots: $($roots -join '; ')"

          $xamlTargets = $null
          foreach($r in $roots){
            if($r -and (Test-Path $r)){
              $xamlTargets = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.Windows.UI.Xaml.CSharp.targets' | Select-Object -First 1
              if($xamlTargets){ break }
            }
          }
          if (-not $xamlTargets) {
            Write-Error "Missing UWP/XAML targets on this runner (Microsoft.Windows.UI.Xaml.CSharp.targets)."
          }

          $appxTargets = $null
          foreach($r in $roots){
            if($r -and (Test-Path $r)){
              $appxTargets = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.AppXPackage.Targets' | Select-Object -First 1
              if($appxTargets){ break }
            }
          }
          if (-not $appxTargets) {
            Write-Error "Missing AppxPackage targets on this runner (Microsoft.AppXPackage.Targets)."
          }

          Write-Host "OK: Found WindowsXaml targets at: $($xamlTargets.FullName)"
          Write-Host "OK: Found AppxPackage targets at: $($appxTargets.FullName)"

      - name: Generate temporary signing certificate (matches Publisher)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Read Publisher from manifest. Example: CN=712788B8-43CE-4166-8202-F444B4BF7C49
          [xml]$manifest = Get-Content "xbox-uwp-wrapper/FC26ManagerXbox/Package.appxmanifest"
          $publisher = $manifest.Package.Identity.Publisher
          if (-not $publisher) { throw "Publisher not found in Package.appxmanifest" }

          $passwordPlain = "${{ secrets.PFX_PASSWORD }}"
          if (-not $passwordPlain) { throw "Missing secret PFX_PASSWORD" }

          $certPassword = ConvertTo-SecureString -String $passwordPlain -AsPlainText -Force

          $subject = $publisher
          Write-Host "Using cert subject: $subject"

          $cert = New-SelfSignedCertificate -Type Custom -Subject $subject -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 -CertStoreLocation "Cert:\CurrentUser\My" -KeyExportPolicy Exportable
          if (-not $cert) { throw "Failed to create certificate" }

          $pfxPath = Join-Path $PWD "temp-signing.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $certPassword | Out-Null

          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Sanity check project config exists (Release|x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $csproj = "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj"
          if (-not (Test-Path $csproj)) { throw "Missing csproj at $csproj" }

          # NOTE: Do NOT search for "$(Configuration)" literally here: PowerShell treats "$ ( ... )" as a subexpression in double-quotes.
          # Searching for the effective config token is enough to prove the pushed csproj contains the needed config.
          $hits = Select-String -Path $csproj -SimpleMatch "Release|x64" -ErrorAction SilentlyContinue
          if (-not $hits) {
            Write-Host "--- csproj head ---"
            Get-Content $csproj -TotalCount 80
            throw "Repo does not contain Release|x64 config in csproj (did you push the latest csproj change?)"
          }
          Write-Host "OK: Release|x64 config found in csproj."

      - name: Build Store upload package (x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $msbuild = "msbuild"
          $pfxPath = "${env:PFX_PATH}"
          if (-not (Test-Path $pfxPath)) { throw "PFX not found at $pfxPath" }

          $pfxPassword = "${{ secrets.PFX_PASSWORD }}"

          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox.sln" `
            /t:Build `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:VisualStudioVersion=17.0 `
            /p:OutputPath=bin\\x64\\Release\\ `
            /p:IntermediateOutputPath=obj\\x64\\Release\\ `
            /p:GenerateAppxPackageOnBuild=true `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms=x64 `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="$pfxPath" `
            /p:PackageCertificatePassword="$pfxPassword" `
            /m

      - name: Collect artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $out = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $uploads = Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Include *.appxupload,*.msixupload
          if (-not $uploads) {
            Write-Error "No .appxupload/.msixupload produced. Check build logs."
          }

          $uploads | ForEach-Object {
            Copy-Item $_.FullName -Destination $out -Force
            Write-Host "Collected: $($_.FullName)"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: store-upload-package
          path: artifacts
