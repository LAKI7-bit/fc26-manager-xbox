name: Build Xbox UWP (Store Upload)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Ensure UWP build tooling is installed (WindowsXaml/Appx targets)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          function Find-FirstFile([string[]]$roots, [string]$fileName) {
            foreach ($r in $roots) {
              if (-not $r) { continue }
              if (Test-Path $r) {
                $hit = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter $fileName | Select-Object -First 1
                if ($hit) { return $hit }
              }
            }
            return $null
          }

          function Test-UwpTooling([string]$vsInstallPath = $null) {
            $roots = @("${env:ProgramFiles(x86)}\MSBuild")
            if ($vsInstallPath) {
              $roots += (Join-Path $vsInstallPath 'MSBuild')
            }

            $xaml = Find-FirstFile -roots $roots -fileName 'Microsoft.Windows.UI.Xaml.CSharp.targets'
            $appx = Find-FirstFile -roots $roots -fileName 'Microsoft.AppXPackage.Targets'

            return [pscustomobject]@{
              Roots = ($roots -join '; ')
              Xaml  = $xaml
              Appx  = $appx
            }
          }

          $found = Test-UwpTooling
          if ($found.Xaml -and $found.Appx) {
            Write-Host "OK: UWP tooling already present."
            Write-Host "  WindowsXaml: $($found.Xaml.FullName)"
            Write-Host "  AppxPackage: $($found.Appx.FullName)"
            exit 0
          }

          Write-Host "UWP tooling missing. Installing Visual Studio UWP workload..."

          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere.exe not found: $vswhere" }

          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $installPath) { throw "No Visual Studio installation found on runner" }
          Write-Host "VS installPath: $installPath"

          $found = Test-UwpTooling -vsInstallPath $installPath
          Write-Host "Search roots: $($found.Roots)"
          if ($found.Xaml -and $found.Appx) {
            Write-Host "OK: UWP tooling already present."
            Write-Host "  WindowsXaml: $($found.Xaml.FullName)"
            Write-Host "  AppxPackage: $($found.Appx.FullName)"
            exit 0
          }

          $installer = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vs_installer.exe'
          if (!(Test-Path $installer)) { throw "vs_installer.exe not found: $installer" }

          # Add UWP workload + a compatible Windows SDK. includeOptional helps pull XAML/Appx targets.
          & $installer modify --installPath "$installPath" --add Microsoft.VisualStudio.Workload.Universal --includeRecommended --includeOptional --passive --norestart --wait

          $found2 = Test-UwpTooling -vsInstallPath $installPath
          if (-not ($found2.Xaml -and $found2.Appx)) {
            Write-Error "Still missing UWP tooling after install. WindowsXaml/Appx targets not found."
          }
          Write-Host "OK: Installed UWP tooling."
          Write-Host "  WindowsXaml: $($found2.Xaml.FullName)"
          Write-Host "  AppxPackage: $($found2.Appx.FullName)"

      - name: Verify UWP build tooling exists (WindowsXaml/Appx targets)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere.exe not found: $vswhere" }
          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          Write-Host "VS installPath: $installPath"

          $roots = @("${env:ProgramFiles(x86)}\MSBuild")
          if ($installPath) {
            $roots += (Join-Path $installPath 'MSBuild')
          }
          Write-Host "Search roots: $($roots -join '; ')"

          $xamlTargets = $null
          foreach($r in $roots){
            if($r -and (Test-Path $r)){
              $xamlTargets = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.Windows.UI.Xaml.CSharp.targets' | Select-Object -First 1
              if($xamlTargets){ break }
            }
          }
          if (-not $xamlTargets) {
            Write-Error "Missing UWP/XAML targets on this runner (Microsoft.Windows.UI.Xaml.CSharp.targets)."
          }

          $appxTargets = $null
          foreach($r in $roots){
            if($r -and (Test-Path $r)){
              $appxTargets = Get-ChildItem -Path $r -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.AppXPackage.Targets' | Select-Object -First 1
              if($appxTargets){ break }
            }
          }
          if (-not $appxTargets) {
            Write-Error "Missing AppxPackage targets on this runner (Microsoft.AppXPackage.Targets)."
          }

          Write-Host "OK: Found WindowsXaml targets at: $($xamlTargets.FullName)"
          Write-Host "OK: Found AppxPackage targets at: $($appxTargets.FullName)"

      - name: Generate temporary signing certificate (matches Publisher)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Read Publisher from manifest. Example: CN=712788B8-43CE-4166-8202-F444B4BF7C49
          [xml]$manifest = Get-Content "xbox-uwp-wrapper/FC26ManagerXbox/Package.appxmanifest"
          $publisher = $manifest.Package.Identity.Publisher
          if (-not $publisher) { throw "Publisher not found in Package.appxmanifest" }

          $passwordPlain = "${{ secrets.PFX_PASSWORD }}"
          if (-not $passwordPlain) { throw "Missing secret PFX_PASSWORD" }

          $certPassword = ConvertTo-SecureString -String $passwordPlain -AsPlainText -Force

          $subject = $publisher
          Write-Host "Using cert subject: $subject"

          $cert = New-SelfSignedCertificate -Type Custom -Subject $subject -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 -CertStoreLocation "Cert:\CurrentUser\My" -KeyExportPolicy Exportable
          if (-not $cert) { throw "Failed to create certificate" }

          $pfxPath = Join-Path $PWD "temp-signing.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $certPassword | Out-Null

          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Sanity check project config exists (Release|x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $csproj = "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj"
          if (-not (Test-Path $csproj)) { throw "Missing csproj at $csproj" }

          # Search for the exact PropertyGroup condition. Use single-quotes so PowerShell does NOT treat $() as a subexpression.
          $pattern = 'Condition="''$(Configuration)|$(Platform)''==''Release|x64''"'
          $hits = Select-String -Path $csproj -SimpleMatch $pattern -ErrorAction SilentlyContinue
          if (-not $hits) {
            Write-Host "--- csproj head ---"
            Get-Content $csproj -TotalCount 80
            throw "Repo does not contain Release|x64 config in csproj (did you push the latest csproj change?)"
          }
          Write-Host "OK: Release|x64 config found in csproj."

      - name: Build Store upload package (x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $msbuild = "msbuild"
          $pfxPath = "${env:PFX_PATH}"
          if (-not (Test-Path $pfxPath)) { throw "PFX not found at $pfxPath" }

          $pfxPassword = "${{ secrets.PFX_PASSWORD }}"

          # Restore NuGet/packages then Publish to generate StoreUpload package (.appxupload/.msixupload)
          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj" /t:Restore /p:Configuration=Release /p:Platform=x64

          # Diagnostic: dump project.assets.json so we can see which dependency requires .NET Framework
          $assets = Join-Path "$PWD" "xbox-uwp-wrapper/FC26ManagerXbox/obj/project.assets.json"
          if (Test-Path $assets) {
            Write-Host "---- project.assets.json (tail 200 lines) ----"
            Get-Content $assets -Tail 200 | ForEach-Object { Write-Host $_ }
            Write-Host "---- end project.assets.json ----"
          } else {
            Write-Host "project.assets.json not found at: $assets"
          }
          # Try publishing the project first (project-level Publish may produce packages)
          $projPubLog = Join-Path $PWD "msbuild_project_publish.log"
          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj" `
            /t:Publish `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms=x64 `
            /p:AppxPackageSigningEnabled=true `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:RuntimeIdentifiers=win10 `
            /p:PackageCertificateKeyFile="$pfxPath" `
            /p:PackageCertificatePassword="$pfxPassword" `
            /p:GenerateAppxPackageOnBuild=true `
            /m | Tee-Object $projPubLog

          Write-Host "---- msbuild_project_publish.log (tail) ----"
          Get-Content $projPubLog -Tail 200 | ForEach-Object { Write-Host $_ }

          $projExit = $LASTEXITCODE
          Write-Host "project Publish exit code: $projExit"

          # If project publish succeeded and produced packages, skip solution publish
          if ($projExit -eq 0) {
            Write-Host "Project Publish succeeded; searching for package files before trying solution Publish."
            $foundProj = Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Include *.appxupload,*.msixupload,*.appx,*.msix,*.appxbundle
            if ($foundProj) {
              $foundProj | ForEach-Object { Write-Host "Found package from project publish: $($_.FullName)" }
            } else {
              Write-Host "No package files found after project Publish; continuing to solution Publish/fallback."
            }
          }

          # Try publishing the solution first (different restore/publish flow on runner)
          $pubLog = Join-Path $PWD "msbuild_publish.log"
          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox.sln" `
            /t:Publish `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms=x64 `
            /p:AppxPackageSigningEnabled=true `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:RuntimeIdentifiers=win10 `
            /p:PackageCertificateKeyFile="$pfxPath" `
            /p:PackageCertificatePassword="$pfxPassword" `
            /p:GenerateAppxPackageOnBuild=true `
            /m | Tee-Object $pubLog

          $msExit = $LASTEXITCODE
          Write-Host "msbuild exit code: $msExit"
          Write-Host "---- msbuild_publish.log (tail) ----"
          Get-Content $pubLog -Tail 200 | ForEach-Object { Write-Host $_ }

          Write-Host "---- Searching for package files under project folders ----"
          $candidates = Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Include *.appxupload,*.msixupload,*.appx,*.msix
          if ($candidates) {
            $candidates | ForEach-Object { Write-Host "Found package: $($_.FullName)" }
          } else {
            Write-Host "No package files found under xbox-uwp-wrapper. Listing common output folders:"
            Get-ChildItem -Path "xbox-uwp-wrapper/FC26ManagerXbox/bin" -Recurse -Force -ErrorAction SilentlyContinue | Select-Object -First 200 | ForEach-Object { Write-Host $_.FullName }
          }

          if ($msExit -ne 0) { throw "msbuild publish failed with exit code $msExit; see msbuild_publish.log" }

          # If Publish didn't produce packages, run CreateAppPackage on the project (more explicit packaging target)
          Write-Host "Attempting CreateAppPackage on project as a fallback..."
          $capLog = Join-Path $PWD "msbuild_createapppkg.log"
          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj" `
            /t:CreateAppPackage `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms=x64 `
            /p:AppxPackageSigningEnabled=true `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:RuntimeIdentifiers=win10 `
            /p:PackageCertificateKeyFile="$pfxPath" `
            /p:PackageCertificatePassword="$pfxPassword" `
            /p:GenerateAppxPackageOnBuild=true `
            /m | Tee-Object $capLog

          $capExit = $LASTEXITCODE
          Write-Host "CreateAppPackage exit code: $capExit"
          Get-Content $capLog -Tail 200 | ForEach-Object { Write-Host $_ }
          if ($capExit -ne 0) { Write-Error "CreateAppPackage failed (exit $capExit). Check logs above." }
      - name: Collect artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $out = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          # Look for a broad set of possible package outputs and AppPackages folders
          $patterns = @('*.appxupload','*.msixupload','*.appxbundleupload','*.appxbundle','*.appx','*.msix')
          $found = @()
          foreach ($p in $patterns) {
            $found += Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Include $p
          }

          # Also collect any AppPackages directories (Visual Studio output)
          $appPkgDirs = Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Directory | Where-Object { $_.Name -ieq 'AppPackages' }
          foreach ($d in $appPkgDirs) {
            $found += Get-ChildItem -Path $d.FullName -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Extension -in '.appxupload','.msixupload','.appxbundle','.appx','.msix' }
            # copy entire folder for inspection
            $dest = Join-Path $out $d.FullName.Replace((Join-Path $PWD 'xbox-uwp-wrapper') + '\','')
            New-Item -ItemType Directory -Force -Path $dest | Out-Null
            Copy-Item -Path (Join-Path $d.FullName '*') -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "Collected AppPackages folder: $($d.FullName) -> $dest"
          }

          if ($found) {
            $found | Sort-Object FullName -Unique | ForEach-Object {
              $target = Join-Path $out $_.Name
              Copy-Item $_.FullName -Destination $target -Force
              Write-Host "Collected package: $($_.FullName) -> $target"
            }
          } else {
            Write-Error "No package files found (searched for: $($patterns -join ', ')). Check msbuild_publish.log in the job log for details."
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: store-upload-package
          path: artifacts
