name: Build Xbox UWP (Store Upload)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Verify UWP build tooling exists (WindowsXaml/Appx targets)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $xamlTargets = Get-ChildItem -Path "${env:ProgramFiles(x86)}\MSBuild" -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.Windows.UI.Xaml.CSharp.targets' | Select-Object -First 1
          if (-not $xamlTargets) {
            Write-Error "Missing UWP/XAML targets on this runner (Microsoft.Windows.UI.Xaml.CSharp.targets)."
          }

          $appxTargets = Get-ChildItem -Path "${env:ProgramFiles(x86)}\MSBuild" -Recurse -ErrorAction SilentlyContinue -Filter 'Microsoft.AppXPackage.Targets' | Select-Object -First 1
          if (-not $appxTargets) {
            Write-Error "Missing AppxPackage targets on this runner (Microsoft.AppXPackage.Targets)."
          }

          Write-Host "OK: Found WindowsXaml targets at: $($xamlTargets.FullName)"
          Write-Host "OK: Found AppxPackage targets at: $($appxTargets.FullName)"

      - name: Generate temporary signing certificate (matches Publisher)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Read Publisher from manifest. Example: CN=712788B8-43CE-4166-8202-F444B4BF7C49
          [xml]$manifest = Get-Content "xbox-uwp-wrapper/FC26ManagerXbox/Package.appxmanifest"
          $publisher = $manifest.Package.Identity.Publisher
          if (-not $publisher) { throw "Publisher not found in Package.appxmanifest" }

          $passwordPlain = "${{ secrets.PFX_PASSWORD }}"
          if (-not $passwordPlain) { throw "Missing secret PFX_PASSWORD" }

          $certPassword = ConvertTo-SecureString -String $passwordPlain -AsPlainText -Force

          $subject = $publisher
          Write-Host "Using cert subject: $subject"

          $cert = New-SelfSignedCertificate -Type Custom -Subject $subject -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 -CertStoreLocation "Cert:\CurrentUser\My" -KeyExportPolicy Exportable
          if (-not $cert) { throw "Failed to create certificate" }

          $pfxPath = Join-Path $PWD "temp-signing.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $certPassword | Out-Null

          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build Store upload package (x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $msbuild = "msbuild"
          $pfxPath = "${env:PFX_PATH}"
          if (-not (Test-Path $pfxPath)) { throw "PFX not found at $pfxPath" }

          $pfxPassword = "${{ secrets.PFX_PASSWORD }}"

          & $msbuild "xbox-uwp-wrapper/FC26ManagerXbox/FC26ManagerXbox.csproj" `
            /t:Build `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:VisualStudioVersion=17.0 `
            /p:GenerateAppxPackageOnBuild=true `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms=x64 `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="$pfxPath" `
            /p:PackageCertificatePassword="$pfxPassword" `
            /m

      - name: Collect artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $out = Join-Path $PWD "artifacts"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $uploads = Get-ChildItem -Path "xbox-uwp-wrapper" -Recurse -ErrorAction SilentlyContinue -Include *.appxupload,*.msixupload
          if (-not $uploads) {
            Write-Error "No .appxupload/.msixupload produced. Check build logs."
          }

          $uploads | ForEach-Object {
            Copy-Item $_.FullName -Destination $out -Force
            Write-Host "Collected: $($_.FullName)"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: store-upload-package
          path: artifacts
