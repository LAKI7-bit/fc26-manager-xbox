<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC26 Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EA FC MGR">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: #0f172a;
            overscroll-behavior-y: contain; 
        }

        /* --- MODERN AURA BLOBS (APPLE STYLE) --- */
.bg-gradient-mesh {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2;
    background-color: #020617; /* Bardzo g≈Çƒôboka czer≈Ñ/granat */
    overflow: hidden;
}

/* --- POPRAWIONE AURA BLOBS --- */
.blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.5;
    mix-blend-mode: screen;
    animation: move-blobs 12s infinite alternate ease-in-out;
    will-change: transform; /* OPTYMALIZACJA GPU */
}

.blob-green {
    width: 300px; height: 300px; /* Zmniejszono z 500px */
    background: #07f468;
    top: 10%; left: 10%;
}

.blob-purple {
    width: 400px; height: 400px; /* Zmniejszono z 600px */
    background: #7c3aed;
    bottom: 10%; right: 10%;
    animation-delay: -2s;
    animation-duration: 15s;
}

.blob-blue {
    width: 350px; height: 350px; /* Zmniejszono z 450px */
    background: #3b82f6;
    top: 40%; left: 40%;
    animation-delay: -5s;
    animation-duration: 18s;
}

@keyframes move-blobs {
    0% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(20vw, 10vh) scale(1.2); } /* Ruch oparty o szeroko≈õƒá ekranu (vw/vh) */
    66% { transform: translate(-10vw, 20vh) scale(0.8); }
    100% { transform: translate(10vw, -10vh) scale(1.1); }
}

/* Delikatna winieta, aby przyciemniƒá brzegi ekranu */
.bg-gradient-mesh::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, transparent 20%, rgba(2, 6, 23, 0.8) 100%);
}

/* Subtelny szum dla g≈Çƒôbi */
.particles {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    opacity: 0.03; /* Zmieniono z 0.2 na 0.03 - prawie niewidoczne, daje tylko delikatnƒÖ g≈Çƒôbiƒô */
    pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

        /* --- UI UTILS --- */
        .glass-panel {
    background: rgba(15, 23, 42, 0.6); /* Zmniejszono krycie z 0.7 na 0.6 */
    backdrop-filter: blur(25px) saturate(180%); /* Zwiƒôkszono blur dla lepszego efektu szk≈Ça */
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
}
        .league-btn { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .league-btn:active { transform: scale(0.95); }
        .league-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; border-color: transparent;
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }

        /* --- TEAM FACT BADGES --- */
       /* POPRAWIONE ETYKIETY - ROGI I GLOW */
        .team-fact-badge {
            position: absolute;
            top: -10px; /* Przesuniƒôcie do g√≥ry, aby siedzia≈Ço na rogu */
            padding: 6px 12px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: white;
            z-index: 50;
            letter-spacing: 0.05em;
            white-space: nowrap;
            border-radius: 99px;
            border: 2px solid rgba(255,255,255,0.8);
            /* EFEKT GLOW */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6), inset 0 0 5px rgba(0,0,0,0.2);
            animation: slideInBadge 0.4s ease-out;
        }

        .badge-left { 
            left: -10px; /* Na lewym rogu */
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .badge-right { 
            right: -10px; /* Na prawym rogu */
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        
        .fut-card-empty {
            background: rgba(31, 41, 55, 0.6);
            border: 2px dashed rgba(75, 85, 99, 1);
            height: 100%;
            display: flex; flex-direction: column; justify-content: center;
        }

        .team-card-burnt {
            filter: grayscale(100%);
            opacity: 0.8;
            border: 4px solid #ef4444 !important;
        }
        .burnt-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 20; pointer-events: none;
        }
        .burnt-text {
            color: #ef4444; font-weight: 900; font-size: 2rem; 
            transform: rotate(-15deg); border: 4px solid #ef4444; 
            padding: 1rem; text-transform: uppercase; letter-spacing: 0.2em;
        }

        input[type=range] { accent-color: #fbbf24; }
        
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .fade-in-seq { animation: fadeInSeq 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInSeq { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .score-flash { animation: scoreFlash 0.3s ease-out; color: #fbbf24 !important; transform: scale(1.3); }
        @keyframes scoreFlash { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fbbf24; } 100% { transform: scale(1); } }
        
        .team-info-content {
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             width: 100%; height: 100%;
        }
        .team-info-content .team-name {
            font-size: 1.5rem;
        }
        @media (min-width: 768px) {
            .team-info-content .team-name {
                font-size: 2.5rem;
            }
        }

        /* --- LOADING OVERLAY --- */
        #loading-screen {
            position: fixed; inset: 0; z-index: 10000;
            background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #07f468;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOAST NOTIFICATION --- */
        #toast-notification {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(16, 185, 129, 0.9);
            border: 1px solid #34d399;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            display: flex; align-items: center; gap: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 10002;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #toast-notification.show { transform: translateY(0); opacity: 1; }

        /* --- MODALS --- */
        #recording-modal, #stats-modal, #post-match-modal, #format-modal, #selection-modal, #player-profile-modal, #delete-players-modal, #compare-modal, #settings-modal, #confirm-reset-modal, #manual-select-modal, #edit-match-modal, #avatar-modal {
            background: rgba(0, 0, 0, 0.95);
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        #recording-modal.hidden, #stats-modal.hidden, #post-match-modal.hidden, #format-modal.hidden, #selection-modal.hidden, #player-profile-modal.hidden, #delete-players-modal.hidden, #compare-modal.hidden, #settings-modal.hidden, #confirm-reset-modal.hidden, #manual-select-modal.hidden, #edit-match-modal.hidden, #avatar-modal.hidden { display: none !important; }

        #stats-modal { z-index: 9000 !important; }
        
        #player-profile-modal, #compare-modal, #settings-modal, #manual-select-modal, #edit-match-modal { z-index: 9100 !important; }
        #avatar-modal { z-index: 10005 !important; }

        #confirm-reset-modal { z-index: 10003 !important; }
        
        #stats-modal .bg-slate-900, 
#universal-picker-modal .bg-gray-900, 
#player-profile-modal .bg-gray-900, 
#compare-modal .bg-gray-900 {
    width: 98%;
    max-width: 1000px; /* Znacznie szersze modale */
    height: 90vh;      /* Wy≈ºsze modale */
}

        #stats-content { overflow-x: auto; }
        
        #p1-name-display, #p2-name-display {
            padding: 0 4px;
            line-height: 1.2;
        }

        /* --- VS OVERLAY --- */
        #vs-overlay {
            position: fixed; inset: 0; z-index: 9990;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #vs-overlay.active { pointer-events: auto; opacity: 1; }
        .vs-panel { position: absolute; display: flex; align-items: center; justify-content: center; overflow: hidden; transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        #vs-left-panel { top: 0; left: 0; width: 100%; height: 50%; transform-origin: top; transform: scaleY(0); border-bottom: 2px solid rgba(0,0,0,0.5); }
        #vs-right-panel { bottom: 0; left: 0; width: 100%; height: 50%; transform-origin: bottom; transform: scaleY(0); border-top: 2px solid rgba(0,0,0,0.5); }
        @media (min-width: 768px) {
            #vs-left-panel { width: 50%; height: 100%; bottom: auto; border-bottom: none; border-right: 2px solid rgba(0,0,0,0.5); transform-origin: left; transform: scaleX(0); }
            #vs-right-panel { width: 50%; height: 100%; top: 0; right: 0; left: auto; border-top: none; border-left: 2px solid rgba(0,0,0,0.5); transform-origin: right; transform: scaleX(0); }
        }
        #vs-overlay.active #vs-left-panel, #vs-overlay.active #vs-right-panel { transform: scale(1); }
        .vs-content { opacity: 0; transform: scale(0.8); transition: all 0.5s 0.3s ease-out; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        #vs-overlay.active .vs-content { opacity: 1; transform: scale(1); }
        .vs-crest-img { width: auto; height: auto; max-width: 60%; max-height: 50vh; object-fit: contain; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.6)); }
        .vs-crest-flag { font-size: 8rem; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
        .vs-badge-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 90px; height: 90px; z-index: 10001; transition: transform 0.6s 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; justify-content: center; }
        #vs-overlay.active .vs-badge-container { transform: translate(-50%, -50%) scale(1); }
        .vs-circle { width: 100%; height: 100%; background: #000; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 40px rgba(255, 255, 255, 0.5); display: flex; align-items: center; justify-content: center; }
        .vs-text-inner { color: #fff; font-family: 'Poppins', sans-serif; font-weight: 900; font-style: italic; font-size: 2.5rem; line-height: 1; padding-right: 5px; margin-top: 2px; }

        .goal-card {
            background: linear-gradient(145deg, #1f2937, #111827);
            border-left: 6px solid;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .delete-goal-btn {
            position: absolute; top: 8px; right: 8px;
            color: #ef4444; background: rgba(0,0,0,0.3); 
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer;
        }

        .stat-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: center; min-height: 80px; }
        .stat-val { font-size: 1.25rem; font-weight: 800; color: white; }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.05em; margin-top: 4px; }
        
        .main-stat-card { border: 1px solid rgba(251, 191, 36, 0.3); background: linear-gradient(to bottom right, rgba(251, 191, 36, 0.1), rgba(0,0,0,0.4)); transform: scale(1.0); }
        .main-stat-val { font-size: 1.5rem; color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        .sub-ranking { background: rgba(255,255,255,0.03); padding: 6px; border-radius: 6px; margin-top: 8px; }
        .sub-ranking-item { display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af; padding: 2px 0; }
        .sub-ranking-value { font-weight: 700; color: #facc15; }
        
        #results-scroll-target {
            scroll-margin-top: 20px;
        }
        
        #player-profile-content .main-stat-card {
            min-height: 100px;
        }

        #player-profile-content .main-stat-card .main-stat-val {
            font-size: 1.25rem;
        }
        
        @media (min-width: 768px) {
            #player-profile-content .main-stat-card .main-stat-val {
                font-size: 1.5rem;
            }
        }

        .penalty-score {
            font-size: 0.3em; 
            font-weight: 700;
            color: #fbbf24;
            margin-left: 0.3rem; 
            vertical-align: super;
            opacity: 0.9;
            letter-spacing: 1px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* --- GOAL WIZARD STYLES --- */
        #goal-wizard-modal {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98);
            z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #goal-wizard-modal.hidden { display: none; }
        
        .wizard-btn {
            background: #1e293b; border: 1px solid #334155;
            color: white; font-weight: 700; text-transform: uppercase;
            padding: 1rem; border-radius: 1rem; width: 100%;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .wizard-btn:active { transform: scale(0.95); background: #334155; }
        .wizard-btn-icon { font-size: 1.5rem; }

        /* --- ROULETTE (CS:GO STYLE) --- */
        .roulette-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #111;
            border-radius: 1.5rem;
        }
        .roulette-strip {
            display: flex;
            height: 100%;
            align-items: center;
            will-change: transform;
        }
        .roulette-item {
            width: 150px;
            height: 140px;
            flex-shrink: 0;
            margin: 0 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1f2937;
            position: relative;
            box-sizing: border-box;
        }
        .roulette-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: #fbbf24;
            transform: translateX(-50%);
            z-index: 20;
            box-shadow: 0 0 10px #fbbf24;
        }

        .rarity-common { background: #1f2937; border-color: #4b5563; }
        .rarity-rare { background: linear-gradient(135deg, #7f1d1d, #450a0a); border-color: #ef4444; }
        .rarity-epic { background: linear-gradient(135deg, #713f12, #422006); border-color: #eab308; }
        .rarity-legendary { background: linear-gradient(135deg, #14532d, #052e16); border-color: #22c55e; }
        .rarity-special {
            background: conic-gradient(at center, #f43f5e, #8b5cf6, #10b981, #f43f5e);
            border-color: #fff;
            animation: pulse-special 2s infinite;
        }
        @keyframes pulse-special { 0% { box-shadow: 0 0 0 rgba(255,255,255,0); } 50% { box-shadow: 0 0 15px rgba(255,255,255,0.5); } 100% { box-shadow: 0 0 0 rgba(255,255,255,0); } }
        
        .panel-wrapper { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Trend Animations */
        .trend-arrow { display: inline-block; animation: fadeUp 0.5s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    /* NOWE STYLE DLA WYBORU DRU≈ªYN */
.team-input-box {
    background: rgba(17, 24, 39, 0.6);
    border: 2px dashed rgba(75, 85, 99, 0.5);
    border-radius: 1rem;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.team-input-box:hover {
    background: rgba(31, 41, 55, 0.8);
    border-color: rgba(99, 102, 241, 0.5);
    transform: translateY(-2px);
}
.team-input-box.has-players {
    border-style: solid;
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(99, 102, 241, 0.5);
}
.team-input-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #9ca3af;
    font-weight: 700;
    margin-bottom: 0.5rem;
    letter-spacing: 0.1em;
}
.picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); /* ZMIANA: Szersze kolumny */
    gap: 0.75rem;
    padding: 0.5rem;
}
.picker-card {
    background: #1f2937;
    border: 2px solid #374151; /* ZMIANA: Grubsza ramka */
    border-radius: 1rem;       /* ZMIANA: Bardziej zaokrƒÖglone */
    padding: 1rem;             /* ZMIANA: Wiƒôkszy padding */
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    display: flex;              /* ZMIANA: Flex dla centrowania */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;         /* ZMIANA: Minimalna wysoko≈õƒá */
}
.picker-card .font-bold {
    font-size: 1.1rem;         /* ZMIANA: Wiƒôksza czcionka dla imienia */
    margin-bottom: 0.25rem;
    width: 100%;
}
.picker-card.selected {
    background: #4f46e5;
    border-color: #818cf8;
    color: white;
}
.picker-card:hover { transform: translateY(-2px); }
.picker-stat { font-size: 0.65rem; color: #9ca3af; margin-top: 2px; }
.picker-card.selected .picker-stat { color: #e0e7ff; }

.action-icon-btn {
    width: 2.5rem; height: 2.5rem;
    display: flex; align-items: center; justify-content: center;
    border-radius: 0.5rem;
    transition: all 0.2s;
}
@keyframes slideInBadge {
    from { transform: translateY(-20px) scale(0.9); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}
.league-badge {
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}
/* Subtelny efekt po≈õwiaty dla konkretnych lig */
.league-badge.bg-purple-900 { box-shadow: 0 0 10px rgba(168, 85, 247, 0.2); }
.league-badge.bg-orange-900 { box-shadow: 0 0 10px rgba(249, 115, 22, 0.2); }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-2 md:p-4">
   <!-- AUTH SCREEN (NOWY) -->
<div id="auth-screen" class="fixed inset-0 z-[20000] flex items-center justify-center p-4">
    <!-- Usuniƒôto bg-[#0f172a], teraz widaƒá t≈Ço strony -->
    <div class="glass-panel p-8 rounded-3xl w-full max-w-md animate-pop relative border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
        
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black italic tracking-tighter text-white mb-2">FC26 <span class="text-[#07f468]">MANAGER</span></h1>
            <p class="text-xs text-gray-400 uppercase tracking-widest">Twoje Centrum Dowodzenia</p>
        </div>
        
        <!-- Formularz Logowania -->
        <div id="login-form">
            <input type="email" id="auth-email" placeholder="Email" class="w-full bg-gray-900/50 border border-gray-600 p-4 rounded-xl mb-3 text-white placeholder-gray-500 focus:border-[#07f468] outline-none transition-colors">
            <input type="password" id="auth-pass" placeholder="Has≈Ço" class="w-full bg-gray-900/50 border border-gray-600 p-4 rounded-xl mb-4 text-white placeholder-gray-500 focus:border-[#07f468] outline-none transition-colors">
            
            <button onclick="window.AuthManager.login()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-4 rounded-xl font-black uppercase tracking-widest mb-4 shadow-lg text-white transition-transform active:scale-95">
                Zaloguj siƒô
            </button>
            
            <button onclick="window.AuthManager.guestLogin()" class="w-full bg-gray-700/50 hover:bg-gray-700 py-3 rounded-xl font-bold uppercase tracking-widest mb-6 text-xs text-gray-300 border border-white/10 transition-colors">
                Graj jako Go≈õƒá (Bez zapisu online)
            </button>

            <div class="flex justify-between text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                <button onclick="window.AuthManager.switchForm('register')" class="hover:text-white transition-colors border-b border-transparent hover:border-white pb-0.5">Stw√≥rz Konto</button>
                <button onclick="window.AuthManager.switchForm('reset')" class="hover:text-white transition-colors border-b border-transparent hover:border-white pb-0.5">Zapomnia≈Çem has≈Ça</button>
            </div>
        </div>

        <!-- Formularz Rejestracji (ukryty) -->
        <div id="register-form" class="hidden">
            <h2 class="text-xl font-bold text-white mb-6 text-center">Nowy Manager</h2>
            <input type="email" id="reg-email" placeholder="Tw√≥j Email" class="w-full bg-gray-900/50 border border-gray-600 p-4 rounded-xl mb-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none">
            <input type="password" id="reg-pass" placeholder="Has≈Ço (min. 6 znak√≥w)" class="w-full bg-gray-900/50 border border-gray-600 p-4 rounded-xl mb-6 text-white placeholder-gray-500 focus:border-blue-500 outline-none">
            
            <button onclick="window.AuthManager.register()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase tracking-widest mb-4 shadow-lg text-white">
                Zarejestruj siƒô
            </button>
            <button onclick="window.AuthManager.switchForm('login')" class="w-full text-xs text-gray-400 uppercase font-bold hover:text-white">‚Üê Powr√≥t do logowania</button>
        </div>

        <!-- Formularz Resetu Has≈Ça (ukryty) -->
        <div id="reset-form" class="hidden">
            <h2 class="text-xl font-bold text-white mb-2 text-center">Reset Has≈Ça</h2>
            <p class="text-xs text-gray-400 text-center mb-6">Podaj email, wy≈õlemy link do zmiany has≈Ça.</p>
            <input type="email" id="reset-email-input" placeholder="Email" class="w-full bg-gray-900/50 border border-gray-600 p-4 rounded-xl mb-6 text-white placeholder-gray-500 focus:border-yellow-500 outline-none">
            
            <button onclick="window.AuthManager.resetPassword()" class="w-full bg-yellow-600 hover:bg-yellow-500 py-4 rounded-xl font-black uppercase tracking-widest mb-4 shadow-lg text-black">
                Wy≈õlij Link
            </button>
            <button onclick="window.AuthManager.switchForm('login')" class="w-full text-xs text-gray-400 uppercase font-bold hover:text-white">‚Üê Powr√≥t</button>
        </div>
    </div>
</div>
    <div id="loading-screen">
        <span class="loader mb-4"></span>
        <h2 class="text-xl font-bold text-gray-300 tracking-widest">≈ÅƒÑCZENIE Z CHMURƒÑ...</h2>
        <p class="text-xs text-gray-500 mt-2">Pobieranie Twoich statystyk</p>
    </div>
    
    <div id="toast-notification">
        <span>Zapisano w chmurze!</span>
    </div>

    <div class="bg-gradient-mesh">
    <!-- Animowane plamy ≈õwiat≈Ça -->
    <div class="blob blob-green"></div>
    <div class="blob blob-purple"></div>
    <div class="blob blob-blue"></div>
</div>
<div class="particles"></div>

    <div id="app-container" class="w-full max-w-7xl mx-auto relative z-10 flex flex-col h-full hidden">

        <!-- Top Bar -->
<div class="grid grid-cols-3 items-center w-full mb-2 px-2 z-50">
    <!-- Lewa strona: Przycisk Menu -->
    <div class="flex justify-start">
        <button onclick="window.Sidebar.open()" class="bg-gray-800/80 hover:bg-gray-700 w-10 h-10 rounded-full flex items-center justify-center border border-white/10 shadow-lg transition-transform active:scale-90 shrink-0">
            <span class="text-xl text-white">‚ò∞</span>
        </button>
    </div>

    <!-- ≈örodek: Tytu≈Ç aplikacji -->
    <div class="flex flex-col items-center justify-center text-center leading-none">
        <span class="text-xl md:text-2xl font-black italic tracking-tighter text-white uppercase leading-none">FC26 <span class="text-[#07f468]">MANAGER</span></span>
        <span class="text-[8px] md:text-[10px] text-gray-500 font-bold uppercase tracking-[0.2em] ml-0.5">by lakiseven</span>
    </div>

    <!-- Prawa strona: Pusta dla zachowania symetrii -->
    <div class="flex justify-end"></div>
</div>
</div>

        <!-- STEP 1: PLAYERS CONFIG (NOWY WYGLƒÑD) -->
<div id="step1-screen" class="glass-panel p-6 md:p-10 rounded-3xl animate-pop w-full max-w-5xl mx-auto my-auto relative">
    <h1 class="text-2xl md:text-5xl font-black text-center mb-6 drop-shadow-sm uppercase italic tracking-tighter" style="color: #07f468;">
        Kto Gra?
    </h1>
    
    <!-- Input Fields for Teams -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <!-- Team 1 Input -->
        <div class="team-input-box" onclick="window.PlayerManager.openTeamPicker(1)" id="team1-input-box">
            <span class="team-input-label text-blue-400">Dru≈ºyna 1</span>
            <div id="team1-display-list" class="flex flex-wrap justify-center gap-2 p-2 w-full">
                <span class="text-gray-500 text-sm italic">Kliknij, by dodaƒá</span>
            </div>
        </div>

        <!-- Team 2 Input -->
        <div class="team-input-box" onclick="window.PlayerManager.openTeamPicker(2)" id="team2-input-box">
            <span class="team-input-label text-red-400">Dru≈ºyna 2</span>
            <div id="team2-display-list" class="flex flex-wrap justify-center gap-2 p-2 w-full">
                <span class="text-gray-500 text-sm italic">Kliknij, by dodaƒá</span>
            </div>
        </div>
    </div>

    <!-- Action Buttons Row -->
    <div class="grid grid-cols-3 gap-3 mb-6">
        <button onclick="window.PlayerManager.clearTeams()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 rounded-xl text-xs uppercase tracking-wider border border-gray-600 transition-all flex flex-col items-center justify-center gap-1">
            <span class="text-lg">üßπ</span> Wyczy≈õƒá
        </button>
        
        <button onclick="window.PlayerManager.startDrawFlow()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl text-xs uppercase tracking-wider shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center gap-1">
            <span class="text-lg">üé≤</span> Wylosuj
        </button>
        
        <button onclick="window.PlayerManager.swapSides()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl text-xs uppercase tracking-wider border border-indigo-400 transition-all flex flex-col items-center justify-center gap-1">
            <span class="text-lg">‚áÑ</span> Zamie≈Ñ
        </button>
    </div>

    <!-- Navigation -->
    <button id="goto-step2-btn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-black py-4 px-6 rounded-xl transition duration-300 transform hover:scale-[1.02] shadow-xl text-lg tracking-widest uppercase border-t border-white/20">
        GRAJMY MECZ!
    </button>
</div>

        <!-- SELECTION MODAL -->
        <div id="selection-modal" class="hidden">
            <div class="bg-gray-900 border border-purple-500/50 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-pop max-h-[80vh] flex flex-col">
                <h2 class="text-xl font-bold text-white mb-2 text-center">Wybierz Graczy do Losowania</h2>
                <div class="flex justify-end mb-2">
                    <button id="select-all-btn" class="text-xs text-purple-400 hover:text-white underline" onclick="Sound.click()">Zaznacz wszystkich</button>
                </div>
                <div id="selection-list" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 mb-4 p-2 bg-gray-800 rounded"></div>
                <div class="flex gap-3">
                     <button onclick="document.getElementById('selection-modal').classList.add('hidden'); Sound.click();" class="w-1/3 bg-gray-700 py-3 rounded-xl font-bold text-sm">Anuluj</button>
                     <button id="confirm-selection-btn" class="w-2/3 bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold text-sm">Dalej</button>
                </div>
            </div>
        </div>
        
        <!-- DELETE PLAYERS MODAL -->
        <div id="delete-players-modal" class="hidden">
            <div class="bg-gray-900 border border-red-500/50 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-pop max-h-[80vh] flex flex-col">
                <h2 class="text-xl font-bold text-red-500 mb-2 text-center">Usu≈Ñ Graczy</h2>
                <p class="text-xs text-gray-400 text-center mb-4">Zaznacz graczy do trwa≈Çego usuniƒôcia.</p>
                <div id="delete-list" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 mb-4 p-2 bg-gray-800 rounded"></div>
                <div class="flex gap-3">
                     <button onclick="document.getElementById('delete-players-modal').classList.add('hidden'); Sound.click();" class="w-1/3 bg-gray-700 py-3 rounded-xl font-bold text-sm">Anuluj</button>
                     <button id="confirm-delete-btn" class="w-2/3 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-sm">Usu≈Ñ Zaznaczonych</button>
                </div>
            </div>
        </div>

        <!-- FORMAT MODAL -->
        <div id="format-modal" class="hidden">
            <div class="bg-gray-900 border border-purple-500/50 p-6 rounded-2xl w-full max-w-sm text-center shadow-2xl animate-pop">
                <h2 class="text-xl font-bold text-white mb-4 uppercase tracking-widest">Format Meczu</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.PlayerManager.executeDraw('1v1')" class="bg-gray-800 hover:bg-purple-600 border border-gray-600 py-4 rounded-xl font-black text-xl transition-all">1 v 1</button>
                    <button onclick="window.PlayerManager.executeDraw('2v2')" class="bg-gray-800 hover:bg-purple-600 border border-gray-600 py-4 rounded-xl font-black text-xl transition-all">2 v 2</button>
                    <button onclick="window.PlayerManager.executeDraw('1v2')" class="bg-gray-800 hover:bg-purple-600 border border-gray-600 py-4 rounded-xl font-black text-xl transition-all">1 v 2</button>
                    <button onclick="window.PlayerManager.executeDraw('1v3')" class="bg-gray-800 hover:bg-purple-600 border border-gray-600 py-4 rounded-xl font-black text-xl transition-all">1 v 3</button>
                </div>
                <button onclick="document.getElementById('format-modal').classList.add('hidden'); Sound.click();" class="mt-4 text-gray-500 text-xs hover:text-white underline">Anuluj</button>
            </div>
        </div>

        
        <!-- CUSTOM CONFIRMATION MODAL FOR HARD RESET -->
        <div id="confirm-reset-modal" class="hidden">
            <div class="bg-gray-800 p-6 rounded-xl text-center border border-red-500/50 max-w-sm animate-pop">
                <p class="text-lg font-bold text-red-400 mb-4">UWAGA: PE≈ÅNY RESET DANYCH!</p>
                <p class="text-sm text-gray-300 mb-6">Czy na pewno chcesz usunƒÖƒá WSZYSTKIE dane (graczy, mecze, sesje)? Tej operacji NIE DA SIƒò COFNƒÑƒÜ.</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-reset-action" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Tak, Resetuj!</button>
                    <button id="cancel-reset-action" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Anuluj</button>
                </div>
            </div>
        </div>
        
        <!-- MANUAL SELECTION MODAL -->
        <div id="manual-select-modal" class="hidden">
            <div class="bg-gray-900 border border-indigo-500/50 p-6 rounded-2xl w-full max-w-2xl shadow-2xl animate-pop text-center max-h-[90vh] overflow-y-auto flex flex-col">
                <h2 class="text-2xl font-black text-white mb-2 uppercase tracking-widest">Wybierz Dru≈ºynƒô</h2>
                <div id="manual-league-list" class="flex flex-wrap gap-2 justify-center mb-4"></div>
                <div id="manual-team-grid" class="grid grid-cols-3 md:grid-cols-4 gap-2 overflow-y-auto flex-grow max-h-[50vh] p-2 bg-gray-800/50 rounded-lg"></div>
                 <button onclick="document.getElementById('manual-select-modal').classList.add('hidden'); Sound.click();" class="mt-4 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold text-sm">Anuluj</button>
            </div>
        </div>
        
        <!-- AVATAR EDITOR MODAL -->
        <div id="avatar-modal" class="hidden">
            <div class="bg-gray-900 border border-yellow-500/50 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-pop text-center">
                <h2 class="text-xl font-bold text-yellow-400 mb-4 uppercase tracking-widest">Edytor Gracza</h2>
                <p class="text-xs text-gray-400 mb-4">Dostosuj sw√≥j awatar. Zmiany zostanƒÖ zapisane w bazie.</p>
                
                <div class="flex flex-col gap-4 items-center mb-6">
                    <div id="avatar-preview-circle" class="w-24 h-24 rounded-full flex items-center justify-center text-4xl border-4 border-white/20 shadow-lg transition-colors duration-300">
                        üòé
                    </div>
                    
                    <div class="w-full">
                         <label class="text-[10px] uppercase text-gray-500 font-bold block mb-1">Emoji (Max 1 znak)</label>
                         <input type="text" id="avatar-emoji-input" maxlength="2" class="bg-gray-800 border border-gray-600 text-center text-2xl p-2 rounded-lg w-full text-white" placeholder="üòé">
                    </div>

                    <div class="w-full">
                         <label class="text-[10px] uppercase text-gray-500 font-bold block mb-1">Kolor T≈Ça</label>
                         <input type="color" id="avatar-color-input" class="w-full h-10 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('avatar-modal').classList.add('hidden'); Sound.click();" class="w-1/3 bg-gray-700 py-3 rounded-xl font-bold text-sm">Anuluj</button>
                    <button id="save-avatar-btn" class="w-2/3 bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold text-sm text-black">Zapisz</button>
                </div>
            </div>
        </div>
        
        <!-- EDIT MATCH MODAL -->
        <div id="edit-match-modal" class="hidden">
            <div class="bg-gray-900 border border-blue-500/50 p-6 rounded-2xl w-full max-w-lg shadow-2xl animate-pop text-center max-h-[95vh] overflow-y-auto flex flex-col">
                <h2 class="text-xl font-bold text-blue-400 mb-4 uppercase tracking-widest">Edycja Meczu</h2>
                <div id="edit-match-content" class="flex flex-col gap-4">
                    <!-- Dynamic content injected here -->
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('edit-match-modal').classList.add('hidden'); Sound.click();" class="w-1/3 bg-gray-700 py-3 rounded-xl font-bold text-sm">Anuluj</button>
                    <button id="save-edit-match-btn" class="w-2/3 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm">Zapisz Zmiany</button>
                </div>
            </div>
        </div>


        <!-- STEP 2: MATCH PARAMS -->
        <div id="step2-screen" class="hidden glass-panel p-6 md:p-10 rounded-3xl animate-pop w-full max-w-5xl mx-auto my-auto relative">
             <div class="absolute top-4 left-4">
                <button id="back-to-step1-btn" class="text-gray-400 hover:text-white text-sm">Wr√≥ƒá</button>
             </div>
             <h1 class="text-2xl md:text-4xl font-black text-center mb-2 drop-shadow-sm uppercase italic tracking-tighter text-white">
                Parametry Meczu
             </h1>
             <div class="flex justify-center items-center gap-4 mb-6 bg-white/5 py-2 rounded-lg">
                 <span id="preview-team1" class="text-blue-300 font-bold uppercase text-sm text-center w-1/3 break-words"></span>
                 <span class="text-gray-500 text-xs font-mono">VS</span>
                 <span id="preview-team2" class="text-red-300 font-bold uppercase text-sm text-center w-1/3 break-words"></span>
             </div>
            
            <div class="space-y-6">
                <!-- Leagues -->
                <div>
                    <label class="block mb-3 text-xs md:text-sm font-bold text-gray-300 uppercase tracking-wider text-center">Wybierz Ligƒô</label>
                    <div id="league-filters" class="flex flex-wrap gap-2 justify-center">
                         <button data-league="All" class="league-btn active px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Wszystkie</button>
                         <button data-league="All_NoRow" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Wszystkie (Bez R.≈öwiat)</button>
                         <button data-league="Clubs" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Kluby</button>
                         <button data-league="National" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Reprezentacje</button>
                         <button data-league="Premier League" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Premier League</button>
                         <button data-league="La Liga" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">La Liga</button>
                         <button data-league="Bundesliga" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Bundesliga</button>
                         <button data-league="Serie A" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Serie A</button>
                         <button data-league="Ligue 1" class="league-btn px-3 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs md:text-sm">Ligue 1</button>
                    </div>
                </div>

                <!-- Sliders -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/40 p-3 rounded-xl border border-gray-700/50">
                        <label class="flex justify-between mb-2 text-xs font-medium text-gray-300">
                            <span>Min Gwiazdek</span>
                            <span id="min-stars-value" class="text-yellow-400 font-bold">2.5</span>
                        </label>
                        <input id="min-stars" type="range" min="2.5" max="5" value="2.5" step="0.5" class="w-full h-2 bg-gray-700 rounded-full appearance-none cursor-pointer">
                    </div>
                    <div class="bg-gray-800/40 p-3 rounded-xl border border-gray-700/50">
                        <label class="flex justify-between mb-2 text-xs font-medium text-gray-300">
                            <span>Max Gwiazdek</span>
                            <span id="max-stars-value" class="text-yellow-400 font-bold">5</span>
                        </label>
                        <input id="max-stars" type="range" min="2.5" max="5" value="5" step="0.5" class="w-full h-2 bg-gray-700 rounded-full appearance-none cursor-pointer">
                    </div>
                </div>

                <!-- Rerolls -->
                <div class="text-center">
                    <label class="block mb-2 w-full text-xs font-medium text-gray-300">Rerolle (Przelosowania)</label>
                    <div class="inline-flex items-center bg-gray-800/80 rounded-full p-1 border border-gray-600">
                        <button id="reroll-minus-btn" class="w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center font-bold text-base transition-colors">-</button>
                        <span id="rerolls-value" class="w-12 text-center text-xl font-bold text-white">3</span>
                        <button id="reroll-plus-btn" class="w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center font-bold text-base transition-colors">+</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-4 mt-8">
                 <button id="start-drawing-btn" class="w-full bg-gradient-to-br from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-xl transition duration-300 transform hover:scale-[1.02] shadow-xl border-t border-white/20 text-lg tracking-widest uppercase">
                    PRZEJD≈π DO LOSOWANIA
                 </button>
            </div>
           
            <p id="session-info" class="text-center text-[10px] text-gray-500 mt-2">Dru≈ºyny u≈ºyte w sesji: 0</p>
        </div>

       <!-- STEP 3: DRAWING SCREEN -->
        <div id="drawing-screen" class="hidden w-full flex-grow flex flex-col justify-start relative mt-1">
            
            <!-- HEADER ROW (Nazwy + H2H w jednej linii - BEZPIECZNY UK≈ÅAD) -->
            <!-- U≈ºywamy gap, aby wymusiƒá odstƒôp od H2H -->
            <div class="w-full flex flex-row items-center justify-between gap-1 md:gap-2 mt-4 mb-2 z-10 relative min-h-[50px]">
                
                <!-- NAME 1 (Wyr√≥wnane do LEWEJ - PoczƒÖtek Karty 1) -->
                <div class="flex-1 flex justify-start items-center overflow-hidden min-w-0">
                    <div id="p1-name-display" class="w-full text-left font-black uppercase tracking-tighter drop-shadow-md leading-tight truncate transition-all duration-300 pl-1"></div>
                </div>

                <!-- H2H STATS (≈örodek - nie da siƒô go zas≈Çoniƒá) -->
                <div class="shrink-0 flex justify-center items-center z-20">
                     <div id="h2h-stats-display" class="flex justify-center items-center scale-90 origin-center filter drop-shadow-xl"></div>
                </div>

                <!-- NAME 2 (Wyr√≥wnane do PRAWEJ - Koniec Karty 2) -->
                <div class="flex-1 flex justify-end items-center overflow-hidden min-w-0">
                    <div id="p2-name-display" class="w-full text-right font-black uppercase tracking-tighter drop-shadow-md leading-tight truncate transition-all duration-300 pr-1"></div>
                </div>
            </div>

            <!-- MAIN GRID (Panels) -->
            <div class="flex flex-row gap-2 md:gap-4 w-full h-[65vh] md:h-[70vh] items-stretch z-10 relative">
                <div class="panel-wrapper flex flex-col w-1/2 gap-2 flex-1" id="wrapper-t1">
                    <div id="team1-panel" class="fut-card-empty rounded-3xl p-4 relative transition-all duration-500 flex flex-grow flex-col items-center justify-center h-full">
                        <div id="team1-info" class="text-center w-full z-10 flex flex-col items-center justify-center h-full">
                            <div class="animate-pulse text-6xl md:text-8xl opacity-20">‚öΩ</div>
                        </div>
                    </div>
                    <button onclick="window.ManualSelect.open(true, 1)" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-2 rounded-lg border border-gray-600 font-bold uppercase shadow-lg" id="manual-btn-1">
                        üìù Wybierz Rƒôcznie
                    </button>
                </div>
                
                <div class="panel-wrapper flex flex-col w-1/2 gap-2 flex-1" id="wrapper-t2">
                    <div id="team2-panel" class="fut-card-empty rounded-3xl p-4 relative transition-all duration-500 flex flex-grow flex-col items-center justify-center h-full">
                        <div id="team2-info" class="text-center w-full z-10 flex flex-col items-center justify-center h-full">
                            <div class="animate-pulse text-6xl md:text-8xl opacity-20">‚öΩ</div>
                        </div>
                    </div>
                    <button onclick="window.ManualSelect.open(true, 2)" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-2 rounded-lg border border-gray-600 font-bold uppercase shadow-lg" id="manual-btn-2">
                        üìù Wybierz Rƒôcznie
                    </button>
                </div>
            </div>

            <!-- ACTIONS -->
            <div class="w-full flex flex-col gap-2 mt-2 z-10 relative">
                <div class="grid grid-cols-2 gap-4 w-full px-2">
                     <div id="team1-actions" class="flex flex-col md:flex-row gap-2 hidden">
                         <button id="reroll-btn-1" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black font-black py-3 rounded-xl text-xs md:text-sm shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition-all">
                            PRZELOSUJ (<span id="rerolls-left-1"></span>)
                        </button>
                        <button id="keep-btn-1" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-black py-3 rounded-xl text-xs md:text-sm shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                            BIORƒò
                        </button>
                    </div>

                    <div id="team2-actions" class="flex flex-col md:flex-row gap-2 hidden">
                         <button id="reroll-btn-2" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black font-black py-3 rounded-xl text-xs md:text-sm shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition-all">
                            PRZELOSUJ (<span id="rerolls-left-2"></span>)
                        </button>
                        <button id="keep-btn-2" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-black py-3 rounded-xl text-xs md:text-sm shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                            BIORƒò
                        </button>
                    </div>
                </div>

                <div class="w-full flex justify-center mt-2 flex-col items-center gap-4">
                    <button id="draw-teams-btn" class="w-full max-w-sm bg-gradient-to-br from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-black py-4 px-8 rounded-2xl shadow-[0_0_25px_rgba(79,70,229,0.5)] border-t border-white/20 text-xl md:text-2xl tracking-widest transition-transform hover:scale-105 active:scale-95">
                        LOSUJ DRU≈ªYNY
                    </button>
                    <button id="abort-draw-btn" class="hidden mt-4 text-gray-500 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors" onclick="window.PlayerManager.abortDraw()">
    ‚Üê Powr√≥t do ustawie≈Ñ
</button>
                </div>
            </div>
            
            <div id="results-scroll-target"></div>
            <!-- (Sekcja Results pozostaje bez zmian) -->
             <div id="results-container" class="hidden mt-8 mb-32 animate-pop z-20 relative">
                <div class="glass-panel rounded-3xl p-4 md:p-8 text-center border-2 border-indigo-500/30 relative overflow-hidden">
                    <div id="live-match-timer" class="absolute top-2 right-2 md:top-4 md:right-4 z-10 hidden">
                        <div class="timer-display text-lg md:text-2xl font-bold tracking-widest" id="timer-text">0'</div>
                    </div>
                    <h3 class="text-indigo-400 text-sm font-bold uppercase tracking-widest mb-1">Symulacja Meczu (AI)</h3>
                    <p class="text-[10px] md:text-xs text-indigo-300 mb-4 tracking-wider opacity-80">(Bramki z dystansu x2)</p>
                    <div class="flex flex-col items-center justify-center">
                        <div class="flex items-center justify-center gap-4 md:gap-12">
                             <div class="text-6xl md:text-9xl font-black text-white transition-colors duration-200" id="score-team-1">0</div>
                             <div class="text-4xl text-gray-500 font-light">-</div>
                             <div class="text-6xl md:text-9xl font-black text-white transition-colors duration-200" id="score-team-2">0</div>
                        </div>
                        <div id="match-details" class="mt-4 text-base md:text-xl font-semibold text-yellow-400 min-h-[2rem]"></div>
                         <div id="match-events-log" class="mt-2 text-xs text-gray-400 font-mono space-y-1 max-w-md mx-auto"></div>
                    </div>
                    <div class="flex gap-4 justify-center mt-6">
                        <button id="reset-btn" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-xl font-bold border border-gray-500" onclick="Sound.click()">
                            Zako≈Ñcz / Anuluj
                        </button>
                        <button id="save-match-btn" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-xl font-bold border border-green-400 shadow-[0_0_15px_rgba(34,197,94,0.4)]" onclick="Sound.click()">
                            Zapisz Spotkanie
                        </button>
                    </div>
                </div>

                <!-- "What If" Section -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 opacity-90">
                    <div class="bg-black/30 rounded-xl p-3 border border-white/5">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-700 pb-1" id="alt-header-1">Gdyby≈õ losowa≈Ç dalej</p>
                        <div id="alt-list-1" class="space-y-1 text-sm flex flex-col gap-1 max-h-40 overflow-y-auto"></div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-3 border border-white/5">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-700 pb-1" id="alt-header-2">Gdyby≈õ losowa≈Ç dalej</p>
                        <div id="alt-list-2" class="space-y-1 text-sm flex flex-col gap-1 max-h-40 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- MODALS -->
    <div id="recording-modal" class="hidden">
        <div class="bg-slate-900 border border-slate-700 p-4 md:p-6 rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto m-2 shadow-2xl relative">
            <button id="close-recording-x" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="Sound.click()">&times;</button>
            <h2 class="text-xl md:text-2xl font-black text-center mb-4 text-green-400">RAPORT MECZOWY</h2>
            <div class="flex justify-center items-center gap-4 md:gap-8 mb-6 sticky top-0 bg-slate-900/95 py-4 z-10 border-b border-gray-800 shadow-lg">
                <div class="text-center w-1/3">
                    <div class="text-xs md:text-sm text-blue-300 mb-1 truncate" id="modal-t1-name">TEAM 1</div>
                    <div id="calc-score-1" class="text-5xl md:text-6xl font-black text-white">0</div>
                </div>
                <div class="text-2xl font-bold text-gray-600">:</div>
                <div class="text-center w-1/3">
                     <div class="text-xs md:text-sm text-red-300 mb-1 truncate" id="modal-t2-name">TEAM 2</div>
                    <div id="calc-score-2" class="text-5xl md:text-6xl font-black text-white">0</div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="window.MatchRecorder.addGoal(1)" class="bg-blue-600 hover:bg-blue-500 border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 py-6 rounded-xl text-lg md:text-xl font-black uppercase tracking-wider flex flex-col items-center gap-2 shadow-lg transition-all">
                    <span>+ GOL</span>
                    <span class="text-xs font-normal text-blue-200 opacity-75">(Dru≈ºyna 1)</span>
                </button>
                <button onclick="window.MatchRecorder.addGoal(2)" class="bg-red-600 hover:bg-red-500 border-b-4 border-red-800 active:border-b-0 active:translate-y-1 py-6 rounded-xl text-lg md:text-xl font-black uppercase tracking-wider flex flex-col items-center gap-2 shadow-lg transition-all">
                    <span>+ GOL</span>
                    <span class="text-xs font-normal text-red-200 opacity-75">(Dru≈ºyna 2)</span>
                </button>
            </div>

            <div class="text-center mb-4">
                <button id="toggle-history-btn" class="text-xs text-gray-400 hover:text-white uppercase font-bold underline decoration-dotted">
                    ‚¨á Poka≈º / Edytuj Historiƒô Bramek ‚¨á
                </button>
            </div>

            <div id="goal-history-wrapper" class="hidden bg-gray-900/50 p-4 rounded-xl border border-gray-700 mb-6">
                <p id="no-goals-msg" class="text-center text-gray-500 text-xs py-4">Brak goli. Kliknij przycisk powy≈ºej, aby dodaƒá zdarzenie.</p>
                <div id="goal-details-container" class="space-y-4"></div>
            </div>

            <div class="flex gap-4 justify-end border-t border-gray-700 pt-4">
                <button id="cancel-recording" class="px-4 py-2 text-gray-400 hover:text-white text-sm" onclick="Sound.click()">Anuluj</button>
                <button id="confirm-recording" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wide">Zapisz Mecz</button>
            </div>
            
            <!-- GOAL WIZARD OVERLAY -->
            <div id="goal-wizard-modal" class="hidden">
                <div class="w-full max-w-sm px-4 text-center">
                    <h3 id="wizard-title" class="text-xl font-black text-white mb-6 uppercase tracking-wider">Wybierz Metodƒô</h3>
                    <div id="wizard-buttons" class="grid grid-cols-2 gap-3"></div>
                    <button id="wizard-cancel" class="mt-8 text-gray-500 text-xs hover:text-white">Anuluj</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="player-profile-modal" class="hidden">
        <div class="bg-gray-900 border border-indigo-500/50 p-6 rounded-3xl w-full max-w-2xl shadow-2xl animate-pop m-4 relative overflow-y-auto max-h-[90vh]">
             <button onclick="document.getElementById('player-profile-modal').classList.add('hidden'); Sound.click();" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
             <div id="player-profile-content"></div>
        </div>
    </div>

    <div id="compare-modal" class="hidden">
        <div class="bg-gray-900 border border-blue-500/50 p-6 rounded-3xl w-full max-w-3xl shadow-2xl animate-pop m-4 relative overflow-y-auto max-h-[90vh]">
             <button onclick="document.getElementById('compare-modal').classList.add('hidden'); Sound.click();" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
             <h2 class="text-2xl font-black text-center mb-6 text-blue-400">POR√ìWNYWARKA</h2>
             
             <!-- Toggle Switch -->
             <div class="flex justify-center mb-4">
                <div class="flex bg-gray-800 rounded-lg p-1">
                    <button id="compare-mode-players" class="px-4 py-1.5 rounded-md text-sm font-bold bg-blue-600 text-white transition-colors" onclick="Sound.click()">Gracze</button>
                    <button id="compare-mode-duos" class="px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-white transition-colors" onclick="Sound.click()">Duety</button>
                </div>
             </div>

             <div class="flex justify-center gap-4 mb-6">
                 <select id="compare-p1" class="bg-gray-800 p-2 rounded text-sm w-1/3 border border-gray-600" onchange="Sound.click()"></select>
                 <span class="text-xl font-bold pt-1">VS</span>
                 <select id="compare-p2" class="bg-gray-800 p-2 rounded text-sm w-1/3 border border-gray-600" onchange="Sound.click()"></select>
                 <button id="run-compare-btn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold" onclick="Sound.click()">Por√≥wnaj</button>
             </div>
             <div id="compare-content" class="hidden grid grid-cols-3 gap-y-4 gap-x-2 text-center items-center text-sm"></div>
        </div>
    </div>

    <div id="post-match-modal" class="hidden">
        <div class="bg-gray-900 border border-gray-600 p-8 rounded-2xl max-w-md w-full text-center shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-2">Mecz Zapisany!</h2>
            <p class="text-gray-400 mb-6">Co chcesz zrobiƒá dalej?</p>
            <div class="flex flex-col gap-3">
                <button onclick="window.PostMatchMenu.rematch()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl uppercase tracking-wider">Rewan≈º (Te same sk≈Çady)</button>
                <button onclick="window.PostMatchMenu.newSquads()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl uppercase tracking-wider">Zmieniamy Sk≈Çady (Wyb√≥r)</button>
                <button onclick="window.PostMatchMenu.showStats()" class="bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded-xl uppercase tracking-wider border border-green-500">Zobacz Statystyki</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="hidden">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto m-4 shadow-2xl relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-white">CENTRUM STATYSTYK</h2>
                <div class="flex items-center gap-3">
                     <!-- TOGGLE SWITCH FOR HIDING <10 MATCHES -->
                     <label class="inline-flex items-center cursor-pointer mr-2">
                        <input type="checkbox" id="hide-low-matches-toggle" class="sr-only peer">
                        <div class="relative w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ms-2 text-[10px] font-medium text-gray-400 uppercase leading-none">Ukryj &lt;10 meczy</span>
                    </label>

                     <button onclick="window.Stats.openCompare()" class="text-xs bg-blue-600 hover:bg-blue-500 border border-blue-400 px-3 py-1 rounded text-white transition font-bold">Por√≥wnaj</button>
                     <button id="close-stats" class="text-gray-400 hover:text-white text-2xl font-bold p-2">&times;</button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button id="tab-rankings" class="stats-tab active bg-indigo-600 px-4 py-2 rounded text-sm font-bold" onclick="window.Stats.switchTab('rankings', this); Sound.click();">Rankingi</button>
                <button id="tab-duos" class="stats-tab bg-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-700" onclick="window.Stats.switchTab('duos', this); Sound.click();">Duety</button>
                <button id="tab-teams" class="stats-tab bg-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-700" onclick="window.Stats.switchTab('teams', this); Sound.click();">Zespo≈Çy</button>
                <button id="tab-players" class="stats-tab bg-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-700" onclick="window.Stats.switchTab('players', this); Sound.click();">Gracze</button>
                 <button id="tab-history" class="stats-tab bg-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-700" onclick="window.Stats.switchTab('history', this); Sound.click();">Historia Mecz√≥w</button>
            </div>
            
            <div id="ranking-type-container" class="mb-4">
                <select id="ranking-type-select" onchange="window.Stats.renderRankings(); Sound.click();" class="bg-gray-800 text-white p-2 rounded border border-gray-600 text-sm font-bold w-full md:w-auto">
                    <!-- Options populated via JS -->
                </select>
            </div>

            <div id="stats-content" class="min-h-[300px]"></div>
        </div>
    </div>

    <!-- VS OVERLAY -->
    <div id="vs-overlay">
        <div id="vs-left-panel" class="vs-panel bg-gray-900"><div class="vs-content" id="vs-content-left"></div></div>
        <div id="vs-right-panel" class="vs-panel bg-gray-800"><div class="vs-content" id="vs-content-right"></div></div>
        <div class="vs-badge-container"><div class="vs-circle"><div class="vs-text-inner">VS</div></div></div>
    </div>

    <!-- DATA & LOGIC -->
    <script id="team-data">
        window.teamsData = [
            { name: "Al Nassr", stars: 4, league: "Rest of World", id: 112139, logo: 'https://upload.wikimedia.org/wikipedia/en/c/c6/Al_Nassr_FC_Logo.svg', colors: {p: '#FEBE10', s: '#005CA9'} },
            { name: "Chelsea XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg', colors: {p: '#034694', s: '#FFFFFF'} },
            { name: "Bayern XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/1/1b/FC_Bayern_M%C3%BCnchen_logo_%282017%29.svg', colors: {p: '#DC052D', s: '#0066B2'} },
            { name: "Real Madrid XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg', colors: {p: '#FEBE10', s: '#00529F'} },
            { name: "Juventus XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Juventus_FC_logo_2017.svg/1200px-Juventus_FC_logo_2017.svg.png', colors: {p: '#000000', s: '#FFFFFF'} },
            { name: "LA LIGA XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/LaLiga_logo_2023.svg/1200px-LaLiga_logo_2023.svg.png', colors: {p: '#FF4B44', s: '#FFFFFF'} },
            { name: "LIGUE 1 XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Ligue_1_Uber_Eats_logo.svg/1200px-Ligue_1_Uber_Eats_logo.svg.png', colors: {p: '#DAE700', s: '#091C3E'} },
            { name: "Liverpool XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg', colors: {p: '#C8102E', s: '#F6EB61'} },
            { name: "Premier League XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/f/f2/Premier_League_Logo.svg', colors: {p: '#38003C', s: '#00FF85'} },
            { name: "Serie A XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/e/e9/Serie_A_logo_2022.svg', colors: {p: '#0054A6', s: '#FFFFFF'} },
            { name: "Soccer Aid", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Soccer_Aid_logo.svg/1200px-Soccer_Aid_logo.svg.png', colors: {p: '#1E90FF', s: '#FFFFFF'} },
            { name: "Zlatan FC", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/8/89/Flag_of_Sweden_%28bordered%29.svg', colors: {p: '#FFD700', s: '#0055A4'} },
            { name: "Klasyczna XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Soccerball_mask.svg/1200px-Soccerball_mask.svg.png', colors: {p: '#000000', s: '#FFFFFF'} },
            { name: "BUNDESLIGA XI", stars: 5, league: "Rest of World", logo: 'https://upload.wikimedia.org/wikipedia/en/d/df/Bundesliga_logo_%282017%29.svg', colors: {p: '#D3010C', s: '#FFFFFF'} },

            { name: "Arsenal", stars: 5, league: "Premier League", id: 1, logo: 'https://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg', colors: {p: '#EF0107', s: '#FFFFFF'} },
            { name: "Liverpool", stars: 5, league: "Premier League", id: 9, logo: 'https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg', colors: {p: '#C8102E', s: '#F6EB61'} },
            { name: "Manchester City", stars: 5, league: "Premier League", id: 10, logo: 'https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg', colors: {p: '#6CABDD', s: '#FFFFFF'} },
            { name: "Aston Villa", stars: 4.5, league: "Premier League", id: 2, logo: 'https://upload.wikimedia.org/wikipedia/en/9/9f/Aston_Villa_logo.svg', colors: {p: '#95BFE5', s: '#670E36'} },
            { name: "Chelsea", stars: 4.5, league: "Premier League", id: 5, logo: 'https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg', colors: {p: '#034694', s: '#FFFFFF'} },
            { name: "Manchester United", stars: 4.5, league: "Premier League", id: 11, logo: 'https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg', colors: {p: '#DA291C', s: '#FBE122'} },
            { name: "Newcastle United", stars: 4.5, league: "Premier League", id: 13, logo: 'https://upload.wikimedia.org/wikipedia/en/5/56/Newcastle_United_Logo.svg', colors: {p: '#241F20', s: '#FFFFFF'} },
            { name: "Nottingham Forest", stars: 4.5, league: "Premier League", id: 14, logo: 'https://upload.wikimedia.org/wikipedia/en/e/e5/Nottingham_Forest_F.C._logo.svg', colors: {p: '#E53233', s: '#FFFFFF'} },
            { name: "Tottenham Hotspur", stars: 4.5, league: "Premier League", id: 18, logo: 'https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg', colors: {p: '#132257', s: '#FFFFFF'} },
            { name: "Bournemouth", stars: 4, league: "Premier League", id: 1943, logo: 'https://upload.wikimedia.org/wikipedia/en/e/e5/AFC_Bournemouth_%282013%29.svg', colors: {p: '#DA291C', s: '#000000'} },
            { name: "Brentford", stars: 4, league: "Premier League", id: 1925, logo: 'https://upload.wikimedia.org/wikipedia/en/2/2a/Brentford_FC_crest.svg', colors: {p: '#E30613', s: '#FFFFFF'} },
            { name: "Brighton & Hove Albion", stars: 4, league: "Premier League", id: 1808, logo: 'https://upload.wikimedia.org/wikipedia/en/f/fd/Brighton_%26_Hove_Albion_logo.svg', colors: {p: '#0057B8', s: '#FFFFFF'} },
            { name: "Burnley", stars: 4, league: "Premier League", id: 1796, logo: 'https://upload.wikimedia.org/wikipedia/en/6/62/Burnley_F.C._Logo.svg', colors: { p: '#6C1D45', s: '#99D6EA' } },
            { name: "Crystal Palace", stars: 4, league: "Premier League", id: 1799, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a2/Crystal_Palace_FC_logo_%282022%29.svg', colors: {p: '#1B458F', s: '#C4122E'} },
            { name: "Everton", stars: 4, league: "Premier League", id: 7, logo: 'https://upload.wikimedia.org/wikipedia/en/7/7c/Everton_FC_logo.svg', colors: {p: '#003399', s: '#FFFFFF'} },
            { name: "Fulham", stars: 4, league: "Premier League", id: 144, logo: 'https://upload.wikimedia.org/wikipedia/en/e/eb/Fulham_FC_%28shield%29.svg', colors: {p: '#000000', s: '#FFFFFF'} },
            { name: "Leeds United", stars: 4, league: "Premier League", id: 8, logo: 'https://upload.wikimedia.org/wikipedia/en/5/54/Leeds_United_F.C._logo.svg', colors: { p: '#FFCD00', s: '#1D428A' } },
            { name: "Sunderland", stars: 4, league: "Premier League", id: 106, logo: 'https://upload.wikimedia.org/wikipedia/en/7/77/Logo_Sunderland.svg', colors: { p: '#EB172B', s: '#FFFFFF' } },
            { name: "West Ham United", stars: 4, league: "Premier League", id: 19, logo: 'https://upload.wikimedia.org/wikipedia/en/c/c2/West_Ham_United_FC_logo.svg', colors: {p: '#7A263A', s: '#1BB1E7'} },
            { name: "Wolves", stars: 4, league: "Premier League", id: 110, logo: 'https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg', colors: {p: '#FDB913', s: '#231F20'} },
            
            { name: "Paris Saint-Germain", stars: 5, league: "Ligue 1", id: 73, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a7/Paris_Saint-Germain_F.C..svg', colors: {p: '#004171', s: '#E30613'} },
            { name: "Olympique Marseille", stars: 4.5, league: "Ligue 1", id: 219, logo: 'https://upload.wikimedia.org/wikipedia/commons/d/d8/Olympique_Marseille_logo.svg', colors: {p: '#0098D7', s: '#FFFFFF'} },
            { name: "Lille OSC", stars: 4, league: "Ligue 1", id: 65, logo: 'https://upload.wikimedia.org/wikipedia/en/6/6f/Lille_OSC_2018_logo.svg', colors: {p: '#E01E13', s: '#004171'} },
            { name: "AS Monaco", stars: 4, league: "Ligue 1", id: 69, logo: 'https://upload.wikimedia.org/wikipedia/en/b/ba/AS_Monaco_FC.svg', colors: {p: '#E20513', s: '#FFFFFF'} },
            { name: "OGC Nice", stars: 4, league: "Ligue 1", id: 72, logo: 'https://upload.wikimedia.org/wikipedia/en/2/2e/OGC_Nice_logo.svg', colors: {p: '#E63323', s: '#000000'} },
            { name: "Olympique Lyonnais", stars: 4, league: "Ligue 1", id: 66, logo: 'https://upload.wikimedia.org/wikipedia/en/c/c6/Olympique_Lyonnais.svg', colors: {p: '#DA0D1A', s: '#0653A0'} },
            { name: "Strasbourg", stars: 4, league: "Ligue 1", id: 76, logo: 'https://upload.wikimedia.org/wikipedia/en/8/80/Racing_Club_de_Strasbourg_Alsace_logo.svg', colors: { p: '#0093D1', s: '#FFFFFF' } },
            { name: "Paris FC", stars: 4, league: "Ligue 1", id: 110555, logo: 'https://upload.wikimedia.org/wikipedia/en/8/86/Paris_FC_logo.svg', colors: { p: '#003A70', s: '#FFFFFF' } },
            { name: "Stade Rennais", stars: 3.5, league: "Ligue 1", id: 74, logo: 'https://upload.wikimedia.org/wikipedia/en/9/9e/Stade_Rennais_FC.svg', colors: {p: '#E40320', s: '#000000'} },
            { name: "RC Lens", stars: 3.5, league: "Ligue 1", id: 64, logo: 'https://upload.wikimedia.org/wikipedia/en/c/cc/RC_Lens_logo.svg', colors: {p: '#EC1C24', s: '#F8EC24'} },
            { name: "Stade Brestois", stars: 3.5, league: "Ligue 1", id: 378, logo: 'https://upload.wikimedia.org/wikipedia/en/0/05/Stade_Brestois_29_logo.svg', colors: {p: '#EE2033', s: '#FFFFFF'} },
            { name: "AJ Auxerre", stars: 3.5, league: "Ligue 1", id: 57, logo: 'https://upload.wikimedia.org/wikipedia/en/3/30/AJ_Auxerre.svg', colors: { p: '#006DBA', s: '#FFFFFF' } },
            { name: "FC Nantes", stars: 3.5, league: "Ligue 1", id: 71, logo: 'https://upload.wikimedia.org/wikipedia/en/2/2b/FC_Nantes_logo.svg', colors: { p: '#00A55D', s: '#FFF200' } },
            { name: "Toulouse FC", stars: 3.5, league: "Ligue 1", id: 1809, logo: 'https://upload.wikimedia.org/wikipedia/en/3/33/Toulouse_FC_Logo.svg', colors: { p: '#5A2D81', s: '#FFFFFF' } },
            { name: "Le Havre", stars: 3.5, league: "Ligue 1", id: 173, logo: 'https://upload.wikimedia.org/wikipedia/en/5/5f/Le_Havre_Athletic_Club_logo.svg', colors: { p: '#87CEFA', s: '#000080' } },
            { name: "Angers SCO", stars: 3, league: "Ligue 1", id: 1530, logo: 'https://upload.wikimedia.org/wikipedia/en/d/d4/Angers_SCO_logo.svg', colors: { p: '#000000', s: '#FFFFFF' } },
            { name: "FC Lorient", stars: 3, league: "Ligue 1", id: 217, logo: 'https://upload.wikimedia.org/wikipedia/en/0/02/FC_Lorient_logo.svg', colors: { p: '#F58220', s: '#231F20' } },
            { name: "FC Metz", stars: 2.5, league: "Ligue 1", id: 68, logo: 'https://upload.wikimedia.org/wikipedia/commons/4/4a/FC_Metz_2021_Logo.svg', colors: { p: '#8C172A', s: '#FFFFFF' } },
            
            { name: "FC Barcelona", stars: 5, league: "La Liga", id: 241, logo: 'https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg', colors: {p: '#A50044', s: '#004D98'} },
            { name: "Real Madrid", stars: 5, league: "La Liga", id: 243, logo: 'https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg', colors: {p: '#FEBE10', s: '#00529F'} },
            { name: "Athletic Bilbao", stars: 4.5, league: "La Liga", id: 448, logo: 'https://upload.wikimedia.org/wikipedia/en/9/98/Club_Athletic_Bilbao_logo.svg', colors: {p: '#E80000', s: '#FFFFFF'} },
            { name: "Atl√©tico Madrid", stars: 4.5, league: "La Liga", id: 240, logo: 'https://upload.wikimedia.org/wikipedia/en/f/f4/Atletico_Madrid_2017_logo.svg', colors: {p: '#D90000', s: '#FFFFFF'} },
            { name: "Real Betis", stars: 4.5, league: "La Liga", id: 449, logo: 'https://upload.wikimedia.org/wikipedia/en/1/13/Real_betis_logo.svg', colors: {p: '#00A750', s: '#FFFFFF'} },
            { name: "Osasuna", stars: 4, league: "La Liga", id: 479, logo: 'https://upload.wikimedia.org/wikipedia/en/d/db/Osasuna_logo.svg', colors: { p: '#C20000', s: '#003366' } },
            { name: "Celta Vigo", stars: 4, league: "La Liga", id: 450, logo: 'https://upload.wikimedia.org/wikipedia/en/1/12/RC_Celta_de_Vigo_logo.svg', colors: { p: '#87CEEB', s: '#FFFFFF' } },
            { name: "Girona FC", stars: 4, league: "La Liga", id: 110062, logo: 'https://upload.wikimedia.org/wikipedia/en/9/90/Girona_FC_Logo.svg', colors: {p: '#ED1C24', s: '#FFFFFF'} },
            { name: "Rayo Vallecano", stars: 4, league: "La Liga", id: 480, logo: 'https://upload.wikimedia.org/wikipedia/commons/a/a6/Rayo_Vallecano_logo.svg', colors: { p: '#FFFFFF', s: '#BE0000' } },
            { name: "RCD Mallorca", stars: 4, league: "La Liga", id: 453, logo: 'https://upload.wikimedia.org/wikipedia/en/e/e0/Rcd_mallorca.svg', colors: { p: '#E20613', s: '#000000'} },
            { name: "Real Sociedad", stars: 4, league: "La Liga", id: 457, logo: 'https://upload.wikimedia.org/wikipedia/en/f/f1/Real_Sociedad_logo.svg', colors: {p: '#0067B1', s: '#FFFFFF'} },
            { name: "Sevilla FC", stars: 4, league: "La Liga", id: 481, logo: 'https://upload.wikimedia.org/wikipedia/en/3/3b/Sevilla_FC_logo.svg', colors: {p: '#D41920', s: '#FFFFFF'} },
            { name: "Valencia CF", stars: 4, league: "La Liga", id: 461, logo: 'https://upload.wikimedia.org/wikipedia/en/c/ce/Valenciacf.svg', colors: {p: '#FF6600', s: '#000000'} },
            { name: "Villarreal CF", stars: 4, league: "La Liga", id: 483, logo: 'https://upload.wikimedia.org/wikipedia/en/7/70/Villarreal_CF_logo.svg', colors: {p: '#FDE500', s: '#004185'} },
            { name: "Deportivo Alav√©s", stars: 3.5, league: "La Liga", id: 463, logo: 'https://upload.wikimedia.org/wikipedia/en/2/2e/Deportivo_Alaves_logo.svg', colors: { p: '#0055A4', s: '#FFFFFF' } },
            { name: "Elche CF", stars: 3.5, league: "La Liga", id: 468, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a7/Elche_CF_logo.svg', colors: { p: '#007A33', s: '#FFFFFF' } },
            { name: "Getafe CF", stars: 3.5, league: "La Liga", id: 1860, logo: 'https://upload.wikimedia.org/wikipedia/en/4/4c/Getafe_CF.svg', colors: { p: '#0059A4', s: '#FFFFFF' } },
            { name: "Levante UD", stars: 3.5, league: "La Liga", id: 1853, logo: 'https://upload.wikimedia.org/wikipedia/en/7/7b/Levante_UD_logo.svg', colors: { p: '#B3003B', s: '#0058A3' } },
            { name: "RCD Espanyol", stars: 3.5, league: "La Liga", id: 452, logo: 'https://upload.wikimedia.org/wikipedia/en/d/d6/Rcd_espanyol_logo.svg', colors: { p: '#007DC5', s: '#FFFFFF' } },
            { name: "Real Oviedo", stars: 3.5, league: "La Liga", id: 1778, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a2/Real_Oviedo_logo.svg', colors: { p: '#0059A3', s: '#FFFFFF' } },
            
            { name: "Bayern Monachium", stars: 5, league: "Bundesliga", id: 21, logo: 'https://upload.wikimedia.org/wikipedia/commons/1/1b/FC_Bayern_M%C3%BCnchen_logo_%282017%29.svg', colors: {p: '#DC052D', s: '#0066B2'} },
            { name: "Bayer 04 Leverkusen", stars: 4.5, league: "Bundesliga", id: 32, logo: 'https://upload.wikimedia.org/wikipedia/en/5/59/Bayer_04_Leverkusen_logo.svg', colors: {p: '#E32119', s: '#000000'} },
            { name: "RB Leipzig", stars: 4.5, league: "Bundesliga", id: 112172, logo: 'https://upload.wikimedia.org/wikipedia/en/0/04/RB_Leipzig_2014_logo.svg', colors: {p: '#D40131', s: '#0033A1'} },
            { name: "Borussia Dortmund", stars: 4.5, league: "Bundesliga", id: 22, logo: 'https://upload.wikimedia.org/wikipedia/commons/6/67/Borussia_Dortmund_logo.svg', colors: {p: '#FDE100', s: '#000000'} },
            { name: "TSG Hoffenheim", stars: 4, league: "Bundesliga", id: 10029, logo: 'https://upload.wikimedia.org/wikipedia/commons/e/e7/Logo_TSG_Hoffenheim.svg', colors: { p: '#1C63B7', s: '#FFFFFF' } },
            { name: "VfB Stuttgart", stars: 4, league: "Bundesliga", id: 36, logo: 'https://upload.wikimedia.org/wikipedia/commons/e/eb/VfB_Stuttgart_1893_Logo.svg', colors: {p: '#E30613', s: '#FFFFFF'} },
            { name: "VfL Wolfsburg", stars: 4, league: "Bundesliga", id: 175, logo: 'https://upload.wikimedia.org/wikipedia/commons/f/f3/Logo-VfL-Wolfsburg.svg', colors: {p: '#008A4D', s: '#FFFFFF'} },
            { name: "Borussia M√∂nchengladbach", stars: 4, league: "Bundesliga", id: 23, logo: 'https://upload.wikimedia.org/wikipedia/commons/8/81/Borussia_M%C3%B6nchengladbach_logo.svg', colors: { p: '#00B44F', s: '#000000' } },
            { name: "SC Freiburg", stars: 4, league: "Bundesliga", id: 25, logo: 'https://upload.wikimedia.org/wikipedia/en/6/6d/SC_Freiburg_logo.svg', colors: { p: '#E10512', s: '#000000' } },
            { name: "Werder Bremen", stars: 4, league: "Bundesliga", id: 38, logo: 'https://upload.wikimedia.org/wikipedia/commons/b/be/SV-Werder-Bremen-Logo.svg', colors: { p: '#008A4D', s: '#FFFFFF' } },
            { name: "Hamburger SV", stars: 4, league: "Bundesliga", id: 28, logo: 'https://upload.wikimedia.org/wikipedia/commons/6/66/HSV-Logo.svg', colors: { p: '#005EA7', s: '#FFFFFF' } },
            { name: "Eintracht Frankfurt", stars: 4, league: "Bundesliga", id: 1824, logo: 'https://upload.wikimedia.org/wikipedia/commons/0/04/Eintracht_Frankfurt_Logo.svg', colors: {p: '#E1000F', s: '#000000'} },
            { name: "FC Augsburg", stars: 4, league: "Bundesliga", id: 100409, logo: 'https://upload.wikimedia.org/wikipedia/en/5/59/FC_Augsburg_logo.svg', colors: { p: '#BA1224', s: '#FFFFFF' } },
            { name: "Union Berlin", stars: 3.5, league: "Bundesliga", id: 1831, logo: 'https://upload.wikimedia.org/wikipedia/en/6/6c/1._FC_Union_Berlin_logo.svg', colors: { p: '#E53233', s: '#FBE122' } },
            { name: "1. FC Heidenheim", stars: 3.5, league: "Bundesliga", id: 111235, logo: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/1._FC_Heidenheim_1846.svg', colors: { p: '#E60020', s: '#0059A3' } },
            { name: "St. Pauli", stars: 3.5, league: "Bundesliga", id: 110329, logo: 'https://upload.wikimedia.org/wikipedia/en/0/02/FC_St._Pauli_logo.svg', colors: { p: '#8B4513', s: '#FFFFFF' } },
            { name: "1. FSV Mainz 05", stars: 3.5, league: "Bundesliga", id: 169, logo: 'https://upload.wikimedia.org/wikipedia/commons/9/9e/Logo_Mainz_05.svg', colors: { p: '#ED1C24', s: '#FFFFFF' } },
            { name: "1. FC K√∂ln", stars: 3.5, league: "Bundesliga", id: 31, logo: 'https://upload.wikimedia.org/wikipedia/en/5/53/FC_Cologne_logo.svg', colors: { p: '#ED1C24', s: '#FFFFFF' } },
            
            { name: "Inter Mediolan", stars: 5, league: "Serie A", id: 44, logo: 'https://upload.wikimedia.org/wikipedia/commons/0/05/FC_Internazionale_Milano_2021.svg', colors: {p: '#0068A8', s: '#000000'} },
            { name: "AC Milan", stars: 4.5, league: "Serie A", id: 47, logo: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Logo_of_AC_Milan.svg', colors: {p: '#FB090B', s: '#000000'} },
            { name: "AS Roma", stars: 4.5, league: "Serie A", id: 52, logo: 'https://upload.wikimedia.org/wikipedia/en/f/f7/AS_Roma_logo_%282017%29.svg', colors: {p: '#970A2C', s: '#FFC400'} },
            { name: "Atalanta BC", stars: 4.5, league: "Serie A", id: 39, logo: 'https://upload.wikimedia.org/wikipedia/en/6/66/AtalantaBC.svg', colors: {p: '#214488', s: '#000000'} },
            { name: "Juventus FC", stars: 4.5, league: "Serie A", id: 45, logo: 'https://upload.wikimedia.org/wikipedia/commons/b/bc/Juventus_FC_2017_icon_%28black%29.svg', colors: {p: '#000000', s: '#FFFFFF'} },
            { name: "Napoli", stars: 4.5, league: "Serie A", id: 48, logo: 'https://upload.wikimedia.org/wikipedia/commons/2/2d/SSC_Neapel.svg', colors: {p: '#12A0D7', s: '#FFFFFF'} },
            { name: "Lazio", stars: 4, league: "Serie A", id: 46, logo: 'https://upload.wikimedia.org/wikipedia/en/c/ce/S.S._Lazio_badge.svg', colors: {p: '#87CEEB', s: '#FFFFFF'} },
            { name: "Fiorentina", stars: 4, league: "Serie A", id: 110374, logo: 'https://upload.wikimedia.org/wikipedia/en/b/ba/ACF_Fiorentina_2.svg', colors: {p: '#482E92', s: '#FFFFFF'} },
            { name: "Bologna FC", stars: 4, league: "Serie A", id: 189, logo: 'https://upload.wikimedia.org/wikipedia/en/5/5b/Bologna_F.C._1909_logo.svg', colors: {p: '#9F1D35', s: '#1A2D4E'} },
            { name: "Como 1907", stars: 4, league: "Serie A", id: 112260, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a8/Como_1907_logo.svg', colors: { p: '#0D3C68', s: '#FFFFFF' } },
            { name: "Torino FC", stars: 4, league: "Serie A", id: 54, logo: 'https://upload.wikimedia.org/wikipedia/en/2/2e/Torino_FC_Logo.svg', colors: { p: '#8A1E23', s: '#FFFFFF' } },
            { name: "Cagliari Calcio", stars: 3.5, league: "Serie A", id: 1842, logo: 'https://upload.wikimedia.org/wikipedia/en/6/61/Cagliari_Calcio_1920.svg', colors: { p: '#002350', s: '#E11937' } },
            { name: "Cremonese", stars: 3.5, league: "Serie A", id: 111434, logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/8/87/US_Cremonese_logo.svg/1200px-US_Cremonese_logo.svg.png', colors: { p: '#AD192E', s: '#8A8D8F' } },
            { name: "Hellas Verona", stars: 3.5, league: "Serie A", id: 206, logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/9/98/Hellas_Verona_FC_logo.svg/1200px-Hellas_Verona_FC_logo.svg.png', colors: { p: '#002D62', s: '#FCDC04' } },
            { name: "Genoa CFC", stars: 3.5, league: "Serie A", id: 110556, logo: 'https://upload.wikimedia.org/wikipedia/en/6/6c/Genoa_C.F.C._logo.svg', colors: { p: '#D31229', s: '#002B5C' } },
            { name: "Lecce", stars: 3.5, league: "Serie A", id: 347, logo: 'https://upload.wikimedia.org/wikipedia/en/a/a2/U.S._Lecce_badge.svg', colors: { p: '#F5DD02', s: '#E40521' } },
            { name: "Parma Calcio 1913", stars: 3.5, league: "Serie A", id: 50, logo: 'https://upload.wikimedia.org/wikipedia/en/3/3d/Parma_Calcio_1913_logo.svg', colors: { p: '#002C6A', s: '#F5DD02' } },
            { name: "Sassuolo", stars: 3.5, league: "Serie A", id: 111974, logo: 'https://upload.wikimedia.org/wikipedia/en/1/1c/US_Sassuolo_Calcio_logo.svg', colors: { p: '#00A859', s: '#000000' } },
            { name: "Udinese Calcio", stars: 3.5, league: "Serie A", id: 55, logo: 'https://upload.wikimedia.org/wikipedia/en/c/ce/Udinese_Calcio_logo.svg', colors: { p: '#000000', s: '#FFFFFF' } },
            { name: "Pisa SC", stars: 3, league: "Serie A", id: 110745, logo: 'https://upload.wikimedia.org/wikipedia/en/e/e2/Pisa_Sporting_Club_logo.svg', colors: { p: '#000000', s: '#5499C7' } },
            
            { name: "Anglia", stars: 5, league: "National", flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', colors: {p: '#FFFFFF', s: '#CE1124'} },
            { name: "Argentyna", stars: 5, league: "National", flag: 'üá¶üá∑', colors: {p: '#75AADB', s: '#FFFFFF'} },
            { name: "Chorwacja", stars: 4.5, league: "National", flag: 'üá≠üá∑', colors: {p: '#FF0000', s: '#FFFFFF'} },
            { name: "Czechy", stars: 4, league: "National", flag: 'üá®üáø', colors: {p: '#ED112D', s: '#11457E'} },
            { name: "Dania", stars: 4, league: "National", flag: 'üá©üá∞', colors: {p: '#C60C30', s: '#FFFFFF'} },
            { name: "Finlandia", stars: 3.5, league: "National", flag: 'üá´üáÆ', colors: {p: '#FFFFFF', s: '#003580'} },
            { name: "Francja", stars: 5, league: "National", flag: 'üá´üá∑', colors: {p: '#002395', s: '#FFFFFF'} },
            { name: "Ghana", stars: 4, league: "National", flag: 'üá¨üá≠', colors: {p: '#FFFFFF', s: '#000000'} },
            { name: "Hiszpania", stars: 5, league: "National", flag: 'üá™üá∏', colors: {p: '#AA151B', s: '#F1BF00'} },
            { name: "Holandia", stars: 5, league: "National", flag: 'üá≥üá±', colors: {p: '#F36C21', s: '#FFFFFF'} },
            { name: "Irlandia", stars: 3.5, league: "National", flag: 'üáÆüá™', colors: {p: '#169B62', s: '#FFFFFF'} },
            { name: "Irlandia P√≥≈Çnocna", stars: 3, league: "National", logo: 'https://upload.wikimedia.org/wikipedia/commons/4/43/Flag_of_Northern_Ireland.svg', colors: {p: '#00983A', s: '#FFFFFF'} },
            { name: "Islandia", stars: 3.5, league: "National", flag: 'üáÆüá∏', colors: {p: '#02529C', s: '#DC1E35'} },
            { name: "Katar", stars: 3, league: "National", flag: 'üá∂üá¶', colors: {p: '#8A1538', s: '#FFFFFF'} },
            { name: "Maroko", stars: 4.5, league: "National", flag: 'üá≤üá¶', colors: {p: '#C1272D', s: '#006233'} },
            { name: "Meksyk", stars: 4, league: "National", flag: 'üá≤üáΩ', colors: {p: '#006847', s: '#CE1126'} },
            { name: "Niemcy", stars: 5, league: "National", flag: 'üá©üá™', colors: {p: '#FFFFFF', s: '#000000'} },
            { name: "Norwegia", stars: 4, league: "National", flag: 'üá≥üá¥', colors: {p: '#BA0C2F', s: '#00205B'} },
            { name: "Polska", stars: 4, league: "National", flag: 'üáµüá±', colors: {p: '#FFFFFF', s: '#DC143C'} },
            { name: "Portugalia", stars: 5, league: "National", flag: 'üáµüáπ', colors: {p: '#E42518', s: '#006600'} },
            { name: "Rumunia", stars: 3.5, league: "National", flag: 'üá∑üá¥', colors: {p: '#FCD116', s: '#002B7F'} },
            { name: "Szkocja", stars: 4, league: "National", flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', colors: {p: '#0065BF', s: '#FFFFFF'} },
            { name: "Szwecja", stars: 4, league: "National", flag: 'üá∏üá™', colors: {p: '#FECC00', s: '#006AA7'} },
            { name: "Ukraina", stars: 4, league: "National", flag: 'üá∫üá¶', colors: {p: '#FFD700', s: '#0057B8'} },
            { name: "USA", stars: 4, league: "National", flag: 'üá∫üá∏', colors: {p: '#FFFFFF', s: '#3C3B6E'} },
            { name: "Walia", stars: 3.5, league: "National", flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø', colors: {p: '#D30731', s: '#00AB39'} },
            { name: "Wƒôgry", stars: 3.5, league: "National", flag: 'üá≠üá∫', colors: {p: '#CE2939', s: '#477050'} },
            { name: "W≈Çochy", stars: 5, league: "National", flag: 'üáÆüáπ', colors: {p: '#0064AA', s: '#FFFFFF'} },
        ];
    </script>

    <script>
        window.Sound = {
            ctx: null,
            init() { 
                if (!this.ctx) { 
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
                } 
                if (this.ctx.state === 'suspended') { 
                    this.ctx.resume(); 
                } 
            },
            playOsc(freq, type, duration, vol=0.1) { 
                if(!this.ctx) this.init(); // Auto-init check
                const o = this.ctx.createOscillator(); 
                const g = this.ctx.createGain(); 
                o.type = type; 
                o.frequency.setValueAtTime(freq, this.ctx.currentTime); 
                g.gain.setValueAtTime(vol, this.ctx.currentTime); 
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration); 
                o.connect(g); 
                g.connect(this.ctx.destination); 
                o.start(); 
                o.stop(this.ctx.currentTime + duration); 
            },
            click() { this.playOsc(800, 'square', 0.05, 0.05); },
            tick() { this.playOsc(1200, 'square', 0.02, 0.08); },
            reroll() { this.playOsc(450, 'square', 0.08, 0.05); }, 
            confirm() { this.playOsc(500, 'square', 0.1, 0.1); setTimeout(() => this.playOsc(750, 'square', 0.15, 0.1), 50); },
            clash() { this.playOsc(150, 'sawtooth', 0.8, 0.3); },
            whistle() { this.init(); const now = this.ctx.currentTime; const osc1 = this.ctx.createOscillator(); const osc2 = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const modOsc = this.ctx.createOscillator(); const modGain = this.ctx.createGain(); const baseFreq = 2800; osc1.type = 'sine'; osc2.type = 'sine'; osc1.frequency.setValueAtTime(baseFreq, now); osc2.frequency.setValueAtTime(baseFreq + 50, now); modOsc.type = 'square'; modOsc.frequency.setValueAtTime(45, now); modGain.gain.setValueAtTime(600, now); modOsc.connect(modGain); modGain.connect(osc1.frequency); modGain.connect(osc2.frequency); osc1.connect(gain); osc2.connect(gain); gain.connect(this.ctx.destination); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.05); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6); osc1.start(now); osc2.start(now); modOsc.start(now); osc1.stop(now + 0.6); osc2.stop(now + 0.6); modOsc.stop(now + 0.6); },
            goal() { this.playOsc(200, 'triangle', 0.1, 0.4); setTimeout(() => this.playOsc(150, 'triangle', 0.2, 0.3), 50); },
            fanfare() { const melody = [523.25, 659.25, 783.99, 1046.50]; melody.forEach((f,i) => setTimeout(() => this.playOsc(f, 'triangle', 0.4, 0.2), i*120)); },
    penaltyMiss() { this.playOsc(150, 'sawtooth', 0.2, 0.2); setTimeout(() => this.playOsc(100, 'sawtooth', 0.2, 0.1), 100); },
    penaltyGoal() { this.playOsc(1000, 'triangle', 0.1, 0.15); setTimeout(() => this.playOsc(1500, 'triangle', 0.1, 0.15), 50); },
    finalWhistle() { this.whistle(); setTimeout(() => this.whistle(), 400); setTimeout(() => this.whistle(), 800); }
};
    </script>
    
    <script type="module" id="app-logic">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
// ZastƒÖp starƒÖ liniƒô z "firebase-auth.js" tƒÖ poni≈ºszƒÖ:
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    sendPasswordResetEmail,
    signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Global abort controller
        window.abortController = { aborted: false };
        const resetMatchUI = () => {
    ['team1-panel', 'team2-panel'].forEach(id => {
        const el = document.getElementById(id);
        el.className = 'fut-card-empty rounded-3xl p-4 relative transition-all duration-500 flex flex-grow flex-col items-center justify-center overflow-hidden h-full';
        el.style.background = '';
        el.innerHTML = '<div class="text-center w-full z-10 flex flex-col items-center justify-center h-full"><div class="animate-pulse text-6xl md:text-8xl opacity-20">‚öΩ</div></div>';
    });
    document.getElementById('draw-teams-btn').classList.remove('hidden', 'opacity-50');
    document.getElementById('draw-teams-btn').disabled = false;
    document.getElementById('team1-actions').classList.add('hidden');
    document.getElementById('team1-actions').classList.remove('invisible');
    document.getElementById('team2-actions').classList.add('hidden');
    document.getElementById('team2-actions').classList.remove('invisible');
    document.getElementById('results-container').classList.add('hidden');
    document.getElementById('abort-draw-btn').classList.add('hidden');
    document.getElementById('manual-btn-1').classList.remove('hidden');
    document.getElementById('manual-btn-2').classList.remove('hidden');
};

        // --- CACHED DATA STORE (Sync with Firebase) ---
        const Store = {
            players: ['Gracz 1', 'Gracz 2'],
            matches: [],
            session: [],
            state: null,
            meta: {}, 
            loaded: { players: false, matches: false, session: false, state: false, meta: false }
        };

        const DataManager = {
            db: null,
            auth: null,
            userId: null,
            appId: null,

            async init() {
                // KONFIGURACJA FIREBASE - WKLEJ SWOJE DANE TUTAJ
                const firebaseConfig = {
  apiKey: "AIzaSyD3VlQ-SN6I0UegIuV2a0t-_GHeooJOyKI",
  authDomain: "fc26-manager.firebaseapp.com",
  databaseURL: "https://fc26-manager-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fc26-manager",
  storageBucket: "fc26-manager.firebasestorage.app",
  messagingSenderId: "187980979634",
  appId: "1:187980979634:web:2de8bb00079bca2c0b98ab"
};

                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
                
                // Sta≈Ça nazwa Twojej aplikacji w bazie danych
                this.appId = 'fc26-manager-production';

                // Usuniƒôto logikƒô __initial_auth_token (jest tylko dla ≈õrodowiska testowego AI)

                onAuthStateChanged(this.auth, (user) => {
    if (user) {
        // Sprawdzamy czy to go≈õƒá (isAnonymous) LUB czy email jest potwierdzony
        if (user.isAnonymous || user.emailVerified) {
            this.userId = user.uid;
            
            // Ukryj ekran logowania
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Poka≈º info w pasku bocznym
            const emailLabel = document.getElementById('sb-user-email');
            const statusLabel = document.getElementById('sb-user-status');
            if(emailLabel) emailLabel.innerText = user.isAnonymous ? "Konto Go≈õcia" : user.email;
            if(statusLabel) statusLabel.innerText = user.isAnonymous ? "Niezapisane w chmurze" : "Zweryfikowany";

            this.setupListeners();
        } else {
            // U≈ºytkownik jest zalogowany, ale nie potwierdzi≈Ç emaila -> Wyloguj go w tle lub nie wpuszczaj
            // Tutaj AuthManager.login() ju≈º obs≈Çu≈ºy≈Ç komunikat b≈Çƒôdu, wiƒôc nic nie robimy
        }
    } else {
        // Brak u≈ºytkownika - poka≈º ekran logowania
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
    }
});
            },
             setupListeners() {
                if (!this.userId) return;
                const dataCol = collection(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data');

                onSnapshot(doc(dataCol, 'players'), (docSnap) => {
                    if (docSnap.exists()) {
                        Store.players = docSnap.data().list || [];
                    } else {
                        this.savePlayers(['Gracz 1', 'Gracz 2']);
                    }
                    Store.loaded.players = true;
                    this.checkLoaded();
                    if(PlayerManager.renderPool) PlayerManager.renderPool();
                });

                onSnapshot(doc(dataCol, 'matches'), (docSnap) => {
                    if (docSnap.exists()) {
                        Store.matches = docSnap.data().history || [];
                    }
                    Store.loaded.matches = true;
                    this.checkLoaded();
                    // If modal is open, refresh logic
                    if(!document.getElementById('stats-modal').classList.contains('hidden') && window.Stats.activeTab === 'history') {
                        window.Stats.switchTab('history');
                    }
                });

                onSnapshot(doc(dataCol, 'session'), (docSnap) => {
                    if (docSnap.exists()) {
                        Store.session = docSnap.data().used || [];
                    }
                    Store.loaded.session = true;
                    this.checkLoaded();
                    AppState.usedTeams = Store.session;
                    const el = document.getElementById('session-info');
                    if(el) el.innerText = `Dru≈ºyny u≈ºyte w sesji: ${Store.session.length}`;
                });

                 onSnapshot(doc(dataCol, 'state'), (docSnap) => {
                    if (docSnap.exists()) {
                        Store.state = docSnap.data();
                        if(PlayerManager.loadState) PlayerManager.loadState(); 
                    }
                    Store.loaded.state = true;
                    this.checkLoaded();
                });
                
                onSnapshot(doc(dataCol, 'player_meta'), (docSnap) => {
                    if (docSnap.exists()) {
                        Store.meta = docSnap.data();
                    } else {
                        Store.meta = {};
                    }
                    Store.loaded.meta = true;
                    this.checkLoaded();
                });
            },

            checkLoaded() {
                if(Store.loaded.players && Store.loaded.matches && Store.loaded.session && Store.loaded.state && Store.loaded.meta) {
                     const loader = document.getElementById('loading-screen');
                     if(loader) {
                         loader.style.opacity = 0;
                         setTimeout(() => { 
                             loader.style.display = 'none'; 
                             document.getElementById('app-container').classList.remove('hidden');
                             PlayerManager.init(); 
                             MatchRecorder.init();
                             Stats.init(); 
                             MatchEditor.init();
                             AvatarEditor.init();
                         }, 500);
                     }
                }
            },

            getPlayers() { return Store.players; },
            getMeta() { return Store.meta; },
            async savePlayers(players) { if(!this.userId) return; Store.players = players; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'players'), { list: players }); this.showToast("Zapisano graczy!"); },
            async saveMeta(meta) { if(!this.userId) return; Store.meta = meta; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'player_meta'), meta); this.showToast("Zapisano awatar!"); },
            getMatches() { return Store.matches; },
            async saveMatch(match) { if(!this.userId) { this.showToast("B≈ÇƒÖd: Brak autoryzacji.", 'error'); return false; } const newHistory = [...Store.matches, match]; Store.matches = newHistory; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'matches'), JSON.parse(JSON.stringify({ history: newHistory }))); this.showToast("Zapisano mecz!"); return true; },
            async updateMatchHistory(newHistory) {
                 if (!this.userId) return;
                 Store.matches = newHistory;
                 await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'matches'), JSON.parse(JSON.stringify({ history: newHistory })));
                 this.showToast("Zaktualizowano historiƒô.");
            },
            async clearHistory() { if(!this.userId) return; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'matches'), { history: [] }); location.reload(); },
            async deleteMatch(id) {
                if (!this.userId) return;
                const newHistory = Store.matches.filter(m => m.id !== id);
                await this.updateMatchHistory(newHistory);
                window.Stats.switchTab('history'); // Refresh history tab
            },
            getSessionUsedTeams() { return Store.session; },
            async addToSession(teamName) { if(!this.userId) return; if(!Store.session.includes(teamName)) { const newSession = [...Store.session, teamName]; Store.session = newSession; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'session'), { used: newSession }); } },
            async resetSession() { if(!this.userId) return; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'session'), { used: [] }); this.showToast("Czarna lista dru≈ºyn zresetowana!"); },
            getState() { return Store.state; },
            async saveState(state) { if(!this.userId) return; Store.state = state; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'state'), state); },
            
            async hardReset() { 
                if(!this.userId) return; 
                document.getElementById('settings-modal').classList.add('hidden'); 
                const modal = document.getElementById('confirm-reset-modal');
                modal.classList.remove('hidden');

                const confirmAction = document.getElementById('confirm-reset-action');
                const cancelAction = document.getElementById('cancel-reset-action');

                const cleanUp = () => {
                    modal.classList.add('hidden');
                    confirmAction.onclick = null;
                    cancelAction.onclick = null;
                };

                confirmAction.onclick = async () => {
                    Sound.click();
                    confirmAction.innerText = "RESETOWANIE...";
                    confirmAction.disabled = true;
                    
                    try {
                        await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'players'), { list: ['Gracz 1', 'Gracz 2'] });
                        await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'matches'), { history: [] });
                        await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'session'), { used: [] });
                        await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'state'), {}); 
                        await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.userId, 'fc26_data', 'player_meta'), {});
                        
                        DataManager.showToast("Pe≈Çny Reset Zako≈Ñczony!");
                        cleanUp();
                        setTimeout(() => location.reload(), 1500);
                    } catch (error) {
                        console.error("B≈ÇƒÖd podczas twardego resetu:", error);
                        DataManager.showToast("B≈ÇƒÖd resetu! Sprawd≈∫ konsolƒô.", 'error');
                        confirmAction.innerText = "Tak, Resetuj!";
                        confirmAction.disabled = false;
                        cleanUp();
                    }
                };
                
                cancelAction.onclick = () => { Sound.click(); cleanUp(); };
            },
            
            showToast(message, type = 'success') { const t = document.getElementById('toast-notification'); t.querySelector('span').innerText = message; t.classList.remove('bg-green-600/90', 'border-green-400', 'bg-red-600/90', 'border-red-400'); if (type === 'error') { t.style.background = 'rgba(239, 68, 68, 0.9)'; t.style.borderColor = '#FCA5A5'; } else { t.style.background = 'rgba(16, 185, 129, 0.9)'; t.style.borderColor = '#34d399'; } t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        };

        DataManager.init();

        const AppState = { finalTeam1: null, finalTeam2: null, playersTeam1: [], playersTeam2: [], minStars: 2.5, maxStars: 5, rerolls: { p1: 3, p2: 3 }, rerollSettings: 3, selectedLeague: "All", recordingGoals: { t1: [], t2: [] }, usedTeams: [], drawSelection: [] };

// --- LOGIKA LOGOWANIA (MOCK) ---
        window.AuthManager = {
    // Prze≈ÇƒÖczanie widok√≥w w okienku
    switchForm(formName) {
        ['login', 'register', 'reset'].forEach(f => {
            const el = document.getElementById(f + '-form');
            if(el) el.classList.add('hidden');
        });
        document.getElementById(formName + '-form').classList.remove('hidden');
        Sound.click();
    },

    // 1. Logowanie Email/Has≈Ço
    async login() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        
        if(!email || !pass) {
            DataManager.showToast("Podaj email i has≈Ço", "error");
            return;
        }

        try {
            const userCredential = await signInWithEmailAndPassword(DataManager.auth, email, pass);
            const user = userCredential.user;

            if (!user.emailVerified) {
                DataManager.showToast("Potwierd≈∫ email przed zalogowaniem!", "error");
                await signOut(DataManager.auth);
                return;
            }
            // Sukces obs≈Çu≈ºy onAuthStateChanged w DataManagerze
            
        } catch (error) {
            console.error(error);
            let msg = "B≈ÇƒÖd logowania.";
            if (error.code === 'auth/invalid-credential') msg = "B≈Çƒôdny email lub has≈Ço.";
            if (error.code === 'auth/too-many-requests') msg = "Konto tymczasowo zablokowane. Spr√≥buj p√≥≈∫niej.";
            DataManager.showToast(msg, "error");
        }
    },

    // 2. Rejestracja
    async register() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;

        if (pass.length < 6) {
            DataManager.showToast("Has≈Ço musi mieƒá min. 6 znak√≥w", "error");
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(DataManager.auth, email, pass);
            await sendEmailVerification(userCredential.user);
            
            DataManager.showToast("Konto utworzone! Sprawd≈∫ email i kliknij link.");
            await signOut(DataManager.auth); // Wyloguj, ≈ºeby wymusiƒá ponowne logowanie po weryfikacji
            this.switchForm('login');
            
        } catch (error) {
            let msg = "B≈ÇƒÖd rejestracji.";
            if (error.code === 'auth/email-already-in-use') msg = "Ten email jest ju≈º zajƒôty.";
            if (error.code === 'auth/invalid-email') msg = "Nieprawid≈Çowy format emaila.";
            DataManager.showToast(msg, "error");
        }
    },

    // 3. Logowanie jako Go≈õƒá
    async guestLogin() {
        try {
            await signInAnonymously(DataManager.auth);
            DataManager.showToast("Zalogowano jako Go≈õƒá");
        } catch (error) {
            DataManager.showToast("B≈ÇƒÖd logowania go≈õcia", "error");
        }
    },

    // 4. Reset Has≈Ça
    async resetPassword() {
        const email = document.getElementById('reset-email-input').value;
        if (!email) {
            DataManager.showToast("Podaj email.", "error");
            return;
        }

        try {
            await sendPasswordResetEmail(DataManager.auth, email);
            DataManager.showToast("Link wys≈Çany! Sprawd≈∫ skrzynkƒô.");
            this.switchForm('login');
        } catch (error) {
            DataManager.showToast("B≈ÇƒÖd. Sprawd≈∫ czy email jest poprawny.", "error");
        }
    },

    logout() {
        signOut(DataManager.auth).then(() => {
            location.reload();
        });
    }
};

        // --- LOGIKA PANELU BOCZNEGO ---
        window.Sidebar = {
            open() {
                document.getElementById('sidebar').classList.remove('-translate-x-full');
                const overlay = document.getElementById('sidebar-overlay');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
                Sound.click();
            },
            close() {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                const overlay = document.getElementById('sidebar-overlay');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },
            openProfile() {
                this.close();
                const matches = DataManager.getMatches();
                const totalMinutes = matches.length * 20;
                const hours = (totalMinutes / 60).toFixed(1);
                const books = (totalMinutes / 240).toFixed(1); // Zak≈Çadamy 4h na ksiƒÖ≈ºkƒô

                const content = `
    <div class="text-center p-4">
        <h2 class="text-2xl font-black mb-6 text-[#07f468]">Profil Managera</h2>
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Czas gry:</div>
                <div class="text-2xl font-black text-white">${hours} h</div>
            </div>
            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Rozegrane mecze:</div>
                <div class="text-2xl font-black text-white">${matches.length}</div>
            </div>
        </div>

        <div class="bg-yellow-900/10 p-4 rounded-2xl border border-yellow-500/20 mb-6">
            <div class="text-[10px] text-yellow-500 font-bold italic">
                To tyle, co przeczytanie ok. <span class="text-white underline">${books}</span> ksiƒÖ≈ºek. 
                Statystyki nie k≈ÇamiƒÖ!
            </div>
        </div>

        <div class="space-y-3">
            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                <h3 class="text-gray-400 text-[10px] font-bold uppercase mb-3">ZarzƒÖdzanie danymi</h3>
                <div class="flex flex-col gap-2">
                    <button onclick="window.Settings.copyToClipboard()" class="w-full bg-indigo-600 p-2.5 rounded-lg text-[10px] font-bold uppercase">Kopiuj kopie (JSON)</button>
                    <button onclick="document.getElementById('profile-import-area').classList.toggle('hidden')" class="w-full bg-gray-700 p-2.5 rounded-lg text-[10px] font-bold uppercase">Wczytaj dane</button>
                </div>
                
                <div id="profile-import-area" class="hidden mt-3">
                    <textarea id="data-textarea-profile" placeholder="Wklej tutaj kod JSON..." class="w-full h-24 bg-black text-green-400 text-[10px] font-mono p-2 rounded border border-gray-700 mb-2"></textarea>
                    <button onclick="window.Settings.loadFromTextarea('data-textarea-profile')" class="w-full bg-green-700 py-2 rounded text-[10px] font-bold uppercase">Zatwierd≈∫ import</button>
                </div>
            </div>

            <button onclick="window.DataManager.hardReset()" class="w-full bg-red-900/30 text-red-400 p-3 rounded-xl text-xs font-bold uppercase border border-red-500/20">Usu≈Ñ wszystkie dane</button>
        </div>
    </div>
`;
                document.getElementById('player-profile-content').innerHTML = content;
                document.getElementById('player-profile-modal').classList.remove('hidden');
                Sound.click();
            }
        };
        
        function stringToHslColor(str, s, l) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } const h = hash % 360; return `hsl(${h}, ${s}%, ${l}%)`; }
        function getLeagueLogoHTML(name) { const colors = { 'Premier League': 'bg-purple-900 text-purple-200 border-purple-500', 'La Liga': 'bg-orange-900 text-orange-200 border-orange-500', 'Bundesliga': 'bg-red-900 text-red-200 border-red-500', 'Serie A': 'bg-blue-900 text-blue-200 border-blue-500', 'Ligue 1': 'bg-lime-900 text-lime-200 border-lime-500', 'Saudi Pro League': 'bg-green-900 text-green-200 border-green-500', 'National': 'bg-gray-700 text-white border-white', 'Clubs': 'bg-indigo-900 text-indigo-200 border-indigo-500', 'Rest of World': 'bg-yellow-900 text-yellow-200 border-yellow-500' }; const mapName = { 'National': 'Reprezentacje', 'Clubs': 'Kluby', 'Saudi Pro League': 'Saudi League', 'Rest of World': 'Reszta ≈öwiata' }; const displayName = mapName[name] || name; const baseStyle = "text-[10px] px-2 py-0.5 rounded-md font-bold uppercase border mt-2 inline-block shadow-sm tracking-wider";
const cls = `${colors[name] || 'bg-gray-800 text-gray-400 border-gray-600'} ${baseStyle}`; return `<div class="league-badge ${cls}">${displayName}</div>`; }
        
        function getTeamLogoUrl(t) { 
            if (t.id) return `https://cdn.sofifa.net/teams/${t.id}/360.png`;
            if (t.logo) return t.logo;
            return null; 
        }

        window.handleImgError = (img) => { 
            const d = JSON.parse(img.getAttribute('data-team')); 
            const currentSrc = img.src;
            const fallbackSrc = d.logo;
            if (fallbackSrc && currentSrc !== fallbackSrc && !img.hasAttribute('data-fallback-tried')) {
                img.setAttribute('data-fallback-tried', 'true');
                img.src = fallbackSrc;
                return;
            }
            const isBig = img.classList.contains('vs-crest-img');
            const sizeClass = isBig ? 'w-32 h-32 md:w-48 md:h-48' : 'w-20 h-20 md:w-32 md:h-32';
            const initials = (d.name.match(/\b\w/g) || [d.name[0]]).join('').substring(0,2).toUpperCase();
            const wrapper = document.createElement('div');
            wrapper.className = `${sizeClass} flex items-center justify-center mx-auto mb-2 shrink-0 animate-pop bg-gray-800 rounded-full border-2 border-white/20`;
            wrapper.innerHTML = `<span class="text-3xl font-black text-gray-500">${initials}</span>`;
            img.parentNode.replaceChild(wrapper, img);
        };
        
        function preloadImage(url) {
            if (!url) return;
            const img = new Image();
            img.src = url;
        }

        function getRarityClass(team) {
            const specials = ["Real Madrid", "Francja", "Chelsea XI", "Bayern XI", "Real Madrid XI", "Juventus XI", "LA LIGA XI", "LIGUE 1 XI", "Liverpool XI", "Premier League XI", "Serie A XI", "Soccer Aid", "Zlatan FC", "Klasyczna XI", "BUNDESLIGA XI"];
            if (specials.includes(team.name)) return "rarity-special";
            if (team.stars === 5) return "rarity-legendary";
            if (team.stars === 4.5) return "rarity-epic";
            if (team.stars === 4) return "rarity-rare";
            return "rarity-common";
        }

        const Settings = {
    init() {
        // Ta funkcja mo≈ºe teraz zostaƒá pusta lub mo≈ºesz jƒÖ usunƒÖƒá, 
        // bo wywo≈Çujemy funkcje bezpo≈õrednio
    },
    async copyToClipboard() {
        Sound.click();
        const exportData = JSON.stringify({ 
            players: DataManager.getPlayers(), 
            matches: DataManager.getMatches(), 
            session: DataManager.getSessionUsedTeams(), 
            meta: DataManager.getMeta() 
        });
        try {
            await navigator.clipboard.writeText(exportData);
            DataManager.showToast("Skopiowano do schowka!");
        } catch (err) {
            DataManager.showToast("B≈ÇƒÖd kopiowania", 'error');
        }
    },
    async loadFromTextarea(id) {
        Sound.click();
        const val = document.getElementById(id).value;
        try {
            const data = JSON.parse(val);
            if(data.players) await DataManager.savePlayers(data.players); 
            // ... reszta logiki importu kt√≥rƒÖ mia≈Çe≈õ wcze≈õniej ...
            DataManager.showToast("Dane zaimportowane!");
            setTimeout(() => location.reload(), 1000);
        } catch(e) {
            DataManager.showToast("B≈Çƒôdny format JSON!", 'error');
        }
    }
};

        const AvatarEditor = {
            currentPlayer: null,
            init() {
                document.getElementById('save-avatar-btn').onclick = () => this.save();
                const emojiInput = document.getElementById('avatar-emoji-input');
                const colorInput = document.getElementById('avatar-color-input');
                
                emojiInput.addEventListener('input', () => this.updatePreview());
                colorInput.addEventListener('input', () => this.updatePreview());
            },
            open(playerName) {
                Sound.click();
                this.currentPlayer = playerName;
                const modal = document.getElementById('avatar-modal');
                const meta = DataManager.getMeta()[playerName] || {};
                
                // Defaults
                const defaultColor = stringToHslColor(playerName, 70, 50);
                
                document.getElementById('avatar-emoji-input').value = meta.emoji || '';
                document.getElementById('avatar-color-input').value = meta.color || '#333333'; 
                
                // Trigger preview update immediately
                this.updatePreview();
                modal.classList.remove('hidden');
            },
            updatePreview() {
                const preview = document.getElementById('avatar-preview-circle');
                const emoji = document.getElementById('avatar-emoji-input').value;
                const color = document.getElementById('avatar-color-input').value;
                
                preview.style.backgroundColor = color;
                preview.innerHTML = emoji || this.currentPlayer.substring(0,2).toUpperCase();
            },
            async save() {
                const emoji = document.getElementById('avatar-emoji-input').value;
                const color = document.getElementById('avatar-color-input').value;
                
                const meta = DataManager.getMeta();
                meta[this.currentPlayer] = { emoji, color };
                
                await DataManager.saveMeta(meta);
                document.getElementById('avatar-modal').classList.add('hidden');
                
                if (!document.getElementById('player-profile-modal').classList.contains('hidden')) {
                    Stats.openProfile(this.currentPlayer);
                }
            }
        };

        const MatchRecorder = {
            init() {
                document.getElementById('save-match-btn').onclick=()=>this.openModal();
                document.getElementById('cancel-recording').onclick=()=>document.getElementById('recording-modal').classList.add('hidden');
                document.getElementById('close-recording-x').onclick=()=>document.getElementById('recording-modal').classList.add('hidden');
                document.getElementById('confirm-recording').onclick=()=>this.save();
                document.getElementById('wizard-cancel').onclick=()=>this.closeWizard();
                
                document.getElementById('toggle-history-btn').onclick = () => {
                    const list = document.getElementById('goal-history-wrapper');
                    list.classList.toggle('hidden');
                    Sound.click();
                };
            },
            openModal() {
                document.getElementById('recording-modal').classList.remove('hidden');
                document.getElementById('goal-history-wrapper').classList.add('hidden'); 
                document.getElementById('modal-t1-name').innerText=`${AppState.finalTeam1.name}`;
                document.getElementById('modal-t2-name').innerText=`${AppState.finalTeam2.name}`;
                this.renderAll();
            },
            wizardData: {},
            addGoal(tid) { this.wizardData = { team: tid, scorer: '', assist: 'Brak', method: '' }; document.getElementById('goal-wizard-modal').classList.remove('hidden'); this.wizardStep1_Method(); },
            closeWizard() { document.getElementById('goal-wizard-modal').classList.add('hidden'); },
            renderWizardButtons(title, items, callback) { document.getElementById('wizard-title').innerText = title; const c = document.getElementById('wizard-buttons'); c.innerHTML = ''; items.forEach(item => { const btn = document.createElement('button'); btn.className = 'wizard-btn'; btn.innerHTML = item.html || item.label; if(item.color) btn.style.borderColor = item.color; btn.onclick = () => { Sound.click(); callback(item.value); }; c.appendChild(btn); }); },
            wizardStep1_Method() { const methods = [ { label: 'Z Pola Karnego (1pkt)', value: 'Z pola karnego', html: '<span class="text-2xl">‚öΩ</span> Z Pola' }, { label: 'Z Dystansu (2pkt)', value: 'Z dystansu', html: '<span class="text-2xl">üöÄ</span> Z Dystansu' }, { label: 'Rzut Karny (1pkt)', value: 'Rzut Karny', html: '<span class="text-2xl">ü•Ö</span> Karny' }, { label: 'Rzut Wolny (2pkt)', value: 'Rzut Wolny', html: '<span class="text-2xl">üéØ</span> Wolny' }, { label: 'Samob√≥j', value: 'Samob√≥j', html: '<span class="text-2xl">ü§°</span> Samob√≥j', color: '#ef4444' } ]; this.renderWizardButtons("Wybierz Typ Gola", methods, (val) => { this.wizardData.method = val; if(val === 'Samob√≥j') { this.wizardData.scorer = 'Samob√≥j'; this.wizardData.assist = 'Brak'; this.finalizeWizard(); } else { this.wizardStep2_Scorer(); } }); },
            wizardStep2_Scorer() { const players = this.wizardData.team === 1 ? AppState.playersTeam1 : AppState.playersTeam2; const items = players.map(p => ({ label: p, value: p, html: `<span class="text-lg font-bold">${p}</span>` })); this.renderWizardButtons("Kto Strzeli≈Ç?", items, (val) => { this.wizardData.scorer = val; if (['Rzut Karny', 'Rzut Wolny'].includes(this.wizardData.method) || players.length === 1) { this.wizardData.assist = 'Brak'; this.finalizeWizard(); } else { this.wizardStep3_Assist(); } }); },
            wizardStep3_Assist() { const players = this.wizardData.team === 1 ? AppState.playersTeam1 : AppState.playersTeam2; const teammates = players.filter(p => p !== this.wizardData.scorer); const items = [ { label: 'BRAK ASYSTY', value: 'Brak', html: '<span class="text-gray-400">BRAK ASYSTY</span>' }, ...teammates.map(p => ({ label: p, value: p, html: `<span class="text-lg font-bold text-blue-300">${p}</span>` })) ]; this.renderWizardButtons("Kto Asystowa≈Ç?", items, (val) => { this.wizardData.assist = val; this.finalizeWizard(); }); },
            finalizeWizard() { const g = { id: Date.now() + Math.random(), team: this.wizardData.team, scorer: this.wizardData.scorer, assist: this.wizardData.assist, method: this.wizardData.method }; if(this.wizardData.team === 1) AppState.recordingGoals.t1.push(g); else AppState.recordingGoals.t2.push(g); this.closeWizard(); this.renderAll(); Sound.goal(); },
            removeGoal(tid,gid) { Sound.click(); if(tid===1)AppState.recordingGoals.t1=AppState.recordingGoals.t1.filter(g=>g.id!==gid); else AppState.recordingGoals.t2=AppState.recordingGoals.t2.filter(g=>g.id!==gid); this.renderAll(); },
            updateGoal(tid,gid,f,v) { 
                Sound.click();
                const l=tid===1?AppState.recordingGoals.t1:AppState.recordingGoals.t2; 
                const g=l.find(x=>x.id===gid); 
                if(g){ 
                    g[f]=v; 
                    if(f==='method'&&(v==='Samob√≥j'||v==='Rzut Karny'||v==='Rzut Wolny'))g.assist='Brak'; 
                    if(f==='scorer'&&v==='Samob√≥j'){g.method='Samob√≥j';g.assist='Brak';} 
                    if(f==='scorer'&&g.assist===v)g.assist='Brak'; 
                    this.renderAll(); 
                } 
            },
            calc(tid) { return (tid===1?AppState.recordingGoals.t1:AppState.recordingGoals.t2).reduce((a,b)=>a+(b.method==='Z dystansu'||b.method==='Rzut Wolny'?2:1),0); },
            renderAll() {
                const c=document.getElementById('goal-details-container'); c.innerHTML='';
                const all=[...AppState.recordingGoals.t1.map(g=>({...g,_t:1})),...AppState.recordingGoals.t2.map(g=>({...g,_t:2}))].sort((a,b)=>a.id-b.id);
                if(all.length===0)document.getElementById('no-goals-msg').classList.remove('hidden'); else document.getElementById('no-goals-msg').classList.add('hidden');
                all.forEach((g,i)=>{
                    const tn=g._t===1?AppState.finalTeam1.name:AppState.finalTeam2.name;
                    const tp=g._t===1?AppState.playersTeam1:AppState.playersTeam2;
                    const sc=tp.map(p=>`<option value="${p}" ${p===g.scorer?'selected':''}>${p}</option>`).join('');
                    const as=`<option value="Brak" ${g.assist==='Brak'?'selected':''}>Brak</option>`+tp.filter(p=>p!==g.scorer).map(p=>`<option value="${p}" ${p===g.assist?'selected':''}>${p}</option>`).join('');
                    const pts=g.method==='Z dystansu'||g.method==='Rzut Wolny'?2:1;
                    c.innerHTML+=`<div class="goal-card border-${g._t===1?'blue':'red'}-500">
                        <div class="delete-goal-btn" onclick="window.MatchRecorder.removeGoal(${g._t},${g.id})">&times;</div>
                        <div class="flex justify-between items-center mb-2 pr-6"><span class="text-xs font-bold bg-gray-700 px-2 py-1 rounded text-gray-300">Gol #${i+1} (${pts}pkt)</span><span class="text-xs font-bold uppercase text-gray-400 truncate max-w-[150px]">${tn}</span></div>
                        <div class="mb-2"><label class="text-[10px] uppercase text-gray-500 font-bold block mb-1">Strzelec</label><select class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" onchange="window.MatchRecorder.updateGoal(${g._t},${g.id},'scorer',this.value)"><option value="">-- Wybierz --</option>${sc}<option value="Samob√≥j" ${g.scorer==='Samob√≥j'?'selected':''}>Samob√≥j (Przeciwnik)</option></select></div>
                        <div class="flex gap-2"><div class="w-1/2"><label class="text-[10px] uppercase text-gray-500 font-bold block mb-1">Typ</label><select class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" onchange="window.MatchRecorder.updateGoal(${g._t},${g.id},'method',this.value)"><option value="Z pola karnego" ${g.method==='Z pola karnego'?'selected':''}>Z pola karnego (1pkt)</option><option value="Z dystansu" ${g.method==='Z dystansu'?'selected':''}>Z dystansu (2pkt)</option><option value="Rzut Karny" ${g.method==='Rzut Karny'?'selected':''}>Rzut Karny (1pkt)</option><option value="Rzut Wolny" ${g.method==='Rzut Wolny'?'selected':''}>Rzut Wolny (2pkt)</option><option value="Samob√≥j" ${g.method==='Samob√≥j'?'selected':''}>Samob√≥j (1pkt)</option></select></div><div class="w-1/2"><label class="text-[10px] uppercase text-gray-500 font-bold block mb-1">Asysta</label><select class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" ${(g.method==='Samob√≥j'||g.method==='Rzut Karny'||g.method==='Rzut Wolny')?'disabled':''} onchange="window.MatchRecorder.updateGoal(${g._t},${g.id},'assist',this.value)">${as}</select></div></div>
                    </div>`;
                });
                document.getElementById('calc-score-1').innerText=this.calc(1); document.getElementById('calc-score-2').innerText=this.calc(2);
            },
            async save() {
                const md={id:Date.now(),date:new Date().toLocaleString(),team1:{name:AppState.finalTeam1.name,players:AppState.playersTeam1,score:this.calc(1),goals:AppState.recordingGoals.t1},team2:{name:AppState.finalTeam2.name,players:AppState.playersTeam2,score:this.calc(2),goals:AppState.recordingGoals.t2}};
                const btn = document.getElementById('confirm-recording'); const originalText = btn.innerText; btn.innerText = "ZAPISYWANIE..."; btn.disabled = true;
                try {
                    const success = await DataManager.saveMatch(md); 
                    if (success) { DataManager.addToSession(AppState.finalTeam1.name); DataManager.addToSession(AppState.finalTeam2.name); AppState.usedTeams = DataManager.getSessionUsedTeams(); document.getElementById('session-info').innerText=`Dru≈ºyny u≈ºyte w sesji: ${AppState.usedTeams.length}`; document.getElementById('recording-modal').classList.add('hidden'); document.getElementById('post-match-modal').classList.remove('hidden'); }
                } catch (e) { console.error(e); DataManager.showToast("WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu.", 'error'); } finally { btn.innerText = originalText; btn.disabled = false; }
            }
        };
        
        const MatchEditor = {
            currentMatchId: null,
            init() {
                document.getElementById('save-edit-match-btn').onclick = () => this.saveChanges();
            },
            open(id) {
                this.currentMatchId = id;
                const match = DataManager.getMatches().find(m => m.id === id);
                if (!match) return;
                
                Sound.click();
                const container = document.getElementById('edit-match-content');
                const allPlayers = DataManager.getPlayers();
                const allTeams = window.teamsData.map(t => t.name).sort();
                
                const teamOpts = (sel) => allTeams.map(t => `<option value="${t}" ${t === sel ? 'selected' : ''}>${t}</option>`).join('');
                
                const renderPlayerChecks = (current, labelId) => {
                    return allPlayers.map(p => {
                        const checked = current.includes(p) ? 'checked' : '';
                        return `<label class="inline-flex items-center bg-gray-800 p-2 rounded m-1 cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 ${labelId}-chk" value="${p}" ${checked}>
                            <span class="ml-2 text-xs text-white">${p}</span>
                        </label>`;
                    }).join('');
                };

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-800/50 p-3 rounded-xl border border-blue-500/30">
                            <label class="text-xs text-blue-300 font-bold block mb-1">Dru≈ºyna 1 (Wynik: <input type="number" id="edit-s1" value="${match.team1.score}" class="w-10 bg-gray-900 border border-gray-600 text-center rounded"> )</label>
                            <select id="edit-t1-name" class="w-full bg-gray-900 border border-gray-600 text-white text-xs rounded p-2 mb-2">${teamOpts(match.team1.name)}</select>
                            <div class="max-h-32 overflow-y-auto border border-gray-700 rounded p-1">${renderPlayerChecks(match.team1.players, 'p1')}</div>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-xl border border-red-500/30">
                            <label class="text-xs text-red-300 font-bold block mb-1">Dru≈ºyna 2 (Wynik: <input type="number" id="edit-s2" value="${match.team2.score}" class="w-10 bg-gray-900 border border-gray-600 text-center rounded"> )</label>
                            <select id="edit-t2-name" class="w-full bg-gray-900 border border-gray-600 text-white text-xs rounded p-2 mb-2">${teamOpts(match.team2.name)}</select>
                            <div class="max-h-32 overflow-y-auto border border-gray-700 rounded p-1">${renderPlayerChecks(match.team2.players, 'p2')}</div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 italic mt-2 text-center">Uwaga: Edycja wyniku/dru≈ºyn nie aktualizuje automatycznie szczeg√≥≈Ç√≥w bramek (strzelc√≥w itp.) w bazie, jedynie g≈Ç√≥wny wynik do rankingu.</p>
                `;
                
                document.getElementById('edit-match-modal').classList.remove('hidden');
            },
            async saveChanges() {
                const s1 = parseInt(document.getElementById('edit-s1').value) || 0;
                const s2 = parseInt(document.getElementById('edit-s2').value) || 0;
                const t1Name = document.getElementById('edit-t1-name').value;
                const t2Name = document.getElementById('edit-t2-name').value;
                
                const p1 = Array.from(document.querySelectorAll('.p1-chk:checked')).map(c => c.value);
                const p2 = Array.from(document.querySelectorAll('.p2-chk:checked')).map(c => c.value);
                
                if (p1.length === 0 || p2.length === 0) { DataManager.showToast("Wybierz graczy dla obu dru≈ºyn!", 'error'); return; }

                const matches = DataManager.getMatches();
                const idx = matches.findIndex(m => m.id === this.currentMatchId);
                if (idx === -1) return;

                const updatedMatch = { ...matches[idx] };
                updatedMatch.team1.score = s1;
                updatedMatch.team1.name = t1Name;
                updatedMatch.team1.players = p1;
                
                updatedMatch.team2.score = s2;
                updatedMatch.team2.name = t2Name;
                updatedMatch.team2.players = p2;
                
                const newHistory = [...matches];
                newHistory[idx] = updatedMatch;
                
                Sound.confirm();
                await DataManager.updateMatchHistory(newHistory);
                document.getElementById('edit-match-modal').classList.add('hidden');
            }
        };

        const PlayerManager = {
            currentPickerMode: null, // 'team1', 'team2', 'pool'
            deleteMode: false,

            init() {
                // Initialize Buttons
                document.getElementById('goto-step2-btn').onclick = () => {
                    if (this.validateStart()) {
                        Sound.click();
                        document.getElementById('preview-team1').innerText = AppState.playersTeam1.join(' & ');
                        document.getElementById('preview-team2').innerText = AppState.playersTeam2.join(' & ');
                        document.getElementById('step1-screen').classList.add('hidden');
                        document.getElementById('step2-screen').classList.remove('hidden');
                    }
                };
                document.getElementById('back-to-step1-btn').onclick = () => { Sound.click(); document.getElementById('step2-screen').classList.add('hidden'); document.getElementById('step1-screen').classList.remove('hidden'); };
                
                // Picker Modal Events
                document.getElementById('picker-add-btn').onclick = () => { Sound.click(); document.getElementById('picker-add-row').classList.toggle('hidden'); document.getElementById('picker-new-name').focus(); };
                document.getElementById('picker-confirm-add').onclick = () => this.addNewPlayer();
                document.getElementById('picker-done-btn').onclick = () => { Sound.click(); document.getElementById('universal-picker-modal').classList.add('hidden'); this.renderTeamInputs(); };
                
                const delModeBtn = document.getElementById('picker-delete-mode-btn');
                delModeBtn.onclick = () => {
                    Sound.click();
                    this.deleteMode = !this.deleteMode;
                    delModeBtn.classList.toggle('bg-red-600');
                    delModeBtn.classList.toggle('text-white');
                    this.renderPickerGrid();
                };

                // Format Modal Logic (for Draw flow)
                // Need to ensure format buttons call the new flow
                // This is handled by renderFormatModal in older code, but we override functionality via HTML onclicks in modal if needed or just use executeDraw
                
                this.loadState();
                this.renderTeamInputs();
            },

            // --- RENDER INPUT FIELDS ON MAIN SCREEN ---
            renderTeamInputs() {
                const render = (teamArr, elId) => {
                    const container = document.getElementById(elId);
                    const wrapper = container.parentElement;
                    
                    if (teamArr.length > 0) {
                        wrapper.classList.add('has-players');
                        // ZMIANA: Usuniƒôto ikonƒô "X" i zmieniono justify na center
                        container.innerHTML = teamArr.map(p => 
                            `<span onclick="event.stopPropagation(); window.PlayerManager.removePlayerFromTeam('${p}')" 
                                class="bg-gray-800 hover:bg-red-900/80 border border-gray-600 hover:border-red-500 px-4 py-2 rounded-xl text-base font-bold text-white shadow-md flex items-center justify-center cursor-pointer transition-all group min-w-[80px]">
                                ${p} 
                            </span>`
                        ).join('');
                    } else {
                        wrapper.classList.remove('has-players');
                        container.innerHTML = `<span class="text-gray-500 text-sm italic opacity-50">Kliknij, by dodaƒá</span>`;
                    }
                };
                render(AppState.playersTeam1, 'team1-display-list');
                render(AppState.playersTeam2, 'team2-display-list');
                
                const c1 = document.getElementById('count-t1'); if(c1) c1.innerText = AppState.playersTeam1.length;
                const c2 = document.getElementById('count-t2'); if(c2) c2.innerText = AppState.playersTeam2.length;
            },

            // --- OPEN PICKER LOGIC ---
            openTeamPicker(teamNum) {
                Sound.click();
                this.currentPickerMode = teamNum === 1 ? 'team1' : 'team2';
                this.deleteMode = false;
                document.getElementById('picker-delete-mode-btn').classList.remove('bg-red-600', 'text-white');
                document.getElementById('picker-title').innerText = teamNum === 1 ? "Dodaj do: Dru≈ºyna 1" : "Dodaj do: Dru≈ºyna 2";
                document.getElementById('picker-title').className = teamNum === 1 ? "text-xl font-black text-blue-400 uppercase tracking-widest" : "text-xl font-black text-red-400 uppercase tracking-widest";
                document.getElementById('universal-picker-modal').classList.remove('hidden');
                document.getElementById('picker-add-row').classList.add('hidden');
                
                document.getElementById('picker-done-btn').classList.add('hidden');
                // Usuniƒôto ustawianie tekstu info
                this.renderPickerGrid();
            },

            // --- OPEN POOL PICKER (FOR DRAW) ---
            openPoolPicker() {
                Sound.click();
                this.currentPickerMode = 'pool';
                this.deleteMode = false;
                document.getElementById('picker-delete-mode-btn').classList.remove('bg-red-600', 'text-white');
                document.getElementById('picker-title').innerText = "Zaznacz Pulƒô do Losowania";
                document.getElementById('picker-title').className = "text-xl font-black text-purple-400 uppercase tracking-widest";
                document.getElementById('universal-picker-modal').classList.remove('hidden');
                document.getElementById('picker-add-row').classList.add('hidden');
                
                // ZMIANA: Pokazujemy przycisk 'Gotowe' (zmieniajƒÖc tekst na Losuj)
                const doneBtn = document.getElementById('picker-done-btn');
                doneBtn.classList.remove('hidden');
                doneBtn.innerText = "LOSUJ Z WYBRANYCH"; 
                document.getElementById('picker-info-text').innerText = "Zaznacz wszystkich graczy, kt√≥rzy biorƒÖ udzia≈Ç.";
                
                if (AppState.drawSelection.length === 0) {
                     AppState.drawSelection = DataManager.getPlayers();
                }
                
                this.renderPickerGrid();
            },

            // --- RENDER GRID WITH SORTING ---
            renderPickerGrid() {
                const container = document.getElementById('picker-grid-container');
                const allPlayers = DataManager.getPlayers();
                let displayList = [...allPlayers];
                
                const stats = window.Stats.calc(); 
                const pStats = {};
                stats.p.forEach(x => pStats[x.name] = x);

                if (this.currentPickerMode === 'team1' || this.currentPickerMode === 'team2') {
                    const currentTeamArr = this.currentPickerMode === 'team1' ? AppState.playersTeam1 : AppState.playersTeam2;
                    const otherTeamArr = this.currentPickerMode === 'team1' ? AppState.playersTeam2 : AppState.playersTeam1;
                    
                    displayList = displayList.filter(p => !otherTeamArr.includes(p));

                    if (currentTeamArr.length > 0) {
                        const partner = currentTeamArr[0];
                        const partnerStat = pStats[partner];
                        
                        displayList.sort((a, b) => {
                            const aSel = currentTeamArr.includes(a);
                            const bSel = currentTeamArr.includes(b);
                            if (aSel && !bSel) return -1;
                            if (!aSel && bSel) return 1;

                            const aWith = partnerStat && partnerStat.partners[a] ? partnerStat.partners[a] : 0;
                            const bWith = partnerStat && partnerStat.partners[b] ? partnerStat.partners[b] : 0;
                            return bWith - aWith; 
                        });
                    } else {
                        displayList.sort((a, b) => {
                             const aM = pStats[a] ? pStats[a].m : 0;
                             const bM = pStats[b] ? pStats[b].m : 0;
                             return bM - aM;
                        });
                    }
                } else if (this.currentPickerMode === 'pool') {
                     displayList.sort((a, b) => {
                             const aM = pStats[a] ? pStats[a].m : 0;
                             const bM = pStats[b] ? pStats[b].m : 0;
                             return bM - aM;
                    });
                }

                // FUNKCJA POMOCNICZA DO ODMIANY
                const decl = (n) => {
                    if (n === 1) return 'mecz';
                    const n10 = n % 10;
                    const n100 = n % 100;
                    if (n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return 'mecze';
                    return 'meczy';
                };

                container.innerHTML = displayList.map(p => {
                    const stat = pStats[p] || {m:0};
                    let isSelected = false;
                    // ZMIANA: Poprawna odmiana s≈Çowa "mecz"
                    let subText = `${stat.m} ${decl(stat.m)}`;
                    let isDisabled = false;

                    if (this.currentPickerMode === 'team1') {
                        if(AppState.playersTeam1.includes(p)) isDisabled = true;
                    }
                    else if (this.currentPickerMode === 'team2') {
                         if(AppState.playersTeam2.includes(p)) isDisabled = true;
                    }
                    else if (this.currentPickerMode === 'pool') {
                        isSelected = AppState.drawSelection.includes(p);
                    }
                    
                    if (isDisabled) return ''; 

                    if ((this.currentPickerMode === 'team1' || this.currentPickerMode === 'team2') && 
                        (this.currentPickerMode === 'team1' ? AppState.playersTeam1 : AppState.playersTeam2).length > 0 &&
                         !isSelected) {
                        const partner = (this.currentPickerMode === 'team1' ? AppState.playersTeam1 : AppState.playersTeam2)[0];
                        const partnerStat = pStats[partner];
                        const together = partnerStat && partnerStat.partners[p] ? partnerStat.partners[p] : 0;
                        if (together > 0) subText = `Duo: ${together} ${decl(together)}`;
                    }

                    const selectedClass = isSelected ? 'selected ring-2 ring-indigo-500' : 'border-gray-600 hover:border-blue-400 text-gray-300';
                    const deleteOverlay = this.deleteMode ? `<div class="absolute inset-0 bg-red-900/90 flex items-center justify-center rounded-xl text-white font-bold text-sm uppercase tracking-widest backdrop-blur-[2px] z-10">USU≈É</div>` : '';

                    return `
                    <div onclick="window.PlayerManager.handlePickerClick('${p}')" class="picker-card ${selectedClass}">
                        ${deleteOverlay}
                        <div class="font-bold truncate leading-tight w-full">${p}</div>
                        <div class="picker-stat">${subText}</div>
                    </div>`;
                }).join('');
            },

            // --- CLICK HANDLER ---
            handlePickerClick(name) {
                if (this.deleteMode) {
                    this.openDeleteConfirm(name);
                    return;
                }
                Sound.click();

                // ZMIANA: Tryb wyboru dru≈ºyny (Team 1 lub 2)
                if (this.currentPickerMode === 'team1' || this.currentPickerMode === 'team2') {
                    const targetArr = this.currentPickerMode === 'team1' ? AppState.playersTeam1 : AppState.playersTeam2;
                    
                    if (targetArr.includes(name)) {
                        DataManager.showToast("Ten gracz jest ju≈º dodany!", "error");
                        return;
                    }

                    // Dodaj gracza
                    targetArr.push(name);
                    
                    // Zapisz, od≈õwie≈º widok g≈Çowny i ZAMKNIJ MODAL OD RAZU
                    this.saveCurrentState();
                    this.renderTeamInputs();
                    document.getElementById('universal-picker-modal').classList.add('hidden');
                    Sound.confirm();
                }
                // Tryb Puli (zostaje po staremu - multiselect)
                else if (this.currentPickerMode === 'pool') {
                    if (AppState.drawSelection.includes(name)) AppState.drawSelection = AppState.drawSelection.filter(x => x !== name);
                    else AppState.drawSelection.push(name);
                    
                    this.saveCurrentState();
                    this.renderPickerGrid(); 
                }
            },

            removePlayerFromTeam(name) {
                Sound.click();
                if (AppState.playersTeam1.includes(name)) AppState.playersTeam1 = AppState.playersTeam1.filter(x => x !== name);
                if (AppState.playersTeam2.includes(name)) AppState.playersTeam2 = AppState.playersTeam2.filter(x => x !== name);
                this.saveCurrentState();
                this.renderTeamInputs();
            },

            // --- ADD / DELETE LOGIC ---
            addNewPlayer() {
                const name = document.getElementById('picker-new-name').value.trim();
                if (name) {
                    const current = DataManager.getPlayers();
                    if (!current.includes(name)) {
                        DataManager.savePlayers([...current, name]);
                        document.getElementById('picker-new-name').value = '';
                        document.getElementById('picker-add-row').classList.add('hidden');
                        Sound.confirm();
                        // Re-render handled by listener in DataManager, but for speed:
                        setTimeout(() => this.renderPickerGrid(), 100);
                    } else {
                        DataManager.showToast('Taki gracz ju≈º istnieje!', 'error');
                    }
                }
            },
            
            openDeleteConfirm(name) {
                Sound.click();
                const modal = document.getElementById('delete-confirm-modal');
                document.getElementById('del-player-name').innerText = name;
                modal.classList.remove('hidden');
                
                document.getElementById('del-btn-keep-stats').onclick = () => this.executeDelete(name, true);
                document.getElementById('del-btn-wipe-stats').onclick = () => this.executeDelete(name, false);
            },
            
            async executeDelete(name, keepStats) {
                Sound.click();
                // 1. Remove from Players List
                const currentPool = DataManager.getPlayers().filter(p => p !== name);
                await DataManager.savePlayers(currentPool);
                
                // 2. Remove from current state selections
                AppState.playersTeam1 = AppState.playersTeam1.filter(p => p !== name);
                AppState.playersTeam2 = AppState.playersTeam2.filter(p => p !== name);
                AppState.drawSelection = AppState.drawSelection.filter(p => p !== name);
                this.saveCurrentState();

                if (!keepStats) {
                    // Wipe Individual Stats (Clean meta + Remove from match history names if logic allows)
                    // Per request: "wipe stats from database except duos"
                    // Stats are derived from matches. To "wipe stats", we essentially need to anonymize them in match history or let them fade.
                    // Since "Duos" are just calculations based on players in a match, we can't easily keep Duo stats while deleting Player stats IF they rely on the same match data.
                    // COMPROMISE: We just remove the player from the active `players` list (already done). 
                    // To "Clean Meta" (Avatar/Color):
                    const meta = DataManager.getMeta();
                    if(meta[name]) {
                        delete meta[name];
                        await DataManager.saveMeta(meta);
                    }
                    DataManager.showToast("Gracz i dane usuniƒôte.");
                } else {
                    DataManager.showToast("Gracz usuniƒôty (statystyki zachowane).");
                }
                
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                this.renderPickerGrid();
                this.renderTeamInputs();
            },

            // --- BUTTON ACTIONS ---
            clearTeams() {
                Sound.click();
                AppState.playersTeam1 = [];
                AppState.playersTeam2 = [];
                this.saveCurrentState();
                this.renderTeamInputs();
            },
            
            swapSides() {
                Sound.click();
                const temp = [...AppState.playersTeam1];
                AppState.playersTeam1 = [...AppState.playersTeam2];
                AppState.playersTeam2 = temp;
                this.saveCurrentState();
                this.renderTeamInputs();
                DataManager.showToast("Strony zamienione");
            },

            // --- DRAW FLOW ---
            startDrawFlow() {
                Sound.click();
                document.getElementById('format-modal').classList.remove('hidden');
            },
            
            // Triggered by Format Modal Buttons (1v1, 2v2 etc)
            executeDraw(format) {
                // Modified to OPEN PICKER first
                document.getElementById('format-modal').classList.add('hidden');
                
                // Set Draw Mode based on format for validation later? 
                // Currently just opens pool picker.
                this.drawFormat = format; // store for later
                this.openPoolPicker();
                
                // Replace "Done" button action for this specific flow
                const doneBtn = document.getElementById('picker-done-btn');
                doneBtn.onclick = () => {
                     Sound.click();
                     this.finalizeDraw();
                };
            },
            
            finalizeDraw() {
                 const format = this.drawFormat;
                 let pool = [...AppState.drawSelection];
                 
                 // Logic to pick random players
                 let count = 0;
                 if(format==='1v1') count = 2;
                 if(format==='2v2') count = 4;
                 if(format==='1v2' || format==='1v3') count = format === '1v2' ? 3 : 4;
                 
                 if(pool.length < count) {
                     DataManager.showToast(`Za ma≈Ço graczy w puli! (Wymagane: ${count})`, 'error');
                     return;
                 }
                 
                 // Shuffle
                 pool = pool.sort(() => 0.5 - Math.random());
                 const selected = pool.slice(0, count);
                 
                 if(format==='1v1'){
                    AppState.playersTeam1=[selected[0]]; AppState.playersTeam2=[selected[1]];
                 } else if(format==='2v2'){
                    AppState.playersTeam1=[selected[0],selected[1]]; AppState.playersTeam2=[selected[2],selected[3]];
                 } else if(format==='1v2'){
                    AppState.playersTeam1=[selected[0]]; AppState.playersTeam2=[selected[1],selected[2]];
                 } else if(format==='1v3'){
                    AppState.playersTeam1=[selected[0]]; AppState.playersTeam2=[selected[1],selected[2],selected[3]];
                 }
                 
                 this.saveCurrentState();
                 document.getElementById('universal-picker-modal').classList.add('hidden');
                 this.renderTeamInputs();
                 Sound.reroll();
                 
                 // Restore default Done behavior
                 document.getElementById('picker-done-btn').onclick = () => { Sound.click(); document.getElementById('universal-picker-modal').classList.add('hidden'); this.renderTeamInputs(); };
            },

            // --- UTILS ---
            saveCurrentState() { DataManager.saveState({ playersTeam1: AppState.playersTeam1, playersTeam2: AppState.playersTeam2, minStars: AppState.minStars, maxStars: AppState.maxStars, rerollSettings: AppState.rerollSettings, selectedLeague: AppState.selectedLeague }); },
            loadState() {
                const s = DataManager.getState(); const p = DataManager.getPlayers();
                if (s) {
                    AppState.playersTeam1 = (s.playersTeam1 || []).filter(x => p.includes(x));
                    AppState.playersTeam2 = (s.playersTeam2 || []).filter(x => p.includes(x));
                    AppState.minStars = s.minStars || 2.5; AppState.maxStars = s.maxStars || 5; AppState.rerollSettings = s.rerollSettings !== undefined ? s.rerollSettings : 3; AppState.selectedLeague = s.selectedLeague || "All";
                    const minEl = document.getElementById('min-stars'); if (minEl) { minEl.value = AppState.minStars; document.getElementById('min-stars-value').textContent = AppState.minStars.toFixed(1); }
                    const maxEl = document.getElementById('max-stars'); if (maxEl) { maxEl.value = AppState.maxStars; document.getElementById('max-stars-value').textContent = AppState.maxStars.toFixed(1); }
                    const rrEl = document.getElementById('rerolls-value'); if (rrEl) rrEl.textContent = AppState.rerollSettings;
                    document.querySelectorAll('.league-btn').forEach(b => { b.classList.remove('active'); if (b.dataset.league === AppState.selectedLeague) b.classList.add('active'); });
                }
                this.renderTeamInputs();
            },
            
            getFilteredPool(drawing = false) {
                const all = window.teamsData;
                let p = all.filter(t => t.stars >= AppState.minStars && t.stars <= AppState.maxStars);
                if (AppState.selectedLeague !== 'All') {
                    if (AppState.selectedLeague === 'All_NoRow') {
                        p = p.filter(t => t.league !== 'Rest of World');
                    } else {
                        p = p.filter(t => t.league === AppState.selectedLeague || (AppState.selectedLeague === 'Clubs' && t.league !== 'National'));
                    }
                }
                return p;
            },
            
            // Standard Validation
            validateStart() {
                if (AppState.playersTeam1.length === 0 || AppState.playersTeam2.length === 0) {
                    DataManager.showToast("Brakuje graczy! Przydziel ich rƒôcznie lub wylosuj.", 'error');
                    return false;
                }
                return true;
            },

            // Abort Draw etc.
            abortDraw() {
    Sound.click();
    window.abortController.aborted = true;
    AppState.finalTeam1 = null; AppState.finalTeam2 = null;
    resetMatchUI(); // Wywo≈Çanie nowej funkcji
    document.getElementById('drawing-screen').classList.add('hidden');
    document.getElementById('step2-screen').classList.remove('hidden');
},
            
            // --- PRZYWR√ìCONE FUNKCJE STATYSTYK ---
            
            updateH2H() {
                const p1 = AppState.playersTeam1.slice().sort().join(',');
                const p2 = AppState.playersTeam2.slice().sort().join(',');
                
                if(!p1 || !p2) {
                     document.getElementById('h2h-stats-display').innerHTML = '';
                     document.getElementById('h2h-stats-display').classList.add('hidden');
                     return;
                }
                
                const history = DataManager.getMatches();
                let w=0, d=0, l=0;
                
                history.forEach(m => {
                    const mp1 = m.team1.players.slice().sort().join(',');
                    const mp2 = m.team2.players.slice().sort().join(',');
                    
                    if ((mp1 === p1 && mp2 === p2) || (mp1 === p2 && mp2 === p1)) {
                        const isOrder = mp1 === p1;
                        const s1 = isOrder ? m.team1.score : m.team2.score;
                        const s2 = isOrder ? m.team2.score : m.team1.score;
                        
                        if (s1 > s2) w++;
                        else if (s1 === s2) d++;
                        else l++;
                    }
                });
                
                const total = w + d + l;
                const container = document.getElementById('h2h-stats-display');
                
                if (total === 0) {
                    container.innerHTML = `<span class="opacity-40 italic text-[9px] bg-black/40 px-3 py-1 rounded-full">Pierwsze starcie</span>`;
                    container.classList.remove('hidden', 'mb-2');
                    container.classList.add('mb-1');
                    return;
                }

                // Obliczanie procent√≥w
                const pW = Math.round((w / total) * 100);
                const pD = Math.round((d / total) * 100);
                const pL = Math.round((l / total) * 100);

                // NOWY FORMAT: Liczba (%) - Liczba (%) - Liczba (%)
                // Je≈õli liczba wynosi 0, nie pokazujemy procent√≥w
                
                const formatStat = (val, pct, color) => {
                    const percentHtml = val > 0 ? `<span class="opacity-50 text-[9px] ml-0.5 font-normal">(${pct}%)</span>` : '';
                    return `<span class="${color} font-black text-xs md:text-sm">${val}${percentHtml}</span>`;
                };

                const html = `
                    <div class="flex items-center gap-3 bg-gray-900 px-5 py-1.5 rounded-full border border-gray-600 shadow-xl uppercase tracking-wider z-30 relative">
                        ${formatStat(w, pW, 'text-blue-400')}
                        <div class="text-gray-600 text-[10px]">‚Ä¢</div>
                        ${formatStat(d, pD, 'text-gray-400')}
                        <div class="text-gray-600 text-[10px]">‚Ä¢</div>
                        ${formatStat(l, pL, 'text-red-400')}
                    </div>
                `;
                
                container.innerHTML = html;
                container.classList.remove('hidden');
            },

            generateTeamFact(team, players) {
                const allMatches = DataManager.getMatches();
                const playerCount = players.length;
                const isPlural = playerCount > 1;
                
                // 1. STATYSTYKI TEGO SK≈ÅADU Z TYM KLUBEM
                // Filtrujemy mecze gdzie ten konkretny sk≈Çad gra≈Ç tym konkretnym klubem
                const specificMatches = allMatches.filter(m => 
                    (m.team1.name === team.name && JSON.stringify(m.team1.players.sort()) === JSON.stringify(players.slice().sort())) ||
                    (m.team2.name === team.name && JSON.stringify(m.team2.players.sort()) === JSON.stringify(players.slice().sort()))
                );
                
                const smCount = specificMatches.length;

                // Helper do obliczania winrate
                const calcStats = (matchesList, teamName) => {
                    let w=0, g=0;
                    matchesList.forEach(m => {
                        const isT1 = m.team1.name === teamName;
                        const myS = isT1 ? m.team1.score : m.team2.score;
                        const opS = isT1 ? m.team2.score : m.team1.score;
                        if(myS > opS) w++;
                        g += myS;
                    });
                    return { w, g, wr: matchesList.length ? (w/matchesList.length) : 0, avgG: matchesList.length ? (g/matchesList.length) : 0 };
                };

                const sStats = calcStats(specificMatches, team.name);

                // --- LOGIKA DLA KONKRETNEGO SK≈ÅADU (Priorytet) ---
                if (smCount > 0) {
                    // Ekstremalne przypadki
                    if (smCount >= 3 && sStats.wr === 1) return isPlural ? "Wasza Twierdza" : "Twoja Twierdza";
                    if (smCount >= 3 && sStats.wr === 0) return isPlural ? "Wasza KlƒÖtwa" : "Tw√≥j Pech";
                    if (smCount >= 5 && sStats.wr >= 0.8) return "üî• Dominacja";
                    if (smCount >= 5 && sStats.wr <= 0.2) return "‚ùÑÔ∏è Trudny Teren";
                    
                    // Gole
                    if (sStats.avgG >= 4.0) return "Maszyna do Goli";
                    if (sStats.avgG <= 0.5) return "Murarka";
                    
                    // Historia
                    if (smCount >= 10) return "Weterani";
                    return `${smCount} ${smCount===1?'Mecz':'Meczy'} Razem`;
                }

                // 2. STATYSTYKI GLOBALNE KLUBU (Je≈õli brak historii sk≈Çadu)
                // Sprawdzamy jak ten klub radzi sobie og√≥lnie u wszystkich graczy
                const globalMatches = allMatches.filter(m => m.team1.name === team.name || m.team2.name === team.name);
                const gCount = globalMatches.length;
                const gStats = calcStats(globalMatches, team.name);

                if (gCount === 0) return "Debiut Klubu"; // Nikt nigdy nim nie gra≈Ç

                // Ciekawostki globalne
                if (gCount >= 20 && gStats.wr >= 0.6) return "OP Team"; // Bardzo silny og√≥lnie
                if (gCount >= 10 && gStats.wr <= 0.3) return "S≈Çaby Pick"; // S≈Çaby og√≥lnie
                if (gCount >= 30) return "Ulubieniec"; // Czƒôsto wybierany
                if (gStats.avgG >= 3.5) return "Ofensywny";
                if (gStats.avgG <= 1.5) return "Defensywny";

                // Je≈õli nic ciekawego nie znaleziono
                if (team.stars <= 3.5) return "Underdog"; // S≈Çaba gwiazdkowo
                
                return isPlural ? "Nasz Debiut" : "M√≥j Debiut";
            },
        };


        const PostMatchMenu={rematch(){this.close();this.reset();document.getElementById('step2-screen').classList.remove('hidden');},newSquads(){this.close();this.reset();document.getElementById('step1-screen').classList.remove('hidden');},showStats(){this.close();this.reset();window.Stats.init();document.getElementById('stats-modal').classList.remove('hidden');window.Stats.switchTab('rankings',document.getElementById('tab-rankings'));document.getElementById('step1-screen').classList.remove('hidden');},
        reset() {
    AppState.recordingGoals = {t1: [], t2: []}; 
    AppState.finalTeam1 = null; 
    AppState.finalTeam2 = null; 
    resetMatchUI(); // Wywo≈Çanie nowej funkcji
},
        close(){['post-match-modal','results-container','drawing-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));}};

        const Stats = {
            hideLowMatches: false,
            init() { 
    const closeBtn = document.getElementById('close-stats');
    if (closeBtn) {
        closeBtn.onclick = () => document.getElementById('stats-modal').classList.add('hidden');
    }
    
    const toggle = document.getElementById('hide-low-matches-toggle');
    if (toggle) {
        toggle.addEventListener('change', (e) => {
            this.hideLowMatches = e.target.checked;
            Sound.click();
            this.switchTab(this.activeTab, document.querySelector('.stats-tab.active'));
        });
    }
},
            clearHistory() { DataManager.clearHistory(); },
            activeTab: 'rankings',
            switchTab(t,b) {
                this.activeTab = t;
                document.querySelectorAll('.stats-tab').forEach(x=>x.classList.remove('active','bg-indigo-600')); if(b)b.classList.add('active','bg-indigo-600');
                const c=document.getElementById('stats-content'); document.getElementById('ranking-type-container').classList.add('hidden');
                
                if(t==='history'){
                    const matches = DataManager.getMatches().slice().reverse();
                    c.innerHTML=matches.map(m=>`<div class="bg-gray-800 p-3 mb-2 rounded border border-gray-700 flex justify-between items-center"><div class="text-xs text-gray-400">${m.date.split(',')[0]}</div><div class="font-bold"><span class="text-blue-400">${m.team1.name}</span> <span class="bg-gray-900 px-2 py-1 rounded mx-2">${m.team1.score} : ${m.team2.score}</span> <span class="text-red-400">${m.team2.name}</span></div><div class="text-xs text-gray-500 w-32 text-right truncate">${m.team1.players.join(',')} vs ${m.team2.players.join(',')}</div><div class="flex"><button class="ml-2 text-indigo-400 hover:text-indigo-300 font-bold px-2 text-sm" onclick="window.MatchEditor.open(${m.id})">‚úèÔ∏è</button><button class="ml-1 text-red-500 hover:text-red-400 font-bold px-2" onclick="window.DataManager.deleteMatch(${m.id})">üóë</button></div></div>`).join('')||'<p class="text-center text-gray-500 mt-10">Brak historii mecz√≥w.</p>';
                } else if(t==='rankings'){ 
                    document.getElementById('ranking-type-container').classList.remove('hidden'); 
                    this.renderRankings(); 
                }
                else if(t==='players'){ this.renderPlayerCards(); }
                else if(t==='duos' || t==='teams'){ 
                    document.getElementById('ranking-type-container').classList.remove('hidden'); 
                    this.renderRankings(); 
                }
            },
            // ZMODYFIKOWANA FUNKCJA CALC ABY PRZYJMOWAƒÜ NIESTANDARDOWƒÑ HISTORIƒò
            calc(customMatches = null) {
                const ms = customMatches || DataManager.getMatches(); 
                const pl = DataManager.getPlayers();
                let pD={}; let dD={}; let tD={}; 
                pl.forEach(p=>pD[p]={name:p,m:0,w:0,d:0,l:0,g:0,a:0,pts:0,wg:0,dp:0,ag:0,bg:0,dg:0,pg:0,fg:0,clubs:{},nemesis:{},partners:{},allPartners:0, biggestWin:{diff: -99}, biggestLoss:{diff: 99}});
                
                ms.forEach(m=>{
                    const t1p=m.team1.score>m.team2.score?3:(m.team1.score==m.team2.score?1:0);
                    const t2p=m.team2.score>m.team1.score?3:(m.team2.score==m.team1.score?1:0);
                    
                    const proc=(t,pts,opp,oppS)=>{
                        const diff = t.score - oppS;
                        if(!tD[t.name]) tD[t.name]={name:t.name,m:0,w:0,d:0,l:0,g:0};
                        tD[t.name].m++;
                        if(pts===3) tD[t.name].w++; else if(pts===1) tD[t.name].d++; else tD[t.name].l++;
                        tD[t.name].g+=t.score;

                        if(t.players.length===2){
                            const k=t.players.slice().sort().join(" & ");
                            if(!dD[k])dD[k]={name:k,m:0,w:0,d:0,l:0,g:0,a:0,pts:0,dg:0,bg:0,pg:0,fg:0};
                            let dd=dD[k];
                            dd.m++;
                            if(pts===3) dd.w++; else if(pts===1) dd.d++; else dd.l++;
                            dd.g+=t.score;
                            dd.pts+=pts; 
                            t.goals.forEach(g=>{
                                if(g.method==='Z dystansu'){dd.dg++;} 
                                else if(g.method==='Rzut Wolny'){dd.fg++;}
                                else if(g.method==='Rzut Karny'){dd.pg++;}
                                else if(g.method==='Z pola karnego'){dd.bg++;}
                                if(g.assist!=='Brak') dd.a++;
                                if(g.scorer !== 'Samob√≥j') {
                                     if(g.method==='Z dystansu' || g.method==='Rzut Wolny') dd.pts+=2;
                                     else if(g.method==='Rzut Karny' || g.method==='Z pola karnego') dd.pts+=1;
                                     else dd.pts+=1; 
                                     if(g.assist!=='Brak') dd.pts+=1;
                                }
                            });
                        }
                        t.players.forEach(p=>{
                            if(!pD[p])return;
                            let pd=pD[p]; pd.m++; 
                            if(pts===3){ 
                                pd.w++; pd.pts+=3;
                                if(diff > pd.biggestWin.diff) pd.biggestWin = {diff: diff, myScore: t.score, oppScore: oppS, myTeam: t.name, oppTeam: opp.name, date: m.date, myPlayers: t.players, oppPlayers: opp.players};
                            } else if(pts===1){ 
                                pd.d++; pd.pts+=1; 
                            } else { 
                                pd.l++; 
                                if(diff < pd.biggestLoss.diff) pd.biggestLoss = {diff: diff, myScore: t.score, oppScore: oppS, myTeam: t.name, oppTeam: opp.name, date: m.date, myPlayers: t.players, oppPlayers: opp.players};
                            }
                            pd.clubs[t.name]=(pd.clubs[t.name]||0)+1;
                            t.players.forEach(mate=>{
                                if(mate!==p){ 
                                    pd.partners[mate]=(pd.partners[mate]||0)+1; 
                                    pd.allPartners++;
                                }
                            });
                            opp.players.forEach(op=>{
                                if(!pd.nemesis[op]) pd.nemesis[op]={w:0,d:0,l:0,count:0}; 
                                pd.nemesis[op].count++;
                                if (pts === 3) pd.nemesis[op].w++;
                                else if (pts === 1) pd.nemesis[op].d++;
                                else pd.nemesis[op].l++;
                            });
                        });
                        t.goals.forEach(g=>{
                            if(g.scorer!=='Samob√≥j' && pD[g.scorer]){
                                let pp=pD[g.scorer]; pp.g++;
                                if(g.method==='Z dystansu'){pp.pts+=2;pp.dg++;} 
                                else if(g.method==='Rzut Wolny'){pp.pts+=2;pp.fg++;}
                                else if(g.method==='Rzut Karny'){pp.pts+=1;pp.pg++;}
                                else if(g.method==='Z pola karnego'){pp.pts+=1;pp.bg++;}
                            }
                            if(g.assist!=='Brak' && pD[g.assist] && g.scorer !== 'Samob√≥j'){ 
                                pD[g.assist].a++; pD[g.assist].pts+=1; pD[g.assist].ag++; 
                            }
                        });
                    };
                    proc(m.team1,t1p,m.team2,m.team2.score); proc(m.team2,t2p,m.team1,m.team1.score);
                });
                return {p:Object.values(pD), d:Object.values(dD), t:Object.values(tD)};
            },
            
            // NOWA FUNKCJA DO OBLICZANIA TREND√ìW
            getTrendData(currentType, activeTab) {
                const matches = DataManager.getMatches();
                if (matches.length < 1) return {};
                
                // Stan poprzedni (bez ostatniego meczu)
                const prevMatches = matches.slice(0, -1);
                
                const currCalc = this.calc(matches);
                const prevCalc = this.calc(prevMatches);
                
                // Helper to retrieve source array based on tab
                const getSource = (cal) => {
                    if (activeTab === 'teams') return cal.t.filter(x => x.m > 0);
                    if (activeTab === 'duos') return cal.d.filter(x => x.m > 0);
                    return cal.p.filter(x => x.m > 0);
                };
                
                const currData = getSource(currCalc);
                const prevData = getSource(prevCalc);
                
                // Helper to sort (must duplicate renderRankings logic slightly)
                const sortLogic = (list, type) => {
                    if (activeTab === 'teams') {
                        if(type === 'team_wins') return list.sort((a,b) => (b.w/b.m) - (a.w/a.m));
                        if(type === 'team_goals') return list.sort((a,b) => (b.g/b.m) - (a.g/a.m));
                        return list.sort((a,b) => b.m - a.m);
                    } else {
                        if(type==='points') return list.sort((a,b)=> (b.pts/b.m) - (a.pts/a.m) || b.pts - a.pts);
                        if(type==='winrate') return list.sort((a,b)=>(b.w/b.m||0)-(a.w/a.m||0));
                        if(type==='goals') return list.sort((a,b)=>(b.g/b.m||0)-(a.g/a.m||0));
                        if(type==='assists') return list.sort((a,b)=>(b.a/b.m||0)-(a.a/a.m||0));
                        
                        const k={dist_goals:'dg',box_goals:'bg',pen_goals:'pg',fk_goals:'fg'}[type];
                        if(k) return list.sort((a,b)=>(b[k]/b.m||0)-(a[k]/a.m||0));
                        return list;
                    }
                };

                const currSorted = sortLogic([...currData], currentType);
                const prevSorted = sortLogic([...prevData], currentType);
                
                const trends = {};
                
                currSorted.forEach((item, index) => {
                    // Find index in previous sorted list
                    const prevIndex = prevSorted.findIndex(prev => prev.name === item.name);
                    
                    if (prevIndex === -1) {
                        trends[item.name] = 0; // New entry, neutral
                    } else {
                        // If prevIndex was 5 and now is 3, trend is +2 (UP)
                        // If prevIndex was 1 and now is 2, trend is -1 (DOWN)
                        trends[item.name] = prevIndex - index;
                    }
                });
                
                return trends;
            },

            renderRankings() {
                const type = document.getElementById('ranking-type-select').value; 
                let sourceData;
                let isTeam = false;
                
                const select = document.getElementById('ranking-type-select');
                
                if (this.activeTab === 'teams') {
                    if(!select.querySelector('option[value="team_picks"]')) {
                        select.innerHTML = `
                            <option value="team_picks">Najczƒô≈õciej Wybierane</option>
                            <option value="team_wins">Skuteczno≈õƒá % (Kluby)</option>
                            <option value="team_goals">≈örednia Goli (Kluby)</option>
                        `;
                    }
                    sourceData = this.calc().t;
                    isTeam = true;
                } else {
                    if(!select.querySelector('option[value="points"]')) {
                        select.innerHTML = `
                            <option value="points">G≈Å√ìWNY (Punkty MVP)</option>
                            <option value="winrate">Skuteczno≈õƒá (%)</option>
                            <option value="goals">Kr√≥l Strzelc√≥w (≈ör.)</option>
                            <option value="assists">Kr√≥l Asyst (≈ör.)</option>
                            <option value="dist_goals">Gole z Dystansu (≈ör.)</option>
                            <option value="box_goals">Gole z Pola (≈ör.)</option>
                            <option value="pen_goals">Gole z Karnych (≈ör.)</option>
                            <option value="fk_goals">Gole z Wolnych (≈ör.)</option>
                        `;
                    }
                    sourceData = this.activeTab === 'duos' ? this.calc().d : this.calc().p;
                }
                
                // Get Trends
                const trendData = this.getTrendData(type, this.activeTab);
                
                let d = sourceData.filter(x => x.m > 0);
                
                // FILTER LOW MATCHES IF TOGGLE IS ON
                if (this.hideLowMatches) {
                    d = d.filter(x => x.m >= 10);
                }
                
                let s=[], c="", v=(p)=>"";
                
                if (isTeam) {
                    const currentType = select.value; 
                    if(currentType === 'team_wins') { 
                        s = d.sort((a,b) => (b.w/b.m) - (a.w/a.m)); 
                        c = "Win %"; 
                        v = p => `${Math.round(p.w/p.m*100)}% <span class="text-xs text-gray-500">(${p.w}/${p.m})</span>`; 
                    }
                    else if(currentType === 'team_goals') { 
                        s = d.sort((a,b) => (b.g/b.m) - (a.g/a.m)); 
                        c = "≈ör. Goli"; 
                        v = p => `${(p.g/p.m).toFixed(2)} <span class="text-xs text-gray-500">(${p.g} w ${p.m})</span>`; 
                    }
                    else { s = d.sort((a,b) => b.m - a.m); c = "Wybory"; v = p => p.m; } 
                } else {
                    const currentType = select.value;
                    if(currentType==='points'){
                        s=d.sort((a,b)=> (b.pts/b.m) - (a.pts/a.m) || b.pts - a.pts);
                        c="MVP PKT";
                        v=p=>{
                            return `<div class="flex flex-col text-right text-xs font-mono">
                                    <div class="mb-1">
                                        <span class="text-yellow-400 font-bold text-lg">${(p.pts/p.m).toFixed(2)}</span>
                                        <span class="text-[10px] text-gray-500">avg</span>
                                    </div>
                                    <div class="text-[10px] text-gray-400 mt-1">
                                        <span class="text-green-400">W:${p.w}</span>-<span class="text-gray-300">R:${p.d}</span>-<span class="text-red-400">P:${p.l}</span>
                                        <span class="text-gray-500 mx-1">|</span>
                                        <span class="text-blue-300">‚öΩ${p.g}</span> <span class="text-yellow-300">A:${p.a}</span>
                                    </div>
                                </div>`;
                        };
                    }
                    else if(currentType==='winrate'){s=d.sort((a,b)=>(b.w/b.m||0)-(a.w/a.m||0));c="Win %";v=p=>`${p.m?Math.round(p.w/p.m*100):0}% <span class="text-xs text-gray-500">(${p.w}/${p.m})</span>`;}
                    else if(currentType==='goals'){s=d.sort((a,b)=>(b.g/b.m||0)-(a.g/a.m||0));c="≈ör. Goli";v=p=>`${(p.g/p.m||0).toFixed(2)} <span class="text-xs text-gray-500">(${p.g} w ${p.m})</span>`;}
                    else if(currentType==='assists'){s=d.sort((a,b)=>(b.a/b.m||0)-(a.a/a.m||0));c="≈ör. Asyst";v=p=>`${(p.a/p.m||0).toFixed(2)} <span class="text-xs text-gray-500">(${p.a} w ${p.m})</span>`;}
                    else {
                        const k={dist_goals:'dg',box_goals:'bg',pen_goals:'pg',fk_goals:'fg'}[currentType];
                        const label = {dist_goals: 'Gole Dyst.', box_goals: 'Gole Pola', pen_goals: 'Gole Karn.', fk_goals: 'Gole Wol.'}[currentType];
                        if(k) {
                            s=d.sort((a,b)=>(b[k]/b.m||0)-(a[k]/a.m||0));c=`≈ör. ${label.split(' ')[0]}`;v=p=>`${(p[k]/p.m||0).toFixed(2)} <span class="text-xs text-gray-500">(${p[k]} w ${p.m})</span>`;
                        } else { s=d; c="?"; }
                    }
                }
                
                let h=`<table class="w-full text-left text-sm text-gray-300"><thead class="text-xs uppercase bg-gray-700 text-gray-400"><tr><th class="px-2 py-3 w-10 text-center">#</th><th class="px-2 py-3">${isTeam ? 'Klub' : (this.activeTab === 'duos' ? 'Duet' : 'Gracz')}</th><th class="px-2 py-3 text-right">${c}</th></tr></thead><tbody>`;
                
                if (s.length === 0) h = '<p class="text-center text-gray-500 py-8">Brak danych (lub ukryte).</p>';
                else s.forEach((p,i)=> {
                    const rowClass = (this.activeTab === 'players' || this.activeTab === 'rankings') ? "border-b border-gray-700 hover:bg-gray-800 cursor-pointer" : "border-b border-gray-700 hover:bg-gray-800";
                    const clickAttr = (this.activeTab === 'players' || this.activeTab === 'rankings') ? `onclick="window.Stats.openProfile('${p.name}')"` : "";
                    
                    // --- TREND ARROW LOGIC ---
                    const trend = trendData[p.name] || 0;
                    let trendIcon = '';
                    // Only show trends if not filtering low matches, as filtering changes positions drastically
                    if (!this.hideLowMatches) {
                        if (trend > 0) {
                            trendIcon = `<span class="trend-arrow text-green-500 font-bold ml-2 text-[10px]">‚ñ≤${trend}</span>`;
                        } else if (trend < 0) {
                            trendIcon = `<span class="trend-arrow text-red-500 font-bold ml-2 text-[10px]">‚ñº${Math.abs(trend)}</span>`;
                        }
                    }
                    // -------------------------

                    h+=`<tr ${clickAttr} class="${rowClass}">
                        <td class="px-2 py-3 font-mono text-gray-500 align-middle text-center">${i+1}</td>
                        <td class="px-2 py-3 font-bold text-white text-sm md:text-base align-middle">
                            <div class="flex items-center">${p.name} ${trendIcon}</div>
                        </td>
                        <td class="px-2 py-3 text-right align-middle">${v(p)}</td>
                    </tr>`;
                });
                
                document.getElementById('stats-content').innerHTML=h+(s.length > 0 ? `</tbody></table>` : '');
            },
            renderPlayerCards() {
                let d=this.calc().p.sort((a,b)=> (b.pts/b.m) - (a.pts/a.m));
                
                // FILTER LOW MATCHES IF TOGGLE IS ON
                if (this.hideLowMatches) {
                    d = d.filter(x => x.m >= 10);
                }

                // Player cards also benefit from seeing trend data (using main points rank)
                const trendData = this.getTrendData('points', 'players');

                document.getElementById('stats-content').innerHTML=`<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${d.map(p=>{
                     const trend = trendData[p.name] || 0;
                     let trendIcon = '';
                     if (!this.hideLowMatches) {
                        if (trend > 0) trendIcon = `<span class="trend-arrow text-green-400 font-black ml-1">‚ñ≤</span>`;
                        else if (trend < 0) trendIcon = `<span class="trend-arrow text-red-400 font-black ml-1">‚ñº</span>`;
                     }
                     
                     return `<div onclick="window.Stats.openProfile('${p.name}')" class="bg-gray-800 p-4 rounded-xl border border-gray-700 cursor-pointer hover:border-indigo-500 transition-colors flex justify-between items-center"><div><h3 class="text-lg font-bold text-white flex items-center gap-1">${p.name} ${trendIcon}</h3><div class="text-xs text-gray-400">${p.m} meczy ‚Ä¢ ${p.g} goli</div></div><div class="text-right"><div class="text-xl font-black text-yellow-400">${(p.pts/(p.m||1)).toFixed(1)}</div><div class="text-[10px] text-gray-500 uppercase">AVG PKT</div></div></div>`
                }).join('')}</div>`;
                
                if(d.length === 0) document.getElementById('stats-content').innerHTML = '<p class="text-center text-gray-500 py-8">Brak danych (lub ukryte).</p>';
            },
            getRank(pName, key, sortType = 'desc') {
                let all = this.calc().p.filter(p=>p.m>0);
                // Filter inside rank calculation as well if needed, but ranks usually imply full pool
                // For now, let's keep rank global, but if filtered view, user sees filtered list
                // If specific filtering is requested for rank numbers too:
                if (this.hideLowMatches) {
                    all = all.filter(p => p.m >= 10);
                }

                const keyMap = {
                    'pts': (p) => p.pts/p.m, 
                    'g': 'g', 'a': 'a', 'dg': 'dg', 'bg': 'bg', 'pg': 'pg', 'fg': 'fg',
                    'g/m': (p) => p.g/p.m, 'w%': (p) => p.w/p.m, 'a/m': (p) => p.a/p.m,
                    'dg/m': (p) => p.dg/p.m, 'bg/m': (p) => p.bg/p.m, 'pg/m': (p) => p.pg/p.m, 'fg/m': (p) => p.fg/p.m
                };
                const sortFn = (a, b) => {
                    const valA = typeof keyMap[key] === 'function' ? keyMap[key](a) : a[keyMap[key]];
                    const valB = typeof keyMap[key] === 'function' ? keyMap[key](b) : b[keyMap[key]];
                    const comparison = (valB || 0) - (valA || 0);
                    return sortType === 'desc' ? comparison : -comparison;
                };
                const sorted = all.sort(sortFn);
                const rank = sorted.findIndex(p => p.name === pName) + 1;
                return rank > 0 ? rank : '-';
            },
            getSmartTagline(p) {
                if (!p || p.m === 0) return "Czeka na debiut.";
                const avgG = p.g / p.m;
                const winRate = p.w / p.m;
                const avgA = p.a / p.m;
                
                let worstEnemy = null;
                let maxLosses = 0;
                for (const [enemy, stats] of Object.entries(p.nemesis)) {
                    if (stats.l > maxLosses && stats.l > 1) { 
                        maxLosses = stats.l;
                        worstEnemy = enemy;
                    }
                }
                
                if (worstEnemy && maxLosses > p.m * 0.4) {
                    return `Ofiara gracza ${worstEnemy}.`;
                }
                if (worstEnemy && maxLosses > 3) {
                    return `Koszmar: ${worstEnemy}.`;
                }
                
                if (winRate === 0 && p.m > 2) return "Dostarczyciel darmowych punkt√≥w.";
                if (winRate < 0.2 && p.m > 4) return "Gra, bo mama mu pozwoli≈Ça.";
                if (winRate < 0.3) return "Ch≈Çopiec do bicia.";

                if (winRate === 1 && p.m > 2) return "Niepokonany.";
                if (winRate > 0.8 && p.m > 5) return "Niszczyciel dobrej zabawy.";
                if (winRate > 0.7) return "Dominator.";

                const penRatio = p.pg / (p.g || 1);
                if (p.pg > 3 && penRatio > 0.3) return "Nurek. Szuka faulu w szatni.";
                if (p.pg > 4) return "Kr√≥l jedenastek.";

                const distRatio = p.dg / (p.g || 1);
                if (p.dg > 3 && distRatio > 0.4) return "Laga bonito.";
                if (p.dg > 2 && distRatio > 0.6) return "Boi siƒô pola karnego.";

                if (avgG > 4.0) return "Kupiony sƒôdzia albo fart.";
                if (avgG > 2.5) return "Maszyna do strzelania.";
                if (avgG < 0.2 && p.m > 3) return "≈ölepy snajper.";
                if (avgG === 0 && p.m > 3) return "Bramka jest tam ->";

                if (avgA > 2.0) return "Kelner. Podaje do sto≈Çu.";
                if (avgA > 1.5) return "Widzi wiƒôcej ni≈º inni.";

                let bestBro = null;
                let maxGamesTogether = 0;
                for (const [bro, count] of Object.entries(p.partners)) {
                   if (count > maxGamesTogether) {
                       maxGamesTogether = count;
                       bestBro = bro;
                   }
                }
                if (bestBro && maxGamesTogether > p.m * 0.6 && winRate > 0.6) {
                    return `Bez gracza ${bestBro} nie istnieje.`;
                }

                const randomPool = [
                    "Forma jest, tylko wynik√≥w brak.",
                    "Legenda (we w≈Çasnej g≈Çowie).",
                    "Zawsze gro≈∫ny... dla swojej dru≈ºyny.",
                    "Technika u≈ºytkowa: brak.",
                    "Serce do walki, nogi z drewna.",
                    "Dzi≈õ jego dzie≈Ñ (chyba).",
                    "Taktyczny geniusz.",
                    "Kr√≥l ≈õrodka pola.",
                    "Profesor futbolu.",
                    "Cichy zab√≥jca.",
                    "M≈Çody talent (od 10 lat).",
                    "Joker.",
                    "Specjalista od zada≈Ñ niemo≈ºliwych.",
                    "Lider szatni.",
                    "Mistrz painta.",
                    "Biega mƒÖdrze, a nie szybko."
                ];

                return randomPool[Math.floor(Math.random() * randomPool.length)];
            },
            openProfile(n) {
                const all=this.calc().p.filter(p=>p.m>0); const p=all.find(x=>x.name===n); if(!p)return;
                const pct=v=>p.m?Math.round(v/p.m*100):0;
                const avg=(v,m)=>m?(v/m).toFixed(2):'0.00';
                const playerInitials = (p.name.match(/\b\w/g) || [p.name[0]]).join('').substring(0, 2).toUpperCase();
                const defaultColor = stringToHslColor(p.name, 70, 50);
                const tagline = this.getSmartTagline(p);
                
                const meta = DataManager.getMeta()[n] || {};
                let photoHtml = '';
                
                if (meta.emoji) {
                     const bg = meta.color || defaultColor;
                     photoHtml = `<div onclick="AvatarEditor.open('${n}')" class="w-full h-full rounded-full flex items-center justify-center text-5xl border-4 border-white/20 shadow-lg cursor-pointer hover:opacity-80 transition-opacity" style="background-color: ${bg};">${meta.emoji}</div>`;
                } else {
                     photoHtml = `<div onclick="AvatarEditor.open('${n}')" class="w-full h-full rounded-full flex items-center justify-center text-4xl font-black shadow-lg border-4 border-white/20 cursor-pointer hover:opacity-80 transition-opacity" style="background-color: ${defaultColor};">${playerInitials}</div>`;
                }

                const getTop3Clubs = (obj) => Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`<div class="flex justify-between text-xs"><span class="text-gray-300">${x[0]}</span><span class="font-bold">${x[1]} (${pct(x[1])}%)</span></div>`).join('');
                const nemEntries = Object.entries(p.nemesis).filter(([,data])=>data.count>0).sort((a,b)=>b[1].l - a[1].l).slice(0,3);
                const renderNem = nemEntries.map(x=>`<div class="flex justify-between text-xs"><span class="text-red-300">${x[0]}</span><span class="font-bold text-white text-[10px] tracking-tighter">${x[1].w}-${x[1].d}-${x[1].l} (M:${x[1].count})</span></div>`).join('');
                const partnerEntries = Object.entries(p.partners).filter(([,count])=>count>0).sort((a,b)=>b[1]-a[1]).slice(0,3);
                const renderPartners = partnerEntries.map(x=>`<div class="flex justify-between text-xs"><span class="text-blue-300">${x[0]}</span><span class="font-bold text-white">${x[1]} mecz. (${p.allPartners?Math.round(x[1]/p.allPartners*100):0}%)</span></div>`).join('');
                const allRanks = [
                    {key: 'a/m', label: '≈ör. Asyst', dataFunc: (p)=>avg(p.a,p.m), unit: '≈ör.'},
                    {key: 'dg/m', label: 'Gole z Dystansu', dataFunc: (p)=>avg(p.dg,p.m), unit: '≈ör.'},
                    {key: 'bg/m', label: 'Gole z Pola', dataFunc: (p)=>avg(p.bg,p.m), unit: '≈ör.'},
                    {key: 'pg/m', label: 'Gole z Karnych', dataFunc: (p)=>avg(p.pg,p.m), unit: '≈ör.'},
                    {key: 'fg/m', label: 'Gole z Wolnych', dataFunc: (p)=>avg(p.fg,p.m), unit: '≈ör.'},
                ];
                const mainRankings = [
                    {key: 'pts', label: 'Ranking MVP', value: `${p.pts} <span class="text-xs text-gray-400">(≈ör. ${avg(p.pts, p.m)})</span>`, statKey: 'pts', unit: ''},
                    {key: 'w%', label: 'Skuteczno≈õƒá %', value: pct(p.w), statKey: 'w%', unit: '%'},
                    {key: 'g/m', label: 'Gole/Mecz', value: avg(p.g, p.m), statKey: 'g/m', unit: '≈ör.'},
                ];

                const renderMatchInfo = (m, type) => {
                    if(!m || m.diff === -99 || m.diff === 99) return '<span class="text-gray-500 italic">Brak danych</span>';
                    const color = type === 'win' ? 'text-green-400' : 'text-red-400';
                    return `
                        <div class="text-[10px] text-gray-300 mb-1">${m.date.split(',')[0]}</div>
                        <div class="font-bold ${color}">${m.myTeam} <span class="text-white">${m.myScore}:${m.oppScore}</span> ${m.oppTeam}</div>
                        <div class="text-[9px] text-gray-400 mt-0.5 tracking-tighter">${m.myPlayers.join(' & ')} vs ${m.oppPlayers.join(' & ')}</div>
                    `;
                };

                document.getElementById('player-profile-content').innerHTML=`
                    <div class="flex flex-col items-center mb-6">
                        <div class="relative w-24 h-24 mb-3 group">
                             ${photoHtml}
                        </div>
                        <h2 class="text-3xl font-black text-white uppercase tracking-wider mb-1">${p.name}</h2>
                        <div class="text-xs text-yellow-400 font-bold italic tracking-wide">"${tagline}"</div>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-[10px] text-gray-500 uppercase tracking-widest text-center mb-2 font-bold">G≈Ç√≥wne Rankingi</h3>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            ${mainRankings.map(r=>`<div class="stat-card main-stat-card"><div class="main-stat-val text-yellow-400">#${this.getRank(p.name, r.statKey)}</div><div class="stat-label text-yellow-200 font-bold mb-1">${r.label}</div><div class="text-base font-bold text-white">${r.value} ${r.unit}</div></div>`).join('')}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-center">
                        <div class="stat-card"><div class="stat-val text-green-400">${p.w}</div><div class="stat-label">Wygrane (${pct(p.w)}%)</div></div>
                        <div class="stat-card"><div class="stat-val text-gray-400">${p.d}</div><div class="stat-label">Remisy (${pct(p.d)}%)</div></div>
                        <div class="stat-card"><div class="stat-val text-red-400">${p.l}</div><div class="stat-label">Pora≈ºki (${pct(p.l)}%)</div></div>
                        <div class="stat-card"><div class="stat-val text-white">${p.m}</div><div class="stat-label">Mecze</div></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/20 p-3 rounded-lg border border-green-500/30 text-center">
                            <div class="text-[10px] text-green-400 uppercase font-bold mb-1">Najwy≈ºsza Wygrana</div>
                            ${renderMatchInfo(p.biggestWin, 'win')}
                        </div>
                        <div class="bg-red-900/20 p-3 rounded-lg border border-red-500/30 text-center">
                            <div class="text-[10px] text-red-400 uppercase font-bold mb-1">Najwy≈ºsza Pora≈ºka</div>
                            ${renderMatchInfo(p.biggestLoss, 'loss')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                         <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50">
                            <div class="text-xs uppercase text-gray-500 font-bold mb-2 border-b border-gray-700 pb-1">Statystyki Goli i Asyst</div>
                            <div class="space-y-1">
                                <div class="flex justify-between text-sm text-blue-300 font-bold"><span>Gole (≈ÅƒÖcznie: ${p.g})</span><span>${avg(p.g, p.m)} ≈ör. / mecz</span></div>
                                <div class="flex justify-between text-sm text-yellow-300 font-bold"><span>Asysty (≈ÅƒÖcznie: ${p.a})</span><span>${avg(p.a, p.m)} ≈ör. / mecz</span></div>
                                <div class="text-[10px] text-gray-400 font-bold pt-2 border-t border-gray-800 mt-2">Rozbicie Goli:</div>
                                <div class="flex justify-between text-xs text-gray-300"><span>Gole z Pola Karnego</span><span class="font-bold">${p.bg}</span></div>
                                <div class="flex justify-between text-xs text-gray-300"><span>Gole z Dystansu</span><span class="font-bold">${p.dg}</span></div>
                                <div class="flex justify-between text-xs text-gray-300"><span>Rzuty Karne</span><span class="font-bold">${p.pg}</span></div>
                                <div class="flex justify-between text-xs text-gray-300"><span>Rzuty Wolne</span><span class="font-bold">${p.fg}</span></div>
                            </div>
                        </div>
                        <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50">
                            <div class="text-xs uppercase text-gray-500 font-bold mb-2 border-b border-gray-700 pb-1">Pozosta≈Çe Rankingi (Statystyka i Pozycja)</div>
                            <div class="space-y-1">
                                ${allRanks.map(r=>`<div class="flex justify-between text-xs text-gray-300"><span>${r.label}</span><span class="font-bold text-yellow-400">${r.dataFunc(p)} ${r.unit} / mecz #${this.getRank(p.name, r.key)}</span></div>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-sm border-t border-gray-700 pt-4">
                        <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50">
                            <div class="text-xs uppercase text-gray-500 font-bold mb-2 border-b border-gray-700 pb-1">Ulubione Kluby (Top 3)</div>
                            <div class="space-y-1">${getTop3Clubs(p.clubs)||'<p class="text-xs text-gray-500">Brak danych.</p>'}</div>
                        </div>
                        <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50">
                            <div class="text-xs uppercase text-gray-500 font-bold mb-2 border-b border-gray-700 pb-1">Najlepsi Partnerzy (Top 3)</div>
                            <div class="space-y-1">${renderPartners||'<p class="text-xs text-gray-500">Brak danych.</p>'}</div>
                        </div>
                        <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50 md:col-span-2">
                             <div class="text-xs uppercase text-gray-500 font-bold mb-2 border-b border-gray-700 pb-1">Nemesis (Top 3 - Bilans W-R-P)</div>
                            <div class="space-y-1">${renderNem||'<p class="text-xs text-gray-500">Brak danych.</p>'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('player-profile-modal').classList.remove('hidden');
            },
            openCompare() {
                 Sound.click(); 
                 let mode = 'players';
                const p1Select = document.getElementById('compare-p1');
                const p2Select = document.getElementById('compare-p2');
                const renderOptions = () => {
                    const data = mode === 'players' ? DataManager.getPlayers() : this.calc().d.map(d=>d.name);
                    const sel1 = p1Select.value;
                    const sel2 = p2Select.value;
                    p1Select.innerHTML = data.map(n => `<option value="${n}" ${n === sel1 ? 'selected' : ''}>${n}</option>`).join('');
                    const currentP1 = p1Select.value;
                    const filteredData = data.filter(n => n !== currentP1);
                    p2Select.innerHTML = filteredData.map(n => `<option value="${n}">${n}</option>`).join('');
                };
                document.getElementById('compare-mode-players').onclick = () => { Sound.click(); mode = 'players'; document.getElementById('compare-mode-players').classList.replace('text-gray-400', 'bg-blue-600'); document.getElementById('compare-mode-players').classList.add('text-white'); document.getElementById('compare-mode-players').classList.remove('hover:text-white'); document.getElementById('compare-mode-duos').classList.replace('bg-blue-600', 'text-gray-400'); document.getElementById('compare-mode-duos').classList.remove('text-white'); document.getElementById('compare-mode-duos').classList.add('hover:text-white'); renderOptions(); document.getElementById('compare-content').classList.add('hidden'); };
                document.getElementById('compare-mode-duos').onclick = () => { Sound.click(); mode = 'duos'; document.getElementById('compare-mode-duos').classList.replace('text-gray-400', 'bg-blue-600'); document.getElementById('compare-mode-duos').classList.add('text-white'); document.getElementById('compare-mode-duos').classList.remove('hover:text-white'); document.getElementById('compare-mode-players').classList.replace('bg-blue-600', 'text-gray-400'); document.getElementById('compare-mode-players').classList.remove('text-white'); document.getElementById('compare-mode-players').classList.add('hover:text-white'); renderOptions(); document.getElementById('compare-content').classList.add('hidden'); };
                p1Select.onchange = () => { Sound.click(); const currentP1 = p1Select.value; const data = mode === 'players' ? DataManager.getPlayers() : this.calc().d.map(d=>d.name); const prevP2 = p2Select.value; const filteredData = data.filter(n => n !== currentP1); p2Select.innerHTML = filteredData.map(n => `<option value="${n}">${n}</option>`).join(''); if (prevP2 !== currentP1 && filteredData.includes(prevP2)) { p2Select.value = prevP2; } };
                renderOptions();
                document.getElementById('compare-content').classList.add('hidden'); 
                document.getElementById('compare-modal').classList.remove('hidden');
                document.getElementById('run-compare-btn').onclick=()=>{
                    const n1=p1Select.value; const n2=p2Select.value;
                    if (!n1 || !n2) { DataManager.showToast("Wybierz dw√≥ch oponent√≥w!", 'error'); return; }
                    const sourceData = mode === 'players' ? this.calc().p.filter(p=>p.m>0) : this.calc().d.filter(d=>d.m>0);
                    const d1 = sourceData.find(x => x.name === n1); const d2 = sourceData.find(x => x.name === n2);
                    if(!d1 || !d2) { DataManager.showToast("Brak danych!", 'error'); return; }
                    if(d1 && d2) {
                        const r = (l, v1, v2, format=v=>v, inverted=false) => {
                             let c1 = 'text-white', c2 = 'text-white';
                             if(v1 !== v2) { const better = inverted ? v1 < v2 : v1 > v2; c1 = better ? 'text-green-400' : 'text-red-400'; c2 = better ? 'text-red-400' : 'text-green-400'; }
                             return `<div class="font-bold text-base ${c1}">${format(v1)}</div><div class="text-xs text-gray-500 uppercase tracking-widest">${l}</div><div class="font-bold text-base ${c2}">${format(v2)}</div>`;
                        };
                        const formatAvg = v => (v||0).toFixed(2);
                        const formatPct = v => `${v}%`;
                        let h = '';
                        h += r('MVP PKT (≈örednia)', d1.pts/d1.m, d2.pts/d2.m, formatAvg);
                        h += r('Gole (≈örednia)', d1.g/d1.m, d2.g/d2.m, formatAvg);
                        h += r('Asysty (≈örednia)', d1.a/d1.m, d2.a/d2.m, formatAvg);
                        h += r('Skuteczno≈õƒá %', d1.m?Math.round(d1.w/d1.m*100):0, d2.m?Math.round(d2.w/d2.m*100):0, formatPct);
                        h += r('Gole z Dystansu (≈ör.)', d1.dg/d1.m, d2.dg/d2.m, formatAvg);
                        h += r('Gole z Pola (≈ör.)', d1.bg/d1.m, d2.bg/d2.m, formatAvg);
                        h += r('Rzuty Karne (≈ör.)', d1.pg/d1.m, d2.pg/d2.m, formatAvg);
                        h += r('Rzuty Wolne (≈ör.)', d1.fg/d1.m, d2.fg/d2.m, formatAvg);
                        h += r('Wygrane (Suma)', d1.w, d2.w);
                        h += r('Pora≈ºki (Suma)', d1.l, d2.l, v=>v, true);
                        document.getElementById('compare-content').innerHTML = h;
                        document.getElementById('compare-content').classList.remove('hidden');
                    }
                };
            }
        };

        const ManualSelect = {
            targetSlot: null,
            init() {
            },
            open(isIngame, slot) {
                 Sound.click();
                 this.targetSlot = slot;
                 document.getElementById('manual-select-modal').classList.remove('hidden');
                 const leagues = ['All', 'All_NoRow', 'Premier League', 'La Liga', 'Bundesliga', 'Serie A', 'Ligue 1', 'Saudi Pro League', 'Rest of World', 'National'];
                 const container = document.getElementById('manual-league-list');
                 const labels = { 'All': 'Wszystkie', 'All_NoRow': 'Wszystkie (Bez R.≈öwiat)', 'Rest of World': 'Reszta ≈öwiata', 'National': 'Reprezentacje' };
                 container.innerHTML = leagues.map(l => `<button class="px-3 py-1 bg-gray-700 rounded text-xs hover:bg-indigo-600 transition" onclick="window.ManualSelect.renderGrid('${l}', ${isIngame})">${labels[l] || l}</button>`).join('');
                 this.renderGrid('All', isIngame);
            },
            renderGrid(league, isIngame) {
                const p = window.PlayerManager.getFilteredPool(false).filter(t => {
                    if (league === 'All') return true;
                    if (league === 'All_NoRow') return t.league !== 'Rest of World';
                    if (league === 'Clubs') return t.league !== 'National';
                    return t.league === league;
                });
                const grid = document.getElementById('manual-team-grid');
                grid.innerHTML = p.map(t => {
                    const burnt = AppState.usedTeams.includes(t.name);
                    const flagOrImg = t.flag ? `<div class="text-xl mb-1">${t.flag}</div>` : `<img src="${getTeamLogoUrl(t)}" class="w-8 h-8 mx-auto mb-1 object-contain" onerror="handleImgError(this)" data-team='${JSON.stringify(t)}'>`;
                    return `
                    <div class="bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 border ${burnt ? 'border-red-500 opacity-50' : 'border-gray-600'}" onclick="window.ManualSelect.select('${t.name}', ${isIngame})">
                        ${flagOrImg}
                        <div class="text-[10px] font-bold truncate">${t.name}</div>
                        <div class="text-[9px] text-yellow-400 font-bold">${t.stars}‚òÖ</div>
                        ${burnt ? '<div class="text-[8px] text-red-400">U≈ªYTA</div>' : ''}
                    </div>`;
                }).join('');
            },
            select(name, isIngame) {
                Sound.click();
                const team = window.teamsData.find(t => t.name === name);
                if (AppState.usedTeams.includes(name)) { DataManager.showToast("Ta dru≈ºyna by≈Ça ju≈º u≈ºyta!", 'error'); return; }
                
                document.getElementById('manual-select-modal').classList.add('hidden');
                
                if (isIngame) {
                    if (this.targetSlot === 1) AppState.finalTeam1 = team;
                    else AppState.finalTeam2 = team;
                    
                    window.PlayerManager.renderCard(`team${this.targetSlot}-panel`, team);
                    window.PlayerManager.checkBurnt(this.targetSlot, team);
                    
                    if(AppState.finalTeam1 && AppState.finalTeam2) {
                        document.getElementById('draw-teams-btn').classList.add('hidden');
                        document.getElementById('team1-actions').classList.remove('hidden');
                        document.getElementById('team2-actions').classList.remove('hidden');
                        
                        window.PlayerManager.bindActionButtons();
                    }
                    DataManager.showToast(`Wybrano: ${team.name}`);
                }
            }
        }

        window.DataManager = DataManager;
        window.Settings = Settings;
        window.MatchRecorder = MatchRecorder;
        window.PlayerManager = PlayerManager;
        window.PostMatchMenu = PostMatchMenu;
        window.Stats = Stats;
        window.ManualSelect = ManualSelect;
        window.MatchEditor = MatchEditor;
        window.AvatarEditor = AvatarEditor;

        PlayerManager.checkBurnt = function(n,t){
            const b=document.getElementById(`keep-btn-${n}`); 
            const burnt=AppState.usedTeams.includes(t.name);
            if(burnt){
                b.disabled=true;
                b.classList.add('opacity-50','cursor-not-allowed','bg-gray-600');
                b.classList.remove('bg-green-600');
                b.innerText="ZABLOKOWANA";
            } else {
                b.disabled=false;
                b.classList.remove('opacity-50','cursor-not-allowed','bg-gray-600');
                b.classList.add('bg-green-600');
                b.innerText="BIORƒò";
            }
        };
        
        PlayerManager.getFilteredPool = function(drawing=false){ 
            const all=window.teamsData; 
            let p=all.filter(t=>t.stars>=AppState.minStars&&t.stars<=AppState.maxStars); 
            if(AppState.selectedLeague!=='All') {
                 if(AppState.selectedLeague === 'All_NoRow') {
                     p=p.filter(t=>t.league !== 'Rest of World');
                 } else {
                    p=p.filter(t=>t.league===AppState.selectedLeague||(AppState.selectedLeague==='Clubs'&&t.league!=='National')); 
                 }
            }
            return p; 
        };
        
        PlayerManager.handleReroll = async function(n){
            const btn = document.getElementById(`reroll-btn-${n}`);
            if(btn) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            const otherN = n === 1 ? 2 : 1;
            const otherRerollBtn = document.getElementById(`reroll-btn-${otherN}`);
            const otherKeepBtn = document.getElementById(`keep-btn-${otherN}`);
            if(otherRerollBtn) otherRerollBtn.disabled = true;
            if(otherKeepBtn) otherKeepBtn.disabled = true;

            try {
                Sound.click(); 
                const k = `p${n}`; 
                
                const currentTeam = n === 1 ? AppState.finalTeam1 : AppState.finalTeam2;
                const isFreeReroll = currentTeam && AppState.usedTeams.includes(currentTeam.name);

                if(!isFreeReroll && AppState.rerolls[k] <= 0) return; 

                AppState.rerolls[k]--; 
                document.getElementById(`rerolls-left-${n}`).innerText = AppState.rerolls[k];
                
                const ex = [AppState.finalTeam1.name, AppState.finalTeam2.name]; 
                const p = window.PlayerManager.getFilteredPool(true).filter(t => !ex.includes(t.name));
                if(p.length === 0){ DataManager.showToast("Brak dru≈ºyn do losowania!", 'error'); return; }
                const pid = `team${n}-panel`; 
                
                const ft = p[Math.floor(Math.random() * p.length)];
                
                const w1 = document.getElementById('wrapper-t1');
                const w2 = document.getElementById('wrapper-t2');
                if(n === 1) { w1.classList.remove('flex-1'); w1.classList.add('flex-[1.5]'); w2.classList.remove('flex-1'); w2.classList.add('flex-[0.5]'); }
                else { w2.classList.remove('flex-1'); w2.classList.add('flex-[1.5]'); w1.classList.remove('flex-1'); w1.classList.add('flex-[0.5]'); }

                await new Promise(r => setTimeout(r, 600)); 

                const resultTeam = await runRouletteGlobal(pid, ft, p);
                
                w1.classList.add('flex-1'); w1.classList.remove('flex-[1.5]', 'flex-[0.5]');
                w2.classList.add('flex-1'); w2.classList.remove('flex-[1.5]', 'flex-[0.5]');

                if(!resultTeam) return;

                if(AppState.usedTeams.includes(resultTeam.name)) {
                    AppState.rerolls[k]++;
                    document.getElementById(`rerolls-left-${n}`).innerText = AppState.rerolls[k];
                    DataManager.showToast("Dru≈ºyna spalona! Zwrot losu.");
                }
                
                if(n === 1) AppState.finalTeam1 = ft; else AppState.finalTeam2 = ft;
                window.PlayerManager.checkBurnt(n, ft);
                Sound.confirm();
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if(otherRerollBtn) otherRerollBtn.disabled = false;
                if(otherKeepBtn) {
                     const otherTeamObj = n === 1 ? AppState.finalTeam2 : AppState.finalTeam1;
                     const isBurnt = AppState.usedTeams.includes(otherTeamObj.name);
                     otherKeepBtn.disabled = isBurnt;
                }
            }
        };

        PlayerManager.renderCard = function(id,t){
            const el=document.getElementById(id); 
            const td=JSON.stringify(t); 
            el.classList.remove('overflow-hidden');
el.className = 'team-card-dynamic rounded-3xl p-4 relative transition-all duration-500 flex flex-col items-center justify-center h-full';            
            const b=AppState.usedTeams.includes(t.name); 
            if(b)el.classList.add('team-card-burnt'); else el.classList.remove('team-card-burnt');
            el.style.background=`linear-gradient(135deg, ${t.colors.p}, ${t.colors.s})`;
            
            const l=getTeamLogoUrl(t); 
            const img=t.flag ? `<div class="vs-crest-flag text-7xl md:text-8xl drop-shadow-lg mb-2">${t.flag}</div>` : `<img src="${l}" class="w-24 h-24 md:w-32 md:h-32 object-contain drop-shadow-xl mb-2 shrink-0" data-team='${td}' onerror="handleImgError(this)">`;
            const ov=b?`<div class="burnt-overlay"><div class="burnt-text">SPALONA</div></div>`:'';
            
            // --- NEW: TEAM FACT BADGE ---
            let badgeHtml = '';
            if (!b) { // Pokazuj tylko je≈õli nie jest spalona
                // Determine players based on panel ID
                const isTeam1 = id === 'team1-panel';
                const players = isTeam1 ? AppState.playersTeam1 : AppState.playersTeam2;
                const fact = this.generateTeamFact(t, players);
                const badgeClass = isTeam1 ? 'badge-left' : 'badge-right';
                badgeHtml = `<div class="team-fact-badge ${badgeClass}">${fact}</div>`;
            }
            // -----------------------------
// LOGIKA SKALOWANIA CZCIONKI NAZWY KLUBU
            let nameSizeClass = 'text-2xl md:text-4xl'; // Domy≈õlna (du≈ºa)
            if (t.name.length > 20) {
                nameSizeClass = 'text-sm md:text-lg'; // Bardzo d≈Çuga nazwa
            } else if (t.name.length > 12) {
                nameSizeClass = 'text-lg md:text-2xl'; // ≈örednio d≈Çuga
            }
            el.innerHTML=`${ov}${badgeHtml}<div class="team-info-content animate-pop p-2">${img}<h2 class="${nameSizeClass} font-black text-white text-center leading-none text-shadow-strong uppercase tracking-tighter mb-1">${t.name}</h2><div class="text-yellow-300 text-xl md:text-3xl font-bold mt-1 drop-shadow-md">${'‚òÖ'.repeat(Math.floor(t.stars))+(t.stars%1?'¬Ω':'')}</div>${getLeagueLogoHTML(t.league)}</div>`;
        };
        
        PlayerManager.showVS = async function(){
            const o=document.getElementById('vs-overlay'); const l=document.getElementById('vs-content-left'); const r=document.getElementById('vs-content-right');const gl=(t)=>{const u=getTeamLogoUrl(t);if(t.flag)return `<div class="vs-crest-flag">${t.flag}</div>`;return `<img src="${u}" class="vs-crest-img" data-team='${JSON.stringify(t)}' onerror="handleImgError(this)">`;};l.innerHTML=gl(AppState.finalTeam1); r.innerHTML=gl(AppState.finalTeam2);document.getElementById('vs-left-panel').style.background=AppState.finalTeam1.colors.p; document.getElementById('vs-right-panel').style.background=AppState.finalTeam2.colors.p;o.classList.add('active'); Sound.clash(); await new Promise(r=>setTimeout(r,3000)); o.classList.remove('active'); await new Promise(r=>setTimeout(r,1000)); document.getElementById('results-container').classList.remove('hidden');document.getElementById('results-scroll-target').scrollIntoView({ behavior: 'smooth' }); window.PlayerManager.simulateFullMatch();
        };

        PlayerManager.simulateFullMatch = async function(){
            window.PlayerManager.renderRerollAlternatives(document.getElementById('alt-list-1'), 1); 
            window.PlayerManager.renderRerollAlternatives(document.getElementById('alt-list-2'), 2);
            
            const s1=document.getElementById('score-team-1'); 
            const s2=document.getElementById('score-team-2'); 
            const detailsEl=document.getElementById('match-details');
            const logEl=document.getElementById('match-events-log');
            
            detailsEl.innerText = "Analiza...";
            logEl.innerHTML = "";
            
            await new Promise(r => setTimeout(r, 1500)); 
            
            let score1 = 0;
            let score2 = 0;
            let log = [];
            
            const power1 = AppState.finalTeam1.stars;
            const power2 = AppState.finalTeam2.stars;
            
            const p1Stats = Stats.calc().p.find(p => p.name === AppState.playersTeam1[0]) || {g:0, m:1};
            const p2Stats = Stats.calc().p.find(p => p.name === AppState.playersTeam2[0]) || {g:0, m:1};
            const p1Form = p1Stats.g / (p1Stats.m || 1);
            const p2Form = p2Stats.g / (p2Stats.m || 1);
            
            const diff = (power1 + p1Form) - (power2 + p2Form);
            const baseGoals = 3;
            
            score1 = Math.floor(Math.random() * baseGoals) + (diff > 0.5 ? 1 : 0);
            score2 = Math.floor(Math.random() * baseGoals) + (diff < -0.5 ? 1 : 0);
            
            const createEvents = (teamIndex, count) => {
                const players = teamIndex === 1 ? AppState.playersTeam1 : AppState.playersTeam2;
                for(let k=0; k<count; k++) {
                    const scorer = players[Math.floor(Math.random()*players.length)];
                    const type = Math.random() > 0.8 ? "(Dystans)" : (Math.random() > 0.9 ? "(Karny)" : "");
                    log.push(`‚öΩ ${scorer} ${type}`);
                }
            };
            
            createEvents(1, score1);
            createEvents(2, score2);
            
            s1.innerText = score1;
            s2.innerText = score2;
            detailsEl.innerText = score1 > score2 ? `WYGRANA: ${AppState.finalTeam1.name}` : (score2 > score1 ? `WYGRANA: ${AppState.finalTeam2.name}` : "REMIS");
            logEl.innerHTML = log.join('<br>');
            
            Sound.fanfare();
        };

        PlayerManager.renderRerollAlternatives = function(c, teamNumber){c.innerHTML=''; const maxRerolls = teamNumber === 1 ? AppState.rerollSettings : AppState.rerollSettings; let currentRerolls = teamNumber === 1 ? AppState.rerolls.p1 : AppState.rerolls.p2;const otherTeamName = teamNumber === 1 ? AppState.finalTeam2.name : AppState.finalTeam1.name;const currentDrawnTeamName = teamNumber === 1 ? AppState.finalTeam1.name : AppState.finalTeam2.name;if (currentRerolls === 0) { c.innerHTML = '<div class="text-xs text-red-400 font-bold">Brak dostƒôpnych przelosowa≈Ñ.</div>'; return; }let potentialPool = window.PlayerManager.getFilteredPool(true);potentialPool = potentialPool.filter(t => t.name !== otherTeamName && t.name !== currentDrawnTeamName);if (potentialPool.length === 0) { c.innerHTML = '<div class="text-xs text-red-400 font-bold">Brak dru≈ºyn spe≈ÇniajƒÖcych kryteria!</div>'; return; }let teamsToDisplay = [];let drawIndex = 0;let shuffledPool = potentialPool.sort(() => 0.5 - Math.random());let simulatedAttempts = 0;while (simulatedAttempts < currentRerolls) {if (teamsToDisplay.length > currentRerolls * 3 || drawIndex > potentialPool.length * 5) break;let drawnTeam = shuffledPool[drawIndex % shuffledPool.length];drawIndex++;const isBurnt = AppState.usedTeams.includes(drawnTeam.name);teamsToDisplay.push({ team: drawnTeam, isBurnt: isBurnt, isReplacement: false });simulatedAttempts++; if (isBurnt) {currentRerolls++; let replacementTeam = null;let replacementAttempts = 0;while (!replacementTeam && replacementAttempts < potentialPool.length) { const nextDraw = shuffledPool[drawIndex % shuffledPool.length]; if (!AppState.usedTeams.includes(nextDraw.name)) { replacementTeam = nextDraw; } drawIndex++; replacementAttempts++;}if (replacementTeam) { teamsToDisplay.push({ team: replacementTeam, isBurnt: false, isReplacement: true }); }}}teamsToDisplay.forEach((item, i) => { const t = item.team;const u = item.isBurnt;const isRep = item.isReplacement;let cl = 'text-white'; if(t.stars>=5)cl='text-red-500 font-black'; else if(t.stars>=4.5)cl='text-yellow-400 font-bold'; else if(t.stars>=4)cl='text-green-400 font-bold';const d = document.createElement('div');d.className = `fade-in-seq text-xs md:text-sm`; d.style.animationDelay = `${i * 100}ms`;let text = `${t.name} (${t.stars.toFixed(1)}‚òÖ)`;if (u) { d.innerHTML = `<span class="font-bold text-red-400">&#10006; SPALONA:</span> <span class="${cl}" style="text-decoration: line-through; opacity: 0.7;">${text}</span>`; } else if (isRep) { d.innerHTML = `<span class="font-bold text-white">‚Ü≥ ZAMIANA (ZWROT LOSU):</span> <span class="${cl}">${text}</span>`; d.style.marginTop = '0px'; d.style.paddingLeft = '16px'; } else { d.innerHTML = `<span class="font-bold text-yellow-400">&#9658;</span> <span class="${cl}">${text}</span>`; }c.appendChild(d);});if (teamsToDisplay.length === 0) { c.innerHTML = '<div class="text-xs text-gray-500">Brak dostƒôpnych nowych dru≈ºyn w puli.</div>'; }}

        async function runRouletteGlobal(panelId, winner, pool) {
            window.abortController.aborted = false; 
            const panel = document.getElementById(panelId);
            panel.className = 'roulette-container border-2 border-gray-700';
            panel.style.background = '#111';
            panel.innerHTML = `
                <div class="roulette-indicator"></div>
                <div class="roulette-strip" id="${panelId}-strip"></div>
            `;
            
            const strip = document.getElementById(`${panelId}-strip`);
            const cardWidth = 160; 
            const winnerIndex = 30; 
            const totalItems = 45; 
            
            let html = '';
            for(let i=0; i<totalItems; i++) {
                const t = (i === winnerIndex) ? winner : pool[Math.floor(Math.random() * pool.length)];
                const rarity = getRarityClass(t);
                const img = getTeamLogoUrl(t);
                const flagHtml = t.flag ? `<div class="text-3xl filter drop-shadow-md mb-2">${t.flag}</div>` : `<img src="${img}" class="w-16 h-16 object-contain mb-2" onerror="handleImgError(this)" data-team='${JSON.stringify(t)}'>`;
                
                html += `
                    <div class="roulette-item ${rarity}">
                        ${flagHtml}
                        <div class="text-[10px] font-bold text-center leading-tight px-1">${t.name}</div>
                        <div class="text-[9px] text-yellow-500">${t.stars}‚òÖ</div>
                    </div>
                `;
            }
            strip.innerHTML = html;
            
            const winnerPosition = (winnerIndex * cardWidth) + (cardWidth / 2);
            
            const containerCenter = panel.offsetWidth / 2;
            
            const jitter = (Math.random() * 158) - 79; 
            
            const offset = containerCenter - winnerPosition + jitter;
            
            let startTime = null;
            let lastCardIndex = -1;
            const duration = 6000; 
            
            return new Promise((resolve) => {
                const animate = (timestamp) => {
                    if (window.abortController.aborted) {
                        resolve(null);
                        return;
                    }

                    if (!startTime) {
                        strip.style.transition = `transform ${duration}ms cubic-bezier(0.05, 1, 0.1, 1)`; 
                        strip.style.transform = `translateX(${offset}px)`;
                        startTime = timestamp;
                    }

                    const stripRect = strip.getBoundingClientRect();
                    const panelRect = panel.getBoundingClientRect();
                    const needleX = panelRect.left + (panelRect.width / 2);
                    
                    const relativeNeedleX = needleX - stripRect.left;
                    
                    const currentCardIndex = Math.floor(relativeNeedleX / cardWidth);

                    if (currentCardIndex !== lastCardIndex && currentCardIndex >= 0) {
                        Sound.tick();
                        lastCardIndex = currentCardIndex;
                    }

                    if (timestamp - startTime < duration) {
                        requestAnimationFrame(animate);
                    } else {
                         setTimeout(() => {
                             if(!window.abortController.aborted) {
                                 window.PlayerManager.renderCard(panelId, winner);
                                 resolve(winner);
                             }
                         }, 500);
                    }
                };
                requestAnimationFrame(animate);
            });
        }

        PlayerManager.bindActionButtons = function() {
            let r1 = false, r2 = false; 
            const chk = () => { if(r1 && r2) window.PlayerManager.showVS(); };
            
            document.getElementById('reroll-btn-1').onclick = () => window.PlayerManager.handleReroll(1); 
            document.getElementById('reroll-btn-2').onclick = () => window.PlayerManager.handleReroll(2);
            document.getElementById('keep-btn-1').onclick = () => { if(AppState.usedTeams.includes(AppState.finalTeam1.name)) return; r1 = true; document.getElementById('team1-actions').classList.add('invisible'); document.getElementById('team1-panel').classList.add('border-green-500','border-4'); Sound.confirm(); chk(); }; 
            document.getElementById('keep-btn-2').onclick = () => { if(AppState.usedTeams.includes(AppState.finalTeam2.name)) return; r2 = true; document.getElementById('team2-actions').classList.add('invisible'); document.getElementById('team2-panel').classList.add('border-green-500','border-4'); Sound.confirm(); chk(); };
            
            document.getElementById('rerolls-left-1').innerText = AppState.rerolls.p1; 
            document.getElementById('rerolls-left-2').innerText = AppState.rerolls.p2;
        };

        document.addEventListener('DOMContentLoaded', () => {
            Settings.init();
            ManualSelect.init();
            document.getElementById('reset-btn').onclick=()=>{Sound.click();PostMatchMenu.newSquads();};
            ['min-stars','max-stars'].forEach(id=>{document.getElementById(id).addEventListener('input',(e)=>{Sound.click();const v=parseFloat(e.target.value);if(id==='min-stars'){AppState.minStars=v;document.getElementById('min-stars-value').textContent=v.toFixed(1);}else{AppState.maxStars=v;document.getElementById('max-stars-value').textContent=v.toFixed(1);}PlayerManager.saveCurrentState();});});
            const updReroll=()=>{document.getElementById('rerolls-value').textContent=AppState.rerollSettings;PlayerManager.saveCurrentState();};
            document.getElementById('reroll-minus-btn').addEventListener('click',()=>{if(AppState.rerollSettings>0)AppState.rerollSettings--;updReroll();Sound.click();});
            document.getElementById('reroll-plus-btn').addEventListener('click',()=>{if(AppState.rerollSettings<10)AppState.rerollSettings++;updReroll();Sound.click();});
            document.getElementById('league-filters').addEventListener('click',(e)=>{if(e.target.classList.contains('league-btn')){document.querySelectorAll('.league-btn').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');AppState.selectedLeague=e.target.dataset.league;Sound.click();PlayerManager.saveCurrentState();}});
            document.getElementById('start-drawing-btn').onclick = () => {
                Sound.click();
                
                const n1 = AppState.playersTeam1.join(' & ');
                const n2 = AppState.playersTeam2.join(' & ');
                
                // 1. POKAZUJEMY EKRAN
                document.getElementById('step2-screen').classList.add('hidden');
                document.getElementById('drawing-screen').classList.remove('hidden');
                
                const p1El = document.getElementById('p1-name-display');
                const p2El = document.getElementById('p2-name-display');
                
                // 2. FUNKCJA FIT-TEXT (Zoptymalizowana)
                const fitText = (el, text, colorClass, alignClass) => {
                    el.innerText = text;
                    el.style.display = 'inline-block';
                    el.style.width = 'auto';
                    el.style.fontSize = '80px'; 
                    el.className = `${alignClass} ${colorClass} font-black uppercase tracking-tighter drop-shadow-md leading-none whitespace-nowrap px-1 transition-none`;
                    
                    // Margines 5px zamiast 20px, aby tekst by≈Ç bli≈ºej H2H
                    const maxWidth = el.parentElement.clientWidth - 5;
                    let size = 80;
                    
                    while (el.offsetWidth > maxWidth && size > 10) {
                        size -= 1;
                        el.style.fontSize = size + 'px';
                    }
                    
                    el.style.display = 'block';
                    el.style.width = '100%';
                    el.classList.add('truncate');
                };

                // NAPRAWA: Czekamy jeden cykl od≈õwie≈ºania (Frame), a≈º przeglƒÖdarka przeliczy szeroko≈õƒá kontener√≥w
                requestAnimationFrame(() => {
                    fitText(p1El, n1, 'text-blue-300', 'text-left');
                    fitText(p2El, n2, 'text-red-300', 'text-right');
                });
                
                window.PlayerManager.updateH2H();
                
                document.getElementById('alt-header-1').innerText = `Gdyby≈õ losowa≈Ç dalej (${n1})`;
                document.getElementById('alt-header-2').innerText = `Gdyby≈õ losowa≈Ç dalej (${n2})`;
                
                document.getElementById('abort-draw-btn').classList.remove('hidden');
                document.getElementById('manual-btn-1').classList.remove('hidden');
                document.getElementById('manual-btn-2').classList.remove('hidden');
            };
            
            PlayerManager.bindActionButtons();

            document.getElementById('draw-teams-btn').onclick=async function(){
                this.disabled=true; this.classList.add('opacity-50'); Sound.clash();
                window.abortController.aborted = false; 

                AppState.rerolls.p1 = AppState.rerollSettings; 
                AppState.rerolls.p2 = AppState.rerollSettings;
                
                let t1 = AppState.finalTeam1;
                let t2 = AppState.finalTeam2;
                
                const p = window.PlayerManager.getFilteredPool(true);
                if(p.length < 2){ DataManager.showToast("Za ma≈Ço dru≈ºyn do wylosowania!", 'error'); this.disabled=false; this.classList.remove('opacity-50'); return; }
                
                if (!t1) {
                    const pool1 = t2 ? p.filter(x => x.name !== t2.name) : p;
                    t1 = pool1[Math.floor(Math.random() * pool1.length)];
                }
                
                if (!t2) {
                    const pool2 = p.filter(x => x.name !== t1.name);
                    t2 = pool2[Math.floor(Math.random() * pool2.length)];
                }

                AppState.finalTeam1 = t1; 
                AppState.finalTeam2 = t2;
                
                const promises = [];
                if (!document.getElementById('team1-panel').classList.contains('team-card-dynamic')) {
                    promises.push(runRouletteGlobal('team1-panel', t1, p));
                }
                
                if (!document.getElementById('team2-panel').classList.contains('team-card-dynamic')) {
                    promises.push(runRouletteGlobal('team2-panel', t2, p));
                }

                await Promise.all(promises);

                if(window.abortController.aborted) return;
                
                if(AppState.usedTeams.includes(t1.name)) { AppState.rerolls.p1++; DataManager.showToast("Dru≈ºyna 1 Spalona: Zwrot losu"); }
                if(AppState.usedTeams.includes(t2.name)) { AppState.rerolls.p2++; DataManager.showToast("Dru≈ºyna 2 Spalona: Zwrot losu"); }
                
                Sound.confirm();
                this.classList.add('hidden'); 
                document.getElementById('manual-btn-1').classList.add('hidden');
                document.getElementById('manual-btn-2').classList.add('hidden');
                
                document.getElementById('team1-actions').classList.remove('hidden'); 
                document.getElementById('team2-actions').classList.remove('hidden');
                window.PlayerManager.checkBurnt(1, t1); 
                window.PlayerManager.checkBurnt(2, t2);
                
                window.PlayerManager.bindActionButtons();
            };
        });
    </script>
<!-- UNIFIED PLAYER PICKER MODAL -->
<div id="universal-picker-modal" class="hidden fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl animate-pop">
        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
            <h2 id="picker-title" class="text-xl font-black text-white uppercase tracking-widest">Wybierz Gracza</h2>
            <div class="flex gap-2">
                 <button id="picker-add-btn" class="action-icon-btn bg-green-600 hover:bg-green-500 text-white" title="Dodaj nowego gracza">
                    <span class="text-xl font-bold">+</span>
                 </button>
                 <button id="picker-delete-mode-btn" class="action-icon-btn bg-gray-800 hover:bg-red-900/50 text-gray-400 hover:text-red-400 border border-gray-700" title="Tryb usuwania">
                    <span>üóë</span>
                 </button>
                 <button onclick="document.getElementById('universal-picker-modal').classList.add('hidden');" class="action-icon-btn bg-gray-800 hover:bg-gray-700 text-gray-400 text-xl font-bold ml-2">
                    &times;
                 </button>
            </div>
        </div>

        <!-- Add Player Input (Hidden by default) -->
        <div id="picker-add-row" class="hidden mb-4 bg-gray-800 p-3 rounded-lg border border-green-500/30">
            <div class="flex gap-2">
                <input type="text" id="picker-new-name" placeholder="Nazwa nowego gracza..." class="bg-gray-900 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 focus:ring-green-500 focus:border-green-500">
                <button id="picker-confirm-add" class="bg-green-600 text-white px-4 rounded-lg font-bold text-sm hover:bg-green-500">OK</button>
            </div>
        </div>
<p id="picker-info-text" class="text-[10px] text-gray-500 uppercase font-bold mb-2 px-1"></p>
        <div id="picker-grid-container" class="picker-grid overflow-y-auto flex-grow pr-2">
            <!-- Tiles injected via JS -->
        </div>

        <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
             <button id="picker-done-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl font-bold text-sm uppercase">Gotowe</button>
        </div>
    </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="delete-confirm-modal" class="hidden fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4">
    <div class="bg-gray-800 border border-red-500/50 p-6 rounded-2xl w-full max-w-sm text-center animate-pop">
        <h3 class="text-xl font-bold text-red-500 mb-2">Usuwanie Gracza</h3>
        <p class="text-white mb-4">Czy chcesz usunƒÖƒá gracza <span id="del-player-name" class="font-bold text-yellow-400"></span>?</p>
        
        <div class="flex flex-col gap-3">
            <button id="del-btn-keep-stats" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg text-sm font-bold border border-gray-500">
                Usu≈Ñ z listy, ale ZACHOWAJ statystyki
                <span class="block text-[10px] text-gray-400 font-normal mt-1">Gracz zniknie z wyboru, ale historia mecz√≥w pozostanie.</span>
            </button>
            <button id="del-btn-wipe-stats" class="bg-red-900/50 hover:bg-red-800 text-red-200 p-3 rounded-lg text-sm font-bold border border-red-700">
                Usu≈Ñ gracza ORAZ jego statystyki
                <span class="block text-[10px] text-red-300/70 font-normal mt-1">Wymazuje indywidualne rekordy (duety zostanƒÖ).</span>
            </button>
            <button onclick="document.getElementById('delete-confirm-modal').classList.add('hidden');" class="text-gray-500 hover:text-white text-xs underline mt-2">Anuluj</button>
        </div>
    </div>
</div>
<!-- SIDEBAR -->
<div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-[15000] hidden opacity-0 transition-opacity duration-300" onclick="window.Sidebar.close()"></div>
<div id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-gray-900 z-[16000] border-r border-white/10 shadow-2xl transform -translate-x-full transition-transform duration-300 flex flex-col">
    <div class="p-6 border-b border-white/10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center font-black text-black">M</div>
            <div>
                <div class="text-sm font-black uppercase text-white truncate w-40" id="sb-user-email">manager@ea.fc</div>
                <div class="text-[10px] text-green-500 font-bold uppercase" id="sb-user-status">Zweryfikowany</div>
            </div>
        </div>
    </div>

    <div class="flex-grow p-4 space-y-2 overflow-y-auto">
        <button onclick="window.Sidebar.close(); Stats.init(); document.getElementById('stats-modal').classList.remove('hidden');" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-gray-300 font-bold text-sm transition-colors">
            <span>üìä</span> Statystyki Og√≥lne
        </button>
        <button onclick="window.Sidebar.openProfile()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-gray-300 font-bold text-sm transition-colors">
            <span>üë§</span> Profil Managera
        </button>
        <button onclick="window.DataManager.resetSession(); window.Sidebar.close();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-blue-400 font-bold text-sm transition-colors">
            <span>üîÑ</span> Nowa Sesja (Reset)
        </button>
    </div>

    <div class="p-4 border-t border-white/10">
        <button onclick="window.AuthManager.logout()" class="w-full p-3 rounded-xl bg-red-900/20 text-red-400 font-bold text-xs uppercase tracking-widest hover:bg-red-900/40 transition-all">
            Wyloguj siƒô
        </button>
    </div>
</div>
</body>
</html>